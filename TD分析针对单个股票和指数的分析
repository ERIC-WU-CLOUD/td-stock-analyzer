import tushare as ts
import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import time
import warnings
import webbrowser
import os

# åœ¨æ‰€æœ‰matplotlibå¯¼å…¥ä¹‹å‰æ·»åŠ è¿™äº›è¡Œ
import matplotlib

matplotlib.use('Agg')  # ä½¿ç”¨éäº¤äº’å¼åç«¯ï¼Œé¿å…tkinterå†²çª

import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from matplotlib.patches import Rectangle
import matplotlib.font_manager as fm
from scipy.signal import argrelextrema
from concurrent.futures import ThreadPoolExecutor, as_completed
from functools import lru_cache
import threading

warnings.filterwarnings('ignore')

# è®¾ç½®matplotlibä¸­æ–‡å­—ä½“å’Œæ ·å¼
plt.rcParams['font.sans-serif'] = ['SimHei', 'DejaVu Sans', 'Arial Unicode MS', 'Helvetica']
plt.rcParams['axes.unicode_minus'] = False
plt.rcParams['figure.facecolor'] = 'white'
plt.rcParams['axes.facecolor'] = 'white'

# è®¾ç½®tushare token
TOKEN = '093ec10aeb924a25cf1b81915f855e8240629e5bb69597697face485'
ts.set_token(TOKEN)
pro = ts.pro_api(TOKEN)

# çº¿ç¨‹é”ç”¨äºAPIè°ƒç”¨
api_lock = threading.Lock()


def check_trade_date(date_str):
    """æ£€æŸ¥è¾“å…¥çš„æ—¥æœŸæ˜¯å¦ä¸ºäº¤æ˜“æ—¥"""
    with api_lock:
        trade_cal = pro.trade_cal(exchange='SSE', start_date=date_str, end_date=date_str)
    if len(trade_cal) > 0 and trade_cal.iloc[0]['is_open'] == 1:
        return True
    return False


@lru_cache(maxsize=32)
def get_latest_trade_date():
    """è·å–æœ€è¿‘çš„äº¤æ˜“æ—¥ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
    today = datetime.now().strftime('%Y%m%d')
    with api_lock:
        trade_cal = pro.trade_cal(exchange='SSE', end_date=today, is_open=1)
    trade_cal = trade_cal.sort_values('cal_date', ascending=False)
    return trade_cal.iloc[0]['cal_date']


def get_previous_trade_date(date_str):
    """è·å–æŒ‡å®šæ—¥æœŸçš„å‰ä¸€ä¸ªäº¤æ˜“æ—¥"""
    with api_lock:
        trade_cal = pro.trade_cal(exchange='SSE', end_date=date_str, is_open=1)
    trade_cal = trade_cal.sort_values('cal_date', ascending=False)
    if len(trade_cal) >= 2:
        return trade_cal.iloc[1]['cal_date']
    return None


def get_next_60_trade_dates(start_date):
    """è·å–æŒ‡å®šæ—¥æœŸä¹‹åçš„60ä¸ªäº¤æ˜“æ—¥"""
    try:
        # è®¡ç®—ä¸€ä¸ªè¶³å¤Ÿå¤§çš„ç»“æŸæ—¥æœŸï¼ˆå¤§çº¦3ä¸ªæœˆåï¼‰
        start_dt = pd.to_datetime(start_date)
        end_dt = start_dt + timedelta(days=120)  # é¢„ç•™è¶³å¤Ÿçš„å¤©æ•°
        end_date = end_dt.strftime('%Y%m%d')

        # è·å–äº¤æ˜“æ—¥å†
        with api_lock:
            trade_cal = pro.trade_cal(exchange='SSE', start_date=start_date, end_date=end_date, is_open=1)
        trade_cal = trade_cal.sort_values('cal_date', ascending=True)

        # æ’é™¤èµ·å§‹æ—¥æœŸï¼Œå–åé¢çš„60ä¸ªäº¤æ˜“æ—¥
        future_dates = trade_cal[trade_cal['cal_date'] > start_date]

        if len(future_dates) >= 60:
            return future_dates.head(60)['cal_date'].tolist()
        else:
            return future_dates['cal_date'].tolist()
    except Exception as e:
        print(f"è·å–60ä¸ªäº¤æ˜“æ—¥å‡ºé”™: {e}")
        return []


def calculate_max_profit_after_target_date(stock_code, target_date):
    """
    è®¡ç®—ç›®æ ‡æ—¥æœŸä¹‹å60ä¸ªäº¤æ˜“æ—¥å†…çš„æœ€å¤§ç›ˆåˆ©ç™¾åˆ†æ¯”å’Œå¤©æ•°
    ä½¿ç”¨å‰å¤æƒæ•°æ®è®¡ç®—
    """
    try:
        # è·å–ç›®æ ‡æ—¥æœŸä¹‹åçš„60ä¸ªäº¤æ˜“æ—¥
        future_trade_dates = get_next_60_trade_dates(target_date)

        if not future_trade_dates:
            return {'max_profit_pct': 0, 'max_profit_days': 0, 'status': 'æ— æœªæ¥æ•°æ®'}

        # è·å–ç›®æ ‡æ—¥æœŸçš„å‰å¤æƒæ”¶ç›˜ä»·
        try:
            with api_lock:
                target_data = pro.stk_factor_pro(**{
                    "ts_code": stock_code,
                    "start_date": target_date,
                    "end_date": target_date,
                    "trade_date": "",
                    "limit": "",
                    "offset": ""
                }, fields=["ts_code", "trade_date", "close_qfq"])

            if len(target_data) == 0:
                # å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨æ™®é€šæ¥å£
                with api_lock:
                    target_data = pro.daily(ts_code=stock_code, start_date=target_date, end_date=target_date)
                target_data['close_qfq'] = target_data['close']  # ç®€åŒ–å¤„ç†
        except:
            # å¤‡ç”¨æ–¹æ¡ˆ
            with api_lock:
                target_data = pro.daily(ts_code=stock_code, start_date=target_date, end_date=target_date)
            target_data['close_qfq'] = target_data['close']

        if len(target_data) == 0:
            return {'max_profit_pct': 0, 'max_profit_days': 0, 'status': 'ç›®æ ‡æ—¥æœŸæ— æ•°æ®'}

        target_close_price = target_data.iloc[0]['close_qfq']

        # è·å–60ä¸ªäº¤æ˜“æ—¥çš„æ•°æ®
        start_future_date = future_trade_dates[0]
        end_future_date = future_trade_dates[-1]

        try:
            with api_lock:
                future_data = pro.stk_factor_pro(**{
                    "ts_code": stock_code,
                    "start_date": start_future_date,
                    "end_date": end_future_date,
                    "trade_date": "",
                    "limit": "",
                    "offset": ""
                }, fields=["ts_code", "trade_date", "high_qfq", "close_qfq"])

            if len(future_data) == 0:
                # å¤‡ç”¨æ–¹æ¡ˆ
                with api_lock:
                    future_data = pro.daily(ts_code=stock_code, start_date=start_future_date, end_date=end_future_date)
                future_data['high_qfq'] = future_data['high']
                future_data['close_qfq'] = future_data['close']
        except:
            # å¤‡ç”¨æ–¹æ¡ˆ
            with api_lock:
                future_data = pro.daily(ts_code=stock_code, start_date=start_future_date, end_date=end_future_date)
            future_data['high_qfq'] = future_data['high']
            future_data['close_qfq'] = future_data['close']

        if len(future_data) == 0:
            return {'max_profit_pct': 0, 'max_profit_days': 0, 'status': 'æœªæ¥æœŸé—´æ— æ•°æ®'}

        # æŒ‰æ—¥æœŸæ’åº
        future_data = future_data.sort_values('trade_date')

        # è®¡ç®—æ¯æ—¥çš„æœ€å¤§ç›ˆåˆ©
        max_profit_pct = 0
        max_profit_days = 0

        for idx, row in future_data.iterrows():
            # ä½¿ç”¨å½“æ—¥æœ€é«˜ä»·è®¡ç®—ç›ˆåˆ©
            current_profit = (row['high_qfq'] - target_close_price) / target_close_price * 100

            if current_profit > max_profit_pct:
                max_profit_pct = current_profit
                # è®¡ç®—æ˜¯ç¬¬å‡ ä¸ªäº¤æ˜“æ—¥ï¼ˆä»1å¼€å§‹ï¼‰
                current_date = row['trade_date']
                if current_date in future_trade_dates:
                    max_profit_days = future_trade_dates.index(current_date) + 1

        return {
            'max_profit_pct': round(max_profit_pct, 2),
            'max_profit_days': max_profit_days,
            'status': 'success',
            'actual_days_count': len(future_data)
        }

    except Exception as e:
        print(f"è®¡ç®— {stock_code} æœ€å¤§ç›ˆåˆ©æ—¶å‡ºé”™: {e}")
        return {'max_profit_pct': 0, 'max_profit_days': 0, 'status': f'è®¡ç®—å‡ºé”™: {str(e)}'}


# æƒ…ç»ªåˆ†æéƒ¨åˆ†
# ä¼˜åŒ–åçš„æƒ…ç»ªåˆ†æéƒ¨åˆ†
def calculate_emotion_analysis(hist_data):
    """
    ä¸“ä¸šæƒ…ç»ªåˆ†æ - åŸºäºå‰å¤æƒæ•°æ® (ä¼˜åŒ–ç‰ˆæœ¬)
    ç»¼åˆå¤šä¸ªæƒ…ç»ªæŒ‡æ ‡ï¼šRSIã€CCIã€KDJã€MACDã€PSYã€VRç­‰
    ä¼˜åŒ–å†…å®¹ï¼š
    1. æ·»åŠ å¾—åˆ†èŒƒå›´é™åˆ¶
    2. ä¼˜åŒ–æƒé‡åˆ†é…
    3. å¢åŠ è¶‹åŠ¿åˆ†æ
    4. æ”¹è¿›æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
    """
    df = hist_data.copy().sort_values('trade_date')

    if len(df) < 20:
        return {
            'emotion_score': 50,  # ä¸­æ€§
            'emotion_level': 'ä¸­æ€§',
            'rsi_emotion': 'æ•°æ®ä¸è¶³',
            'cci_emotion': 'æ•°æ®ä¸è¶³',
            'kdj_emotion': 'æ•°æ®ä¸è¶³',
            'macd_emotion': 'æ•°æ®ä¸è¶³',
            'psy_emotion': 'æ•°æ®ä¸è¶³',
            'vr_emotion': 'æ•°æ®ä¸è¶³',
            'obv_emotion': 'æ•°æ®ä¸è¶³',
            'mfi_emotion': 'æ•°æ®ä¸è¶³',
            'emotion_analysis': 'å†å²æ•°æ®ä¸è¶³ï¼Œæ— æ³•è¿›è¡Œæœ‰æ•ˆçš„æƒ…ç»ªåˆ†æ',
            'emotion_signals': [],
            'emotion_warnings': [],
            'emotion_opportunities': [],
            'data_completeness': 0,
            'trend_analysis': {}
        }

    latest = df.iloc[-1]
    recent_5 = df.tail(5)
    recent_10 = df.tail(10)

    # ä¼˜åŒ–åçš„æƒé‡é…ç½® - ç¡®ä¿æ€»æƒé‡åœ¨Â±45åˆ†ä»¥å†…
    EMOTION_WEIGHTS = {
        'RSI': {'positive': 10, 'negative': 10},  # æ ¸å¿ƒæŒ‡æ ‡ï¼Œæƒé‡æœ€é«˜
        'CCI': {'positive': 6, 'negative': 6},  # é™ä½æƒé‡ï¼Œé¿å…ä¸RSIé‡å 
        'KDJ': {'positive': 5, 'negative': 5},  # çŸ­æœŸæŒ‡æ ‡
        'MACD': {'positive': 6, 'negative': 6},  # è¶‹åŠ¿æŒ‡æ ‡
        'PSY': {'positive': 4, 'negative': 4},  # å¿ƒç†æŒ‡æ ‡
        'VR': {'positive': 3, 'negative': 3},  # æˆäº¤é‡æŒ‡æ ‡
        'OBV': {'positive': 5, 'negative': 5},  # èµ„é‡‘æµå‘
        'MFI': {'positive': 3, 'negative': 3},  # èµ„é‡‘æµé‡
        'VOLUME': {'positive': 3, 'negative': 3}  # æ–°å¢ï¼šæˆäº¤é‡ç¡®è®¤
    }
    # æ€»æƒé‡ï¼š45åˆ†ï¼Œç¡®ä¿åŸºç¡€åˆ†50Â±45 = 5-95åˆ†

    # ä¼˜åŒ–åçš„é˜ˆå€¼é…ç½®
    INDICATOR_THRESHOLDS = {
        'RSI': {'extreme_high': 85, 'high': 70, 'low': 30, 'extreme_low': 15},
        'CCI': {'extreme_high': 200, 'high': 100, 'low': -100, 'extreme_low': -200},
        'KDJ': {'high': 80, 'low': 20},
        'PSY': {'extreme_high': 80, 'high': 65, 'low': 35, 'extreme_low': 20},
        'VR': {'extreme_high': 350, 'high': 200, 'low': 80, 'extreme_low': 50},
        'MFI': {'high': 80, 'low': 20}
    }

    # æƒ…ç»ªå¾—åˆ†ç´¯ç§¯å™¨
    emotion_score = 50  # åŸºç¡€åˆ†æ•°ï¼ˆä¸­æ€§ï¼‰
    emotion_signals = []
    emotion_warnings = []
    emotion_opportunities = []
    trend_analysis = {}

    # æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
    def check_data_availability(indicator_name, value):
        """æ£€æŸ¥æŒ‡æ ‡æ•°æ®å¯ç”¨æ€§"""
        if pd.isna(value) or value == 0:
            return False, f"{indicator_name}æ•°æ®ç¼ºå¤±"
        return True, ""

    def analyze_indicator_trend(values, indicator_name, periods=3):
        """åˆ†ææŒ‡æ ‡è¶‹åŠ¿"""
        if len(values) < periods:
            return 'insufficient_data', 0

        recent_values = values.tail(periods)
        if recent_values.isna().any():
            return 'data_missing', 0

        trend_strength = (recent_values.iloc[-1] - recent_values.iloc[0]) / recent_values.iloc[0] * 100

        if abs(trend_strength) < 2:
            return 'stable', trend_strength
        elif trend_strength > 5:
            return 'strong_rising', trend_strength
        elif trend_strength > 0:
            return 'rising', trend_strength
        elif trend_strength < -5:
            return 'strong_falling', trend_strength
        else:
            return 'falling', trend_strength

    def apply_emotion_impact(base_score, impact_type, weight_config):
        """åº”ç”¨æƒ…ç»ªå½±å“ï¼Œç¡®ä¿å¾—åˆ†åœ¨åˆç†èŒƒå›´"""
        if impact_type == 'positive':
            return base_score + weight_config['positive']
        elif impact_type == 'negative':
            return base_score - weight_config['negative']
        return base_score

    # 1. RSIæƒ…ç»ªåˆ†æï¼ˆä½¿ç”¨å‰å¤æƒæ•°æ®ï¼‰ - ä¼˜åŒ–ç‰ˆ
    rsi_values = {
        'rsi_6': latest.get('rsi_qfq_6', 50),
        'rsi_12': latest.get('rsi_qfq_12', 50),
        'rsi_24': latest.get('rsi_qfq_24', 50)
    }

    # RSIæ•°æ®å¯ç”¨æ€§æ£€æŸ¥
    valid_rsi = [v for v in rsi_values.values() if pd.notna(v) and v != 0]
    if valid_rsi:
        rsi_avg = sum(valid_rsi) / len(valid_rsi)

        # RSIè¶‹åŠ¿åˆ†æ
        if 'rsi_qfq_12' in df.columns:
            rsi_trend, rsi_trend_strength = analyze_indicator_trend(df['rsi_qfq_12'], 'RSI', 5)
            trend_analysis['RSI'] = {'trend': rsi_trend, 'strength': rsi_trend_strength}

        # RSIæƒ…ç»ªåˆ¤æ–­ - ä½¿ç”¨ä¼˜åŒ–é˜ˆå€¼
        if rsi_avg > INDICATOR_THRESHOLDS['RSI']['extreme_high']:
            rsi_emotion = "æåº¦è´ªå©ª"
            emotion_score = apply_emotion_impact(emotion_score, 'negative', EMOTION_WEIGHTS['RSI'])
            emotion_warnings.append(f"RSIæ˜¾ç¤ºæåº¦è´ªå©ª({rsi_avg:.1f})ï¼Œå¸‚åœºå¯èƒ½è¿‡çƒ­")
        elif rsi_avg > INDICATOR_THRESHOLDS['RSI']['high']:
            rsi_emotion = "è´ªå©ª"
            emotion_score = apply_emotion_impact(emotion_score, 'negative', {'positive': 6, 'negative': 6})
            emotion_warnings.append(f"RSIæ˜¾ç¤ºè´ªå©ªæƒ…ç»ª({rsi_avg:.1f})ï¼Œæ³¨æ„é£é™©")
        elif rsi_avg < INDICATOR_THRESHOLDS['RSI']['extreme_low']:
            rsi_emotion = "æåº¦ææ…Œ"
            emotion_score = apply_emotion_impact(emotion_score, 'positive', EMOTION_WEIGHTS['RSI'])
            emotion_opportunities.append(f"RSIæ˜¾ç¤ºæåº¦ææ…Œ({rsi_avg:.1f})ï¼Œå¯èƒ½å­˜åœ¨è¶…è·Œæœºä¼š")
        elif rsi_avg < INDICATOR_THRESHOLDS['RSI']['low']:
            rsi_emotion = "ææ…Œ"
            emotion_score = apply_emotion_impact(emotion_score, 'positive', {'positive': 6, 'negative': 6})
            emotion_opportunities.append(f"RSIæ˜¾ç¤ºææ…Œæƒ…ç»ª({rsi_avg:.1f})ï¼Œå…³æ³¨åå¼¹æœºä¼š")
        else:
            rsi_emotion = "å¹³è¡¡"
            emotion_signals.append(f"RSIå¤„äºå¹³è¡¡åŒºé—´({rsi_avg:.1f})ï¼Œæƒ…ç»ªç›¸å¯¹ç¨³å®š")
    else:
        rsi_emotion = "æ•°æ®ç¼ºå¤±"

    # 2. CCIæƒ…ç»ªåˆ†æï¼ˆé¡ºåŠ¿æŒ‡æ ‡ï¼‰ - ä¼˜åŒ–ç‰ˆ
    cci = latest.get('cci_qfq', 0)
    cci_available, cci_error = check_data_availability('CCI', cci)

    if cci_available:
        # CCIè¶‹åŠ¿åˆ†æ
        if 'cci_qfq' in df.columns:
            cci_trend, cci_trend_strength = analyze_indicator_trend(df['cci_qfq'], 'CCI', 5)
            trend_analysis['CCI'] = {'trend': cci_trend, 'strength': cci_trend_strength}

        if cci > INDICATOR_THRESHOLDS['CCI']['extreme_high']:
            cci_emotion = "å¼ºçƒˆçœ‹å¤š"
            emotion_score = apply_emotion_impact(emotion_score, 'positive', EMOTION_WEIGHTS['CCI'])
            emotion_signals.append(f"CCIæ˜¾ç¤ºå¼ºçƒˆçœ‹å¤šæƒ…ç»ª({cci:.1f})")
        elif cci > INDICATOR_THRESHOLDS['CCI']['high']:
            cci_emotion = "åå¤š"
            emotion_score = apply_emotion_impact(emotion_score, 'positive', {'positive': 3, 'negative': 3})
            emotion_signals.append(f"CCIæ˜¾ç¤ºåå¤šæƒ…ç»ª({cci:.1f})")
        elif cci < INDICATOR_THRESHOLDS['CCI']['extreme_low']:
            cci_emotion = "å¼ºçƒˆçœ‹ç©º"
            emotion_score = apply_emotion_impact(emotion_score, 'negative', EMOTION_WEIGHTS['CCI'])
            emotion_warnings.append(f"CCIæ˜¾ç¤ºå¼ºçƒˆçœ‹ç©ºæƒ…ç»ª({cci:.1f})")
        elif cci < INDICATOR_THRESHOLDS['CCI']['low']:
            cci_emotion = "åç©º"
            emotion_score = apply_emotion_impact(emotion_score, 'negative', {'positive': 3, 'negative': 3})
            emotion_warnings.append(f"CCIæ˜¾ç¤ºåç©ºæƒ…ç»ª({cci:.1f})")
        else:
            cci_emotion = "ä¸­æ€§"
            emotion_signals.append(f"CCIæ˜¾ç¤ºä¸­æ€§æƒ…ç»ª({cci:.1f})")
    else:
        cci_emotion = cci_error

    # 3. KDJæƒ…ç»ªåˆ†æ - ä¼˜åŒ–ç‰ˆ
    kdj_k = latest.get('kdj_k_qfq', 50)
    kdj_d = latest.get('kdj_d_qfq', 50)
    kdj_j = latest.get('kdj_qfq', 50)

    kdj_values = [v for v in [kdj_k, kdj_d, kdj_j] if pd.notna(v)]
    if kdj_values:
        kdj_avg = sum(kdj_values) / len(kdj_values)

        # KDJè¶‹åŠ¿åˆ†æ
        if 'kdj_k_qfq' in df.columns:
            kdj_trend, kdj_trend_strength = analyze_indicator_trend(df['kdj_k_qfq'], 'KDJ', 3)
            trend_analysis['KDJ'] = {'trend': kdj_trend, 'strength': kdj_trend_strength}

        if kdj_avg > INDICATOR_THRESHOLDS['KDJ']['high']:
            kdj_emotion = "è¶…ä¹°"
            emotion_score = apply_emotion_impact(emotion_score, 'negative', EMOTION_WEIGHTS['KDJ'])
            emotion_warnings.append(f"KDJæ˜¾ç¤ºè¶…ä¹°çŠ¶æ€({kdj_avg:.1f})ï¼Œæ³¨æ„å›è°ƒé£é™©")
        elif kdj_avg < INDICATOR_THRESHOLDS['KDJ']['low']:
            kdj_emotion = "è¶…å–"
            emotion_score = apply_emotion_impact(emotion_score, 'positive', EMOTION_WEIGHTS['KDJ'])
            emotion_opportunities.append(f"KDJæ˜¾ç¤ºè¶…å–çŠ¶æ€({kdj_avg:.1f})ï¼Œå…³æ³¨åå¼¹æœºä¼š")
        else:
            kdj_emotion = "æ­£å¸¸"
            emotion_signals.append(f"KDJå¤„äºæ­£å¸¸åŒºé—´({kdj_avg:.1f})")
    else:
        kdj_emotion = "æ•°æ®ç¼ºå¤±"

    # 4. MACDæƒ…ç»ªåˆ†æ - ä¼˜åŒ–ç‰ˆ
    macd_dif = latest.get('macd_dif_qfq', 0)
    macd_dea = latest.get('macd_dea_qfq', 0)
    macd_hist = latest.get('macd_qfq', 0)

    if all(pd.notna([macd_dif, macd_dea, macd_hist])):
        # MACDè¶‹åŠ¿åˆ†æ
        if 'macd_qfq' in df.columns:
            macd_trend, macd_trend_strength = analyze_indicator_trend(df['macd_qfq'], 'MACD', 5)
            trend_analysis['MACD'] = {'trend': macd_trend, 'strength': macd_trend_strength}

        # ç»“åˆé‡‘å‰æ­»å‰å’ŒæŸ±çŠ¶å›¾åˆ†æ
        if macd_dif > macd_dea and macd_hist > 0:
            macd_emotion = "ç§¯æ"
            emotion_score = apply_emotion_impact(emotion_score, 'positive', EMOTION_WEIGHTS['MACD'])
            emotion_signals.append(f"MACDæ˜¾ç¤ºç§¯ææƒ…ç»ªï¼Œè¶‹åŠ¿å‘å¥½")
        elif macd_dif < macd_dea and macd_hist < 0:
            macd_emotion = "æ¶ˆæ"
            emotion_score = apply_emotion_impact(emotion_score, 'negative', EMOTION_WEIGHTS['MACD'])
            emotion_warnings.append(f"MACDæ˜¾ç¤ºæ¶ˆææƒ…ç»ªï¼Œè¶‹åŠ¿åå¼±")
        else:
            macd_emotion = "è½¬æ¢ä¸­"
            emotion_signals.append(f"MACDæ˜¾ç¤ºæƒ…ç»ªè½¬æ¢ä¸­")
    else:
        macd_emotion = "æ•°æ®ç¼ºå¤±"

    # 5. PSYå¿ƒç†çº¿åˆ†æ - ä¼˜åŒ–ç‰ˆ
    psy = latest.get('psy_qfq', 50)
    psy_available, psy_error = check_data_availability('PSY', psy)

    if psy_available:
        if psy > INDICATOR_THRESHOLDS['PSY']['extreme_high']:
            psy_emotion = "æåº¦ä¹è§‚"
            emotion_score = apply_emotion_impact(emotion_score, 'negative', EMOTION_WEIGHTS['PSY'])
            emotion_warnings.append(f"PSYæ˜¾ç¤ºæåº¦ä¹è§‚({psy:.1f})ï¼Œå¸‚åœºå¯èƒ½è¿‡çƒ­")
        elif psy > INDICATOR_THRESHOLDS['PSY']['high']:
            psy_emotion = "åä¹è§‚"
            emotion_score = apply_emotion_impact(emotion_score, 'negative', {'positive': 2, 'negative': 2})
            emotion_warnings.append(f"PSYæ˜¾ç¤ºåä¹è§‚({psy:.1f})ï¼Œæ³¨æ„é£é™©")
        elif psy < INDICATOR_THRESHOLDS['PSY']['extreme_low']:
            psy_emotion = "æåº¦æ‚²è§‚"
            emotion_score = apply_emotion_impact(emotion_score, 'positive', EMOTION_WEIGHTS['PSY'])
            emotion_opportunities.append(f"PSYæ˜¾ç¤ºæåº¦æ‚²è§‚({psy:.1f})ï¼Œå¯èƒ½å­˜åœ¨æœºä¼š")
        elif psy < INDICATOR_THRESHOLDS['PSY']['low']:
            psy_emotion = "åæ‚²è§‚"
            emotion_score = apply_emotion_impact(emotion_score, 'positive', {'positive': 2, 'negative': 2})
            emotion_opportunities.append(f"PSYæ˜¾ç¤ºåæ‚²è§‚({psy:.1f})ï¼Œå…³æ³¨åå¼¹")
        else:
            psy_emotion = "ç†æ€§"
            emotion_signals.append(f"PSYæ˜¾ç¤ºç†æ€§æƒ…ç»ª({psy:.1f})")
    else:
        psy_emotion = psy_error

    # 6. VRæˆäº¤é‡æ¯”ç‡åˆ†æ - ä¼˜åŒ–ç‰ˆ
    vr = latest.get('vr_qfq', 100)
    vr_available, vr_error = check_data_availability('VR', vr)

    if vr_available:
        if vr > INDICATOR_THRESHOLDS['VR']['extreme_high']:
            vr_emotion = "è¿‡åº¦æ´»è·ƒ"
            emotion_score = apply_emotion_impact(emotion_score, 'negative', EMOTION_WEIGHTS['VR'])
            emotion_warnings.append(f"VRæ˜¾ç¤ºæˆäº¤è¿‡åº¦æ´»è·ƒ({vr:.1f})ï¼Œæ³¨æ„é£é™©")
        elif vr > INDICATOR_THRESHOLDS['VR']['high']:
            vr_emotion = "è¾ƒæ´»è·ƒ"
            emotion_score = apply_emotion_impact(emotion_score, 'negative', {'positive': 1, 'negative': 1})
            emotion_signals.append(f"VRæ˜¾ç¤ºæˆäº¤è¾ƒæ´»è·ƒ({vr:.1f})")
        elif vr < INDICATOR_THRESHOLDS['VR']['extreme_low']:
            vr_emotion = "è¿‡åº¦ä½è¿·"
            emotion_score = apply_emotion_impact(emotion_score, 'positive', EMOTION_WEIGHTS['VR'])
            emotion_opportunities.append(f"VRæ˜¾ç¤ºæˆäº¤ä½è¿·({vr:.1f})ï¼Œå¯èƒ½é…é…¿æœºä¼š")
        elif vr < INDICATOR_THRESHOLDS['VR']['low']:
            vr_emotion = "åä½è¿·"
            emotion_score = apply_emotion_impact(emotion_score, 'positive', {'positive': 1, 'negative': 1})
            emotion_opportunities.append(f"VRæ˜¾ç¤ºæˆäº¤åä½è¿·({vr:.1f})")
        else:
            vr_emotion = "æ­£å¸¸"
            emotion_signals.append(f"VRæ˜¾ç¤ºæˆäº¤é‡æ­£å¸¸({vr:.1f})")
    else:
        vr_emotion = vr_error

    # 7. OBVèƒ½é‡æ½®åˆ†æ - ä¼˜åŒ–ç‰ˆ
    if len(df) >= 2:
        obv_current = latest.get('obv_qfq', 0)
        obv_previous = df.iloc[-2].get('obv_qfq', 0)

        if pd.notna(obv_current) and pd.notna(obv_previous) and obv_previous != 0:
            obv_change = (obv_current - obv_previous) / abs(obv_previous) * 100

            # OBVè¶‹åŠ¿åˆ†æ
            if 'obv_qfq' in df.columns:
                obv_trend, obv_trend_strength = analyze_indicator_trend(df['obv_qfq'], 'OBV', 5)
                trend_analysis['OBV'] = {'trend': obv_trend, 'strength': obv_trend_strength}

            if obv_change > 15:
                obv_emotion = "èµ„é‡‘å¤§å¹…æµå…¥"
                emotion_score = apply_emotion_impact(emotion_score, 'positive', EMOTION_WEIGHTS['OBV'])
                emotion_signals.append(f"OBVæ˜¾ç¤ºèµ„é‡‘å¤§å¹…æµå…¥({obv_change:.1f}%)")
            elif obv_change > 5:
                obv_emotion = "èµ„é‡‘æµå…¥ç§¯æ"
                emotion_score = apply_emotion_impact(emotion_score, 'positive', {'positive': 3, 'negative': 3})
                emotion_signals.append(f"OBVæ˜¾ç¤ºèµ„é‡‘æµå…¥ç§¯æ({obv_change:.1f}%)")
            elif obv_change < -15:
                obv_emotion = "èµ„é‡‘å¤§å¹…æµå‡º"
                emotion_score = apply_emotion_impact(emotion_score, 'negative', EMOTION_WEIGHTS['OBV'])
                emotion_warnings.append(f"OBVæ˜¾ç¤ºèµ„é‡‘å¤§å¹…æµå‡º({obv_change:.1f}%)")
            elif obv_change < -5:
                obv_emotion = "èµ„é‡‘æµå‡ºæ˜æ˜¾"
                emotion_score = apply_emotion_impact(emotion_score, 'negative', {'positive': 3, 'negative': 3})
                emotion_warnings.append(f"OBVæ˜¾ç¤ºèµ„é‡‘æµå‡ºæ˜æ˜¾({obv_change:.1f}%)")
            else:
                obv_emotion = "èµ„é‡‘æµåŠ¨å¹³ç¨³"
                emotion_signals.append(f"OBVæ˜¾ç¤ºèµ„é‡‘æµåŠ¨å¹³ç¨³({obv_change:.1f}%)")
        else:
            obv_emotion = "æ•°æ®ç¼ºå¤±"
    else:
        obv_emotion = "æ•°æ®ä¸è¶³"

    # 8. MFIèµ„é‡‘æµé‡æŒ‡æ ‡åˆ†æ - ä¼˜åŒ–ç‰ˆ
    mfi = latest.get('mfi_qfq', 50)
    mfi_available, mfi_error = check_data_availability('MFI', mfi)

    if mfi_available:
        if mfi > INDICATOR_THRESHOLDS['MFI']['high']:
            mfi_emotion = "èµ„é‡‘è¿‡åº¦æµå…¥"
            emotion_score = apply_emotion_impact(emotion_score, 'negative', EMOTION_WEIGHTS['MFI'])
            emotion_warnings.append(f"MFIæ˜¾ç¤ºèµ„é‡‘è¿‡åº¦æµå…¥({mfi:.1f})ï¼Œæ³¨æ„å›è°ƒ")
        elif mfi < INDICATOR_THRESHOLDS['MFI']['low']:
            mfi_emotion = "èµ„é‡‘ä¸¥é‡æµå‡º"
            emotion_score = apply_emotion_impact(emotion_score, 'positive', EMOTION_WEIGHTS['MFI'])
            emotion_opportunities.append(f"MFIæ˜¾ç¤ºèµ„é‡‘ä¸¥é‡æµå‡º({mfi:.1f})ï¼Œå…³æ³¨åº•éƒ¨")
        else:
            mfi_emotion = "èµ„é‡‘æµåŠ¨æ­£å¸¸"
            emotion_signals.append(f"MFIæ˜¾ç¤ºèµ„é‡‘æµåŠ¨æ­£å¸¸({mfi:.1f})")
    else:
        mfi_emotion = mfi_error

    # 9. æˆäº¤é‡ç¡®è®¤åˆ†æ - æ–°å¢
    if 'vol' in df.columns and len(df) >= 10:
        recent_vol = recent_10['vol'].mean()
        overall_vol = df['vol'].mean()
        volume_ratio = recent_vol / overall_vol if overall_vol > 0 else 1

        if volume_ratio > 2.0:
            emotion_score = apply_emotion_impact(emotion_score, 'positive', EMOTION_WEIGHTS['VOLUME'])
            emotion_signals.append(f"æˆäº¤é‡å¤§å¹…æ”¾å¤§({volume_ratio:.1f}å€)ï¼Œæƒ…ç»ªç¡®è®¤æœ‰æ•ˆ")
        elif volume_ratio > 1.5:
            emotion_score = apply_emotion_impact(emotion_score, 'positive', {'positive': 2, 'negative': 2})
            emotion_signals.append(f"æˆäº¤é‡æ˜æ˜¾æ”¾å¤§({volume_ratio:.1f}å€)ï¼Œæƒ…ç»ªæœ‰æ‰€ç¡®è®¤")
        elif volume_ratio < 0.7:
            emotion_score = apply_emotion_impact(emotion_score, 'negative', {'positive': 1, 'negative': 1})
            emotion_warnings.append(f"æˆäº¤é‡èç¼©({volume_ratio:.1f}å€)ï¼Œæƒ…ç»ªä¿¡å·åå¼±")

    # åº”ç”¨å¾—åˆ†èŒƒå›´é™åˆ¶ - å…³é”®ä¼˜åŒ–
    emotion_score = max(5, min(95, emotion_score))  # ä¸¥æ ¼é™åˆ¶åœ¨5-95èŒƒå›´

    # ç»¼åˆæƒ…ç»ªç­‰çº§è¯„å®š - ä¼˜åŒ–åé˜ˆå€¼
    if emotion_score >= 80:
        emotion_level = "æåº¦ä¹è§‚"
    elif emotion_score >= 68:
        emotion_level = "ä¹è§‚"
    elif emotion_score >= 58:
        emotion_level = "åä¹è§‚"
    elif emotion_score >= 42:
        emotion_level = "ä¸­æ€§"
    elif emotion_score >= 32:
        emotion_level = "åæ‚²è§‚"
    elif emotion_score >= 20:
        emotion_level = "æ‚²è§‚"
    else:
        emotion_level = "æåº¦æ‚²è§‚"

    # è®¡ç®—æ•°æ®å®Œæ•´æ€§
    total_indicators = 8
    available_indicators = sum([
        1 if valid_rsi else 0,
        1 if cci_available else 0,
        1 if kdj_values else 0,
        1 if all(pd.notna([macd_dif, macd_dea, macd_hist])) else 0,
        1 if psy_available else 0,
        1 if vr_available else 0,
        1 if obv_emotion != "æ•°æ®ç¼ºå¤±" and obv_emotion != "æ•°æ®ä¸è¶³" else 0,
        1 if mfi_available else 0
    ])
    data_completeness = available_indicators / total_indicators * 100

    # ç”Ÿæˆä¸“ä¸šæƒ…ç»ªåˆ†ææŠ¥å‘Š - å¢å¼ºç‰ˆ
    emotion_analysis = generate_enhanced_emotion_analysis_report(
        emotion_level, emotion_score, data_completeness, trend_analysis,
        rsi_emotion, cci_emotion, kdj_emotion, macd_emotion,
        psy_emotion, vr_emotion, obv_emotion, mfi_emotion,
        emotion_signals, emotion_warnings, emotion_opportunities
    )

    return {
        'emotion_score': emotion_score,
        'emotion_level': emotion_level,
        'rsi_emotion': rsi_emotion,
        'cci_emotion': cci_emotion,
        'kdj_emotion': kdj_emotion,
        'macd_emotion': macd_emotion,
        'psy_emotion': psy_emotion,
        'vr_emotion': vr_emotion,
        'obv_emotion': obv_emotion,
        'mfi_emotion': mfi_emotion,
        'emotion_analysis': emotion_analysis,
        'emotion_signals': emotion_signals,
        'emotion_warnings': emotion_warnings,
        'emotion_opportunities': emotion_opportunities,
        'data_completeness': data_completeness,
        'trend_analysis': trend_analysis
    }


def generate_enhanced_emotion_analysis_report(emotion_level, emotion_score, data_completeness, trend_analysis,
                                              rsi_emotion, cci_emotion, kdj_emotion, macd_emotion,
                                              psy_emotion, vr_emotion, obv_emotion, mfi_emotion,
                                              signals, warnings, opportunities):
    """ç”Ÿæˆå¢å¼ºç‰ˆä¸“ä¸šæƒ…ç»ªåˆ†ææŠ¥å‘Š"""

    report = f"ç»¼åˆæƒ…ç»ªè¯„çº§ï¼š{emotion_level}ï¼ˆ{emotion_score}åˆ†/100åˆ†ï¼‰\n"
    report += f"æ•°æ®å®Œæ•´æ€§ï¼š{data_completeness:.1f}% | æƒé‡ä¼˜åŒ–ï¼šå·²åº”ç”¨ | è¶‹åŠ¿åˆ†æï¼šå·²æ•´åˆ\n\n"

    report += "ğŸ“Š æƒ…ç»ªæŒ‡æ ‡è¯¦ç»†åˆ†æï¼š\n"
    report += f"â€¢ RSIæƒ…ç»ªçŠ¶æ€ï¼š{rsi_emotion}ï¼ˆåæ˜ å¸‚åœºè¶…ä¹°è¶…å–æƒ…ç»ªï¼‰\n"
    report += f"â€¢ CCIé¡ºåŠ¿æƒ…ç»ªï¼š{cci_emotion}ï¼ˆåæ˜ è¶‹åŠ¿è·Ÿéšæƒ…ç»ªï¼‰\n"
    report += f"â€¢ KDJéšæœºæƒ…ç»ªï¼š{kdj_emotion}ï¼ˆåæ˜ çŸ­æœŸæƒ…ç»ªæ³¢åŠ¨ï¼‰\n"
    report += f"â€¢ MACDè¶‹åŠ¿æƒ…ç»ªï¼š{macd_emotion}ï¼ˆåæ˜ ä¸­æœŸè¶‹åŠ¿æƒ…ç»ªï¼‰\n"
    report += f"â€¢ PSYå¿ƒç†æƒ…ç»ªï¼š{psy_emotion}ï¼ˆåæ˜ æŠ•èµ„è€…å¿ƒç†çŠ¶æ€ï¼‰\n"
    report += f"â€¢ VRæˆäº¤æƒ…ç»ªï¼š{vr_emotion}ï¼ˆåæ˜ æˆäº¤æ´»è·ƒåº¦æƒ…ç»ªï¼‰\n"
    report += f"â€¢ OBVèµ„é‡‘æƒ…ç»ªï¼š{obv_emotion}ï¼ˆåæ˜ èµ„é‡‘æµå‘æƒ…ç»ªï¼‰\n"
    report += f"â€¢ MFIèµ„é‡‘æµæƒ…ç»ªï¼š{mfi_emotion}ï¼ˆåæ˜ èµ„é‡‘æµé‡æƒ…ç»ªï¼‰\n\n"

    # è¶‹åŠ¿åˆ†ææŠ¥å‘Š
    if trend_analysis:
        report += "ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡è¶‹åŠ¿åˆ†æï¼š\n"
        for indicator, trend_info in trend_analysis.items():
            trend_desc = {
                'strong_rising': 'å¼ºåŠ²ä¸Šå‡',
                'rising': 'æ¸©å’Œä¸Šå‡',
                'stable': 'æ¨ªç›˜æ•´ç†',
                'falling': 'æ¸©å’Œä¸‹é™',
                'strong_falling': 'å¿«é€Ÿä¸‹é™',
                'insufficient_data': 'æ•°æ®ä¸è¶³',
                'data_missing': 'æ•°æ®ç¼ºå¤±'
            }.get(trend_info['trend'], trend_info['trend'])

            if trend_info['trend'] not in ['insufficient_data', 'data_missing']:
                report += f"â€¢ {indicator}è¶‹åŠ¿ï¼š{trend_desc}ï¼ˆ{trend_info['strength']:+.1f}%ï¼‰\n"
            else:
                report += f"â€¢ {indicator}è¶‹åŠ¿ï¼š{trend_desc}\n"
        report += "\n"

    if signals:
        report += "âœ… ç§¯æä¿¡å·ï¼š\n"
        for signal in signals:
            report += f"â€¢ {signal}\n"
        report += "\n"

    if warnings:
        report += "âš ï¸ é£é™©è­¦ç¤ºï¼š\n"
        for warning in warnings:
            report += f"â€¢ {warning}\n"
        report += "\n"

    if opportunities:
        report += "ğŸ¯ æœºä¼šæç¤ºï¼š\n"
        for opportunity in opportunities:
            report += f"â€¢ {opportunity}\n"
        report += "\n"

    # ä¼˜åŒ–åçš„æƒ…ç»ªå»ºè®®
    if emotion_score >= 75:
        report += "ğŸ’¡ æƒ…ç»ªå»ºè®®ï¼šå¸‚åœºæƒ…ç»ªè¿‡äºä¹è§‚ï¼Œå»ºè®®è·åˆ©äº†ç»“ï¼Œä¸¥æ ¼æ§åˆ¶ä»“ä½ã€‚\n"
    elif emotion_score >= 60:
        report += "ğŸ’¡ æƒ…ç»ªå»ºè®®ï¼šå¸‚åœºæƒ…ç»ªåå‘ä¹è§‚ï¼Œå¯é€‚åº¦å‚ä¸ï¼Œæ³¨æ„é£é™©æ§åˆ¶ã€‚\n"
    elif emotion_score >= 45:
        report += "ğŸ’¡ æƒ…ç»ªå»ºè®®ï¼šå¸‚åœºæƒ…ç»ªç›¸å¯¹å¹³è¡¡ï¼Œä¿æŒè°¨æ…è§‚æœ›ï¼Œç­‰å¾…æ˜ç¡®ä¿¡å·ã€‚\n"
    elif emotion_score >= 30:
        report += "ğŸ’¡ æƒ…ç»ªå»ºè®®ï¼šå¸‚åœºæƒ…ç»ªåå‘æ‚²è§‚ï¼Œå¯å…³æ³¨ä¼˜è´¨æ ‡çš„ï¼Œåˆ†æ‰¹å»ºä»“ã€‚\n"
    else:
        report += "ğŸ’¡ æƒ…ç»ªå»ºè®®ï¼šå¸‚åœºæƒ…ç»ªè¿‡åº¦æ‚²è§‚ï¼Œå¯èƒ½å­˜åœ¨è¶…è·Œæœºä¼šï¼Œä½†éœ€è°¨æ…æ“ä½œã€‚\n"

    # æ•°æ®è´¨é‡æç¤º
    if data_completeness < 70:
        report += f"\nâš ï¸ æ•°æ®è´¨é‡æç¤ºï¼šå½“å‰æ•°æ®å®Œæ•´æ€§{data_completeness:.1f}%ï¼Œåˆ†æç»“æœå¯ä¿¡åº¦æœ‰é™ã€‚\n"
    elif data_completeness < 90:
        report += f"\nğŸ“Š æ•°æ®è´¨é‡æç¤ºï¼šæ•°æ®å®Œæ•´æ€§{data_completeness:.1f}%ï¼Œåˆ†æç»“æœåŸºæœ¬å¯ä¿¡ã€‚\n"
    else:
        report += f"\nâœ… æ•°æ®è´¨é‡æç¤ºï¼šæ•°æ®å®Œæ•´æ€§{data_completeness:.1f}%ï¼Œåˆ†æç»“æœé«˜åº¦å¯ä¿¡ã€‚\n"

    return report


def get_enhanced_stock_data_with_emotion(stock_code, start_date, end_date):
    """
    è·å–å¢å¼ºç‰ˆè‚¡ç¥¨æ•°æ®ï¼ˆåŒ…å«æƒ…ç»ªæŒ‡æ ‡ï¼‰- ä½¿ç”¨å‰å¤æƒæ•°æ®
    """
    try:
        with api_lock:
            hist_data = pro.stk_factor_pro(**{
                "ts_code": stock_code,
                "start_date": start_date,
                "end_date": end_date,
                "trade_date": "",
                "limit": "",
                "offset": ""
            }, fields=[
                # åŸºç¡€æ•°æ®
                "ts_code", "trade_date", "open", "open_qfq", "high", "high_qfq",
                "low", "low_qfq", "close", "close_qfq", "pre_close", "change",
                "pct_chg", "vol", "amount", "turnover_rate", "total_mv",
                # æƒ…ç»ªç›¸å…³æŒ‡æ ‡ï¼ˆå‰å¤æƒï¼‰
                "rsi_qfq_6", "rsi_qfq_12", "rsi_qfq_24",
                "cci_qfq", "kdj_k_qfq", "kdj_d_qfq", "kdj_qfq",
                "macd_dif_qfq", "macd_dea_qfq", "macd_qfq",
                "psy_qfq", "vr_qfq", "obv_qfq", "mfi_qfq",
                # å…¶ä»–æŠ€æœ¯æŒ‡æ ‡
                "ma_qfq_5", "ma_qfq_10", "ma_qfq_20", "ma_qfq_60"
            ])

        if len(hist_data) == 0:
            # å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨åŸæ¥å£
            with api_lock:
                hist_data = pro.daily(ts_code=stock_code, start_date=start_date, end_date=end_date)
            # ç®€åŒ–å¤„ç†ï¼Œæ·»åŠ å‰å¤æƒå­—æ®µ
            for col in ['open', 'high', 'low', 'close']:
                hist_data[f'{col}_qfq'] = hist_data[col]

        return hist_data

    except Exception as e:
        print(f"è·å–æƒ…ç»ªæ•°æ®å¤±è´¥ {stock_code}: {e}")
        # è¿”å›åŸºç¡€æ•°æ®
        try:
            with api_lock:
                hist_data = pro.daily(ts_code=stock_code, start_date=start_date, end_date=end_date)
            for col in ['open', 'high', 'low', 'close']:
                hist_data[f'{col}_qfq'] = hist_data[col]
            return hist_data
        except:
            return pd.DataFrame()
        # æƒ…ç»ªåˆ†æéƒ¨åˆ†ç»“æŸ


def calculate_atr(hist_data, period=14):
    """è®¡ç®—ATRï¼ˆå¹³å‡çœŸå®æ³¢å¹…ï¼‰ç”¨äºåŠ¨æ€æ­¢æŸ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    df = hist_data.copy().sort_values('trade_date')

    # ä½¿ç”¨å‰å¤æƒæ•°æ®è®¡ç®—ATR
    df['prev_close'] = df['close_qfq'].shift(1)
    df['tr1'] = df['high_qfq'] - df['low_qfq']
    df['tr2'] = abs(df['high_qfq'] - df['prev_close'])
    df['tr3'] = abs(df['low_qfq'] - df['prev_close'])
    df['tr'] = df[['tr1', 'tr2', 'tr3']].max(axis=1)

    # è®¡ç®—ATR
    df['atr'] = df['tr'].rolling(window=period).mean()

    return df.iloc[-1]['atr'] if pd.notna(df.iloc[-1]['atr']) else df.iloc[-1]['close_qfq'] * 0.02


def calculate_market_strength(hist_data):
    """è®¡ç®—å¸‚åœºå¼ºåº¦æŒ‡æ ‡ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    df = hist_data.copy().sort_values('trade_date')
    recent = df.tail(20)

    # è®¡ç®—ä¸Šæ¶¨å¤©æ•°æ¯”ä¾‹
    up_days = len(recent[recent['pct_chg'] > 0])
    strength_ratio = up_days / len(recent)

    # è®¡ç®—å¹³å‡æ¶¨è·Œå¹…
    avg_change = recent['pct_chg'].mean()

    # è®¡ç®—æ³¢åŠ¨ç‡
    volatility = recent['pct_chg'].std()

    return {
        'strength_ratio': strength_ratio,
        'avg_change': avg_change,
        'volatility': volatility
    }


def calculate_four_dimensional_analysis(hist_data):
    """
    ä¸“ä¸šå››ç»´ç»“æ„åˆ†ææ³• - ä½¿ç”¨å‰å¤æƒæ•°æ®
    å››ä¸ªç»´åº¦ï¼šæ—¶é—´ã€ä»·æ ¼ã€æˆäº¤é‡ã€ç©ºé—´
    """
    df = hist_data.copy().sort_values('trade_date')

    if len(df) < 60:
        return {
            'time_dimension': {'trend': 'æ•°æ®ä¸è¶³', 'cycle_analysis': 'æ— æ³•åˆ†æ'},
            'price_dimension': {'structure': 'æ•°æ®ä¸è¶³', 'key_levels': []},
            'volume_dimension': {'distribution': 'æ•°æ®ä¸è¶³', 'anomaly': 'æ— æ³•æ£€æµ‹'},
            'space_dimension': {'volatility': 'æ•°æ®ä¸è¶³', 'range_analysis': 'æ— æ³•åˆ†æ'},
            'comprehensive_score': 0,
            'structure_type': 'æ— æ³•ç¡®å®š',
            'structure_strength': 'å¼±'
        }

    # ç¬¬ä¸€ç»´åº¦ï¼šæ—¶é—´ç»´åº¦åˆ†æ
    time_analysis = analyze_time_dimension(df)

    # ç¬¬äºŒç»´åº¦ï¼šä»·æ ¼ç»´åº¦åˆ†æ
    price_analysis = analyze_price_dimension(df)

    # ç¬¬ä¸‰ç»´åº¦ï¼šæˆäº¤é‡ç»´åº¦åˆ†æ
    volume_analysis = analyze_volume_dimension(df)

    # ç¬¬å››ç»´åº¦ï¼šç©ºé—´ç»´åº¦åˆ†æ
    space_analysis = analyze_space_dimension(df)

    # ç»¼åˆè¯„åˆ†è®¡ç®—
    comprehensive_score = calculate_comprehensive_score(
        time_analysis, price_analysis, volume_analysis, space_analysis
    )

    # ç»“æ„ç±»å‹åˆ¤æ–­
    structure_type = determine_structure_type(
        time_analysis, price_analysis, volume_analysis, space_analysis
    )

    return {
        'time_dimension': time_analysis,
        'price_dimension': price_analysis,
        'volume_dimension': volume_analysis,
        'space_dimension': space_analysis,
        'comprehensive_score': comprehensive_score,
        'structure_type': structure_type,
        'structure_strength': get_structure_strength(comprehensive_score)
    }


def analyze_time_dimension(df):
    """æ—¶é—´ç»´åº¦åˆ†æï¼šè¶‹åŠ¿æŒç»­æ€§ã€å‘¨æœŸæ€§ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    recent_60 = df.tail(60)
    recent_20 = df.tail(20)
    recent_5 = df.tail(5)

    # å¤šå‘¨æœŸè¶‹åŠ¿åˆ†æ - ä½¿ç”¨å‰å¤æƒæ”¶ç›˜ä»·
    trend_5d = "ä¸Šå‡" if recent_5['close_qfq'].iloc[-1] > recent_5['close_qfq'].iloc[0] else "ä¸‹é™"
    trend_20d = "ä¸Šå‡" if recent_20['close_qfq'].iloc[-1] > recent_20['close_qfq'].iloc[0] else "ä¸‹é™"
    trend_60d = "ä¸Šå‡" if recent_60['close_qfq'].iloc[-1] > recent_60['close_qfq'].iloc[0] else "ä¸‹é™"

    # è¶‹åŠ¿ä¸€è‡´æ€§åˆ†æ
    trend_consistency = 0
    if trend_5d == trend_20d == trend_60d:
        trend_consistency = 90  # é«˜åº¦ä¸€è‡´
    elif (trend_5d == trend_20d) or (trend_20d == trend_60d):
        trend_consistency = 60  # ä¸­ç­‰ä¸€è‡´
    else:
        trend_consistency = 30  # ä½ä¸€è‡´æ€§

    # ä»·æ ¼åŠ¨èƒ½åˆ†æ - ä½¿ç”¨å‰å¤æƒæ•°æ®
    momentum_5d = (recent_5['close_qfq'].iloc[-1] / recent_5['close_qfq'].iloc[0] - 1) * 100
    momentum_20d = (recent_20['close_qfq'].iloc[-1] / recent_20['close_qfq'].iloc[0] - 1) * 100

    # å‘¨æœŸæ€§åˆ†æï¼ˆåŸºäºæ³¢å³°æ³¢è°·ï¼‰- ä½¿ç”¨å‰å¤æƒæ•°æ®
    highs = df['high_qfq'].values
    lows = df['low_qfq'].values

    # å¯»æ‰¾å±€éƒ¨æå€¼
    high_peaks = argrelextrema(highs, np.greater, order=5)[0] if len(highs) > 10 else []
    low_valleys = argrelextrema(lows, np.less, order=5)[0] if len(lows) > 10 else []

    # è®¡ç®—å¹³å‡å‘¨æœŸ
    if len(high_peaks) > 2:
        avg_peak_cycle = np.mean(np.diff(high_peaks))
    else:
        avg_peak_cycle = 0

    if len(low_valleys) > 2:
        avg_valley_cycle = np.mean(np.diff(low_valleys))
    else:
        avg_valley_cycle = 0

    # å½“å‰ä½ç½®åˆ¤æ–­
    current_position = "ä¸­æ€§"
    if len(high_peaks) > 0 and len(low_valleys) > 0:
        last_high_idx = high_peaks[-1] if len(high_peaks) > 0 else 0
        last_low_idx = low_valleys[-1] if len(low_valleys) > 0 else 0
        current_idx = len(df) - 1

        if last_high_idx > last_low_idx:
            days_from_high = current_idx - last_high_idx
            if days_from_high < 5:
                current_position = "é«˜ä½é™„è¿‘"
            elif days_from_high < 15:
                current_position = "é«˜ä½å›è½"
            else:
                current_position = "ä¸‹é™é€šé“"
        else:
            days_from_low = current_idx - last_low_idx
            if days_from_low < 5:
                current_position = "ä½ä½é™„è¿‘"
            elif days_from_low < 15:
                current_position = "ä½ä½åå¼¹"
            else:
                current_position = "ä¸Šå‡é€šé“"

    return {
        'short_trend': trend_5d,
        'medium_trend': trend_20d,
        'long_trend': trend_60d,
        'trend_consistency': trend_consistency,
        'momentum_5d': momentum_5d,
        'momentum_20d': momentum_20d,
        'avg_cycle': (avg_peak_cycle + avg_valley_cycle) / 2 if avg_peak_cycle > 0 and avg_valley_cycle > 0 else 0,
        'current_position': current_position,
        'time_score': min(trend_consistency + abs(momentum_20d) * 2, 100)
    }


def analyze_price_dimension(df):
    """ä»·æ ¼ç»´åº¦åˆ†æï¼šç»“æ„å½¢æ€ã€å…³é”®ä»·ä½ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    recent_data = df.tail(60)

    # ä»·æ ¼ç»“æ„åˆ†æ - ä½¿ç”¨å‰å¤æƒæ•°æ®
    current_price = recent_data['close_qfq'].iloc[-1]
    period_high = recent_data['high_qfq'].max()
    period_low = recent_data['low_qfq'].min()

    # ä»·æ ¼ä½ç½®
    price_position = (current_price - period_low) / (period_high - period_low) * 100

    # å…³é”®ä»·ä½è¯†åˆ«
    key_levels = []

    # æ”¯æ’‘é˜»åŠ›ä½ï¼ˆåŸºäºå¯†é›†æˆäº¤åŒºåŸŸï¼‰
    price_ranges = np.linspace(period_low, period_high, 20)
    volume_at_price = []

    for i in range(len(price_ranges) - 1):
        range_low = price_ranges[i]
        range_high = price_ranges[i + 1]
        volume_in_range = recent_data[
            (recent_data['low_qfq'] <= range_high) & (recent_data['high_qfq'] >= range_low)
            ]['vol'].sum()
        volume_at_price.append((range_low + range_high) / 2)

    # æ‰¾å‡ºæˆäº¤é‡æœ€å¤§çš„ä»·ä½åŒºé—´ä½œä¸ºå…³é”®ä½
    if len(volume_at_price) > 0:
        sorted_indices = np.argsort(volume_at_price)[-3:]  # å–å‰3ä¸ª
        key_levels = [price_ranges[i] for i in sorted_indices]

    # æ–æ³¢é‚£å¥‘å›è°ƒä½
    fib_levels = []
    if period_high != period_low:
        fib_ratios = [0.236, 0.382, 0.5, 0.618, 0.786]
        for ratio in fib_ratios:
            fib_level = period_high - (period_high - period_low) * ratio
            fib_levels.append(fib_level)

    # ä»·æ ¼å½¢æ€è¯†åˆ«
    price_pattern = identify_price_pattern(recent_data)

    # æ³¢åŠ¨ç‡åˆ†æ - ä½¿ç”¨å‰å¤æƒæ•°æ®
    returns = recent_data['close_qfq'].pct_change().dropna()
    volatility = returns.std() * np.sqrt(252) * 100  # å¹´åŒ–æ³¢åŠ¨ç‡

    return {
        'current_position_pct': price_position,
        'key_support_levels': key_levels[:2] if len(key_levels) >= 2 else key_levels,
        'key_resistance_levels': key_levels[2:] if len(key_levels) > 2 else [],
        'fibonacci_levels': fib_levels,
        'price_pattern': price_pattern,
        'volatility': volatility,
        'price_score': min(abs(price_position - 50) + (100 - volatility), 100)
    }


def analyze_volume_dimension(df):
    """æˆäº¤é‡ç»´åº¦åˆ†æï¼šé‡ä»·å…³ç³»ã€å¼‚å¸¸é‡èƒ½"""
    recent_data = df.tail(60)

    if 'vol' not in recent_data.columns:
        return {
            'volume_trend': 'æ•°æ®ç¼ºå¤±',
            'price_volume_correlation': 0,
            'volume_anomaly': 'æ— æ³•æ£€æµ‹',
            'volume_distribution': 'æ•°æ®ç¼ºå¤±',
            'volume_score': 0
        }

    # æˆäº¤é‡è¶‹åŠ¿åˆ†æ
    volume_ma5 = recent_data['vol'].rolling(5).mean()
    volume_ma20 = recent_data['vol'].rolling(20).mean()

    current_vol_ratio = recent_data['vol'].iloc[-1] / volume_ma20.iloc[-1]

    volume_trend = "æ­£å¸¸"
    if current_vol_ratio > 3:
        volume_trend = "çˆ†é‡"
    elif current_vol_ratio > 2:
        volume_trend = "å·¨é‡"
    elif current_vol_ratio > 1.5:
        volume_trend = "æ”¾é‡"
    elif current_vol_ratio < 0.5:
        volume_trend = "ç¼©é‡"

    # é‡ä»·ç›¸å…³æ€§åˆ†æ - ä½¿ç”¨å‰å¤æƒæ•°æ®
    price_changes = recent_data['close_qfq'].pct_change().dropna()
    volume_changes = recent_data['vol'].pct_change().dropna()

    if len(price_changes) > 5 and len(volume_changes) > 5:
        min_len = min(len(price_changes), len(volume_changes))
        correlation = np.corrcoef(
            price_changes.iloc[-min_len:],
            volume_changes.iloc[-min_len:]
        )[0, 1]
        correlation = correlation if not np.isnan(correlation) else 0
    else:
        correlation = 0

    # å¼‚å¸¸é‡èƒ½æ£€æµ‹
    volume_std = recent_data['vol'].std()
    volume_mean = recent_data['vol'].mean()
    recent_volume = recent_data['vol'].iloc[-1]

    z_score = (recent_volume - volume_mean) / volume_std if volume_std > 0 else 0

    volume_anomaly = "æ­£å¸¸"
    if abs(z_score) > 3:
        volume_anomaly = "æå¼‚å¸¸" if z_score > 0 else "æç¼©é‡"
    elif abs(z_score) > 2:
        volume_anomaly = "å¼‚å¸¸" if z_score > 0 else "æ˜æ˜¾ç¼©é‡"
    elif abs(z_score) > 1:
        volume_anomaly = "åé«˜" if z_score > 0 else "åä½"

    # æˆäº¤é‡åˆ†å¸ƒåˆ†æ
    volume_quartiles = recent_data['vol'].quantile([0.25, 0.5, 0.75])
    current_vol_position = "ä½é‡åŒº"
    if recent_volume > volume_quartiles[0.75]:
        current_vol_position = "é«˜é‡åŒº"
    elif recent_volume > volume_quartiles[0.5]:
        current_vol_position = "ä¸­é«˜é‡åŒº"
    elif recent_volume > volume_quartiles[0.25]:
        current_vol_position = "ä¸­ä½é‡åŒº"

    return {
        'volume_trend': volume_trend,
        'price_volume_correlation': correlation,
        'volume_anomaly': volume_anomaly,
        'volume_distribution': current_vol_position,
        'volume_ratio': current_vol_ratio,
        'volume_score': min(abs(correlation) * 50 + min(current_vol_ratio, 3) * 20, 100)
    }


def analyze_space_dimension(df):
    """ç©ºé—´ç»´åº¦åˆ†æï¼šæ³¢åŠ¨ç©ºé—´ã€æ”¯æ’‘é˜»åŠ›å¼ºåº¦ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    recent_data = df.tail(60)

    # æ³¢åŠ¨ç©ºé—´åˆ†æ - ä½¿ç”¨å‰å¤æƒæ•°æ®
    current_price = recent_data['close_qfq'].iloc[-1]
    period_high = recent_data['high_qfq'].max()
    period_low = recent_data['low_qfq'].min()

    total_range = period_high - period_low
    current_position = (current_price - period_low) / total_range * 100

    # æ—¥å†…æ³¢åŠ¨åˆ†æ - ä½¿ç”¨å‰å¤æƒæ•°æ®
    daily_ranges = (recent_data['high_qfq'] - recent_data['low_qfq']) / recent_data['close_qfq'] * 100
    avg_daily_range = daily_ranges.mean()
    current_daily_range = daily_ranges.iloc[-1]

    # æ”¯æ’‘é˜»åŠ›å¼ºåº¦åˆ†æ
    # è®¡ç®—ä»·æ ¼åœ¨å„ä¸ªæ°´å¹³çš„åœç•™æ—¶é—´å’Œåå¼¹æ¬¡æ•°
    support_strength = calculate_level_strength(recent_data, period_low, is_support=True)
    resistance_strength = calculate_level_strength(recent_data, period_high, is_support=False)

    # ç©ºé—´åˆ©ç”¨ç‡
    space_utilization = 100 - abs(current_position - 50)  # è¶Šæ¥è¿‘ä¸­é—´ï¼Œåˆ©ç”¨ç‡è¶Šä½

    # çªç ´æ¦‚ç‡è¯„ä¼°
    breakthrough_probability = 50  # åŸºç¡€æ¦‚ç‡

    if current_position > 80:  # é«˜ä½
        breakthrough_probability = 30 + resistance_strength * 20
    elif current_position < 20:  # ä½ä½
        breakthrough_probability = 30 + support_strength * 20
    else:  # ä¸­ä½
        breakthrough_probability = 50

    return {
        'current_position_pct': current_position,
        'total_range_pct': total_range / current_price * 100,
        'avg_daily_range': avg_daily_range,
        'current_daily_range': current_daily_range,
        'support_strength': support_strength,
        'resistance_strength': resistance_strength,
        'space_utilization': space_utilization,
        'breakthrough_probability': breakthrough_probability,
        'space_score': min(space_utilization + avg_daily_range * 2, 100)
    }


def calculate_level_strength(df, level, is_support=True, tolerance=0.02):
    """è®¡ç®—æ”¯æ’‘æˆ–é˜»åŠ›ä½çš„å¼ºåº¦ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    touches = 0
    bounces = 0

    level_range_low = level * (1 - tolerance)
    level_range_high = level * (1 + tolerance)

    for i in range(1, len(df)):
        if is_support:
            # æ£€æŸ¥æ˜¯å¦è§¦åŠæ”¯æ’‘ä½ - ä½¿ç”¨å‰å¤æƒæ•°æ®
            if df.iloc[i]['low_qfq'] <= level_range_high and df.iloc[i]['low_qfq'] >= level_range_low:
                touches += 1
                # æ£€æŸ¥æ˜¯å¦åå¼¹
                if i < len(df) - 1 and df.iloc[i + 1]['close_qfq'] > df.iloc[i]['close_qfq']:
                    bounces += 1
        else:
            # æ£€æŸ¥æ˜¯å¦è§¦åŠé˜»åŠ›ä½ - ä½¿ç”¨å‰å¤æƒæ•°æ®
            if df.iloc[i]['high_qfq'] <= level_range_high and df.iloc[i]['high_qfq'] >= level_range_low:
                touches += 1
                # æ£€æŸ¥æ˜¯å¦å›è½
                if i < len(df) - 1 and df.iloc[i + 1]['close_qfq'] < df.iloc[i]['close_qfq']:
                    bounces += 1

    strength = bounces / touches if touches > 0 else 0
    return min(strength, 1.0)


def identify_price_pattern(df):
    """è¯†åˆ«ä»·æ ¼å½¢æ€ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    if len(df) < 20:
        return "æ•°æ®ä¸è¶³"

    recent_20 = df.tail(20)
    highs = recent_20['high_qfq'].values
    lows = recent_20['low_qfq'].values
    closes = recent_20['close_qfq'].values

    # å¯»æ‰¾å±€éƒ¨æå€¼
    high_peaks_idx = argrelextrema(highs, np.greater, order=3)[0]
    low_valleys_idx = argrelextrema(lows, np.less, order=3)[0]

    pattern = "éœ‡è¡æ•´ç†"

    # åŒé¡¶å½¢æ€æ£€æµ‹
    if len(high_peaks_idx) >= 2:
        last_two_peaks = high_peaks_idx[-2:]
        peak_heights = highs[last_two_peaks]
        if abs(peak_heights[1] / peak_heights[0] - 1) < 0.03:  # é«˜åº¦ç›¸è¿‘
            pattern = "åŒé¡¶å½¢æ€"

    # åŒåº•å½¢æ€æ£€æµ‹
    if len(low_valleys_idx) >= 2:
        last_two_valleys = low_valleys_idx[-2:]
        valley_depths = lows[last_two_valleys]
        if abs(valley_depths[1] / valley_depths[0] - 1) < 0.03:  # æ·±åº¦ç›¸è¿‘
            pattern = "åŒåº•å½¢æ€"

    # å¤´è‚©å½¢æ€æ£€æµ‹ï¼ˆç®€åŒ–ç‰ˆï¼‰
    if len(high_peaks_idx) >= 3:
        last_three_peaks = high_peaks_idx[-3:]
        peak_heights = highs[last_three_peaks]
        if (peak_heights[1] > peak_heights[0] and
                peak_heights[1] > peak_heights[2] and
                abs(peak_heights[0] / peak_heights[2] - 1) < 0.05):
            pattern = "å¤´è‚©é¡¶å½¢æ€"

    if len(low_valleys_idx) >= 3:
        last_three_valleys = low_valleys_idx[-3:]
        valley_depths = lows[last_three_valleys]
        if (valley_depths[1] < valley_depths[0] and
                valley_depths[1] < valley_depths[2] and
                abs(valley_depths[0] / valley_depths[2] - 1) < 0.05):
            pattern = "å¤´è‚©åº•å½¢æ€"

    # è¶‹åŠ¿å½¢æ€æ£€æµ‹
    first_close = closes[0]
    last_close = closes[-1]
    trend_strength = (last_close / first_close - 1) * 100

    if trend_strength > 5:
        pattern = f"ä¸Šå‡è¶‹åŠ¿ (+{trend_strength:.1f}%)"
    elif trend_strength < -5:
        pattern = f"ä¸‹é™è¶‹åŠ¿ ({trend_strength:.1f}%)"

    return pattern


def calculate_comprehensive_score(time_analysis, price_analysis, volume_analysis, space_analysis):
    """è®¡ç®—å››ç»´åˆ†æç»¼åˆå¾—åˆ†"""
    time_score = time_analysis.get('time_score', 0)
    price_score = price_analysis.get('price_score', 0)
    volume_score = volume_analysis.get('volume_score', 0)
    space_score = space_analysis.get('space_score', 0)

    # æƒé‡åˆ†é…ï¼šæ—¶é—´30%ï¼Œä»·æ ¼30%ï¼Œæˆäº¤é‡25%ï¼Œç©ºé—´15%
    comprehensive_score = (
            time_score * 0.30 +
            price_score * 0.30 +
            volume_score * 0.25 +
            space_score * 0.15
    )

    return min(comprehensive_score, 100)


def determine_structure_type(time_analysis, price_analysis, volume_analysis, space_analysis):
    """ç¡®å®šç»“æ„ç±»å‹"""
    trend_consistency = time_analysis.get('trend_consistency', 0)
    price_position = price_analysis.get('current_position_pct', 50)
    volume_trend = volume_analysis.get('volume_trend', 'æ­£å¸¸')
    space_position = space_analysis.get('current_position_pct', 50)

    if trend_consistency > 70:
        if price_position > 70 and volume_trend in ['æ”¾é‡', 'å·¨é‡', 'çˆ†é‡']:
            return "å¼ºåŠ¿çªç ´ç»“æ„"
        elif price_position < 30 and volume_trend in ['æ”¾é‡', 'å·¨é‡', 'çˆ†é‡']:
            return "å¼ºåŠ¿åè½¬ç»“æ„"
        elif trend_consistency > 85:
            return "è¶‹åŠ¿å»¶ç»­ç»“æ„"
        else:
            return "å¥åº·è°ƒæ•´ç»“æ„"
    elif 40 < price_position < 60:
        return "å¹³è¡¡éœ‡è¡ç»“æ„"
    elif price_position > 80 or price_position < 20:
        return "æå€¼åè½¬ç»“æ„"
    else:
        return "ä¸æ˜ç¡®ç»“æ„"


def get_structure_strength(score):
    """æ ¹æ®ç»¼åˆå¾—åˆ†è¯„ä¼°ç»“æ„å¼ºåº¦"""
    if score >= 80:
        return "æå¼º"
    elif score >= 65:
        return "å¼º"
    elif score >= 50:
        return "ä¸­ç­‰"
    elif score >= 35:
        return "åå¼±"
    else:
        return "å¼±"


def analyze_top_bottom_structure(hist_data):
    """
    ä¸“ä¸šé¡¶éƒ¨åº•éƒ¨ç»“æ„åˆ†æ - ä½¿ç”¨å‰å¤æƒæ•°æ®
    è¯†åˆ«å„ç§é¡¶åº•å½¢æ€å¹¶è¯„ä¼°å…¶æœ‰æ•ˆæ€§
    """
    df = hist_data.copy().sort_values('trade_date')

    if len(df) < 30:
        return {
            'top_structures': [],
            'bottom_structures': [],
            'current_structure': 'æ•°æ®ä¸è¶³',
            'structure_reliability': 0,
            'breakout_probability': 50,
            'key_levels': [],
            'structure_analysis': 'å†å²æ•°æ®ä¸è¶³ï¼Œæ— æ³•è¿›è¡Œæœ‰æ•ˆçš„é¡¶åº•ç»“æ„åˆ†æ'
        }

    # åˆ†æä¸åŒæ—¶é—´è·¨åº¦çš„ç»“æ„
    structures_60d = analyze_structure_period(df.tail(60), "60æ—¥")
    structures_30d = analyze_structure_period(df.tail(30), "30æ—¥")
    structures_15d = analyze_structure_period(df.tail(15), "15æ—¥")

    # åˆå¹¶æ‰€æœ‰ç»“æ„
    all_top_structures = (structures_60d['tops'] + structures_30d['tops'] +
                          structures_15d['tops'])
    all_bottom_structures = (structures_60d['bottoms'] + structures_30d['bottoms'] +
                             structures_15d['bottoms'])

    # å½“å‰ç»“æ„åˆ¤æ–­
    current_structure = determine_current_structure(df, all_top_structures, all_bottom_structures)

    # ç»“æ„å¯é æ€§è¯„ä¼°
    reliability = assess_structure_reliability(df, all_top_structures, all_bottom_structures)

    # çªç ´æ¦‚ç‡è¯„ä¼°
    breakout_prob = assess_breakout_probability(df, current_structure, reliability)

    # å…³é”®ä»·ä½æå–
    key_levels = extract_key_levels(all_top_structures, all_bottom_structures)

    # ç”Ÿæˆç»“æ„åˆ†ææŠ¥å‘Š
    structure_analysis = generate_structure_analysis_report(
        current_structure, all_top_structures, all_bottom_structures, reliability
    )

    return {
        'top_structures': all_top_structures,
        'bottom_structures': all_bottom_structures,
        'current_structure': current_structure,
        'structure_reliability': reliability,
        'breakout_probability': breakout_prob,
        'key_levels': key_levels,
        'structure_analysis': structure_analysis
    }


def analyze_structure_period(df, period_name):
    """åˆ†æç‰¹å®šå‘¨æœŸçš„ç»“æ„å½¢æ€ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    if len(df) < 10:
        return {'tops': [], 'bottoms': []}

    highs = df['high_qfq'].values
    lows = df['low_qfq'].values
    closes = df['close_qfq'].values
    dates = df['trade_date'].values

    # å¯»æ‰¾å±€éƒ¨æå€¼ç‚¹
    high_peaks_idx = argrelextrema(highs, np.greater, order=2)[0]
    low_valleys_idx = argrelextrema(lows, np.less, order=2)[0]

    top_structures = []
    bottom_structures = []

    # åˆ†æé¡¶éƒ¨ç»“æ„
    top_structures.extend(detect_double_top(df, high_peaks_idx, period_name))
    top_structures.extend(detect_triple_top(df, high_peaks_idx, period_name))
    top_structures.extend(detect_head_shoulders_top(df, high_peaks_idx, period_name))
    top_structures.extend(detect_rising_wedge(df, period_name))

    # åˆ†æåº•éƒ¨ç»“æ„
    bottom_structures.extend(detect_double_bottom(df, low_valleys_idx, period_name))
    bottom_structures.extend(detect_triple_bottom(df, low_valleys_idx, period_name))
    bottom_structures.extend(detect_head_shoulders_bottom(df, low_valleys_idx, period_name))
    bottom_structures.extend(detect_falling_wedge(df, period_name))

    return {'tops': top_structures, 'bottoms': bottom_structures}


def detect_double_top(df, peaks_idx, period):
    """æ£€æµ‹åŒé¡¶å½¢æ€ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    structures = []

    if len(peaks_idx) < 2:
        return structures

    highs = df['high_qfq'].values

    for i in range(len(peaks_idx) - 1):
        peak1_idx = peaks_idx[i]
        peak2_idx = peaks_idx[i + 1]

        peak1_price = highs[peak1_idx]
        peak2_price = highs[peak2_idx]

        # åŒé¡¶æ¡ä»¶ï¼šä¸¤ä¸ªé«˜ç‚¹ç›¸è¿‘ï¼ˆå·®å¼‚å°äº3%ï¼‰
        price_diff = abs(peak1_price - peak2_price) / max(peak1_price, peak2_price)

        if price_diff < 0.03:
            # è®¡ç®—é¢ˆçº¿ä½
            valley_between = df.iloc[peak1_idx:peak2_idx]['low_qfq'].min()

            # è®¡ç®—å¼ºåº¦æŒ‡æ ‡
            strength = calculate_pattern_strength(df, peak1_idx, peak2_idx, 'double_top')

            structure = {
                'type': 'åŒé¡¶',
                'period': period,
                'peak1_price': peak1_price,
                'peak2_price': peak2_price,
                'neckline': valley_between,
                'strength': strength,
                'target_price': valley_between - (max(peak1_price, peak2_price) - valley_between),
                'reliability': 'high' if strength > 70 else 'medium' if strength > 50 else 'low',
                'formation_dates': [df.iloc[peak1_idx]['trade_date'], df.iloc[peak2_idx]['trade_date']]
            }
            structures.append(structure)

    return structures


def detect_double_bottom(df, valleys_idx, period):
    """æ£€æµ‹åŒåº•å½¢æ€ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    structures = []

    if len(valleys_idx) < 2:
        return structures

    lows = df['low_qfq'].values

    for i in range(len(valleys_idx) - 1):
        valley1_idx = valleys_idx[i]
        valley2_idx = valleys_idx[i + 1]

        valley1_price = lows[valley1_idx]
        valley2_price = lows[valley2_idx]

        # åŒåº•æ¡ä»¶ï¼šä¸¤ä¸ªä½ç‚¹ç›¸è¿‘ï¼ˆå·®å¼‚å°äº3%ï¼‰
        price_diff = abs(valley1_price - valley2_price) / max(valley1_price, valley2_price)

        if price_diff < 0.03:
            # è®¡ç®—é¢ˆçº¿ä½
            peak_between = df.iloc[valley1_idx:valley2_idx]['high_qfq'].max()

            # è®¡ç®—å¼ºåº¦æŒ‡æ ‡
            strength = calculate_pattern_strength(df, valley1_idx, valley2_idx, 'double_bottom')

            structure = {
                'type': 'åŒåº•',
                'period': period,
                'valley1_price': valley1_price,
                'valley2_price': valley2_price,
                'neckline': peak_between,
                'strength': strength,
                'target_price': peak_between + (peak_between - min(valley1_price, valley2_price)),
                'reliability': 'high' if strength > 70 else 'medium' if strength > 50 else 'low',
                'formation_dates': [df.iloc[valley1_idx]['trade_date'], df.iloc[valley2_idx]['trade_date']]
            }
            structures.append(structure)

    return structures


def detect_triple_top(df, peaks_idx, period):
    """æ£€æµ‹ä¸‰é‡é¡¶å½¢æ€ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    structures = []

    if len(peaks_idx) < 3:
        return structures

    highs = df['high_qfq'].values

    for i in range(len(peaks_idx) - 2):
        peak1_idx = peaks_idx[i]
        peak2_idx = peaks_idx[i + 1]
        peak3_idx = peaks_idx[i + 2]

        peak1_price = highs[peak1_idx]
        peak2_price = highs[peak2_idx]
        peak3_price = highs[peak3_idx]

        # ä¸‰é‡é¡¶æ¡ä»¶ï¼šä¸‰ä¸ªé«˜ç‚¹éƒ½ç›¸è¿‘ï¼ˆå·®å¼‚å°äº3%ï¼‰
        max_price = max(peak1_price, peak2_price, peak3_price)
        if (abs(peak1_price - max_price) / max_price < 0.03 and
                abs(peak2_price - max_price) / max_price < 0.03 and
                abs(peak3_price - max_price) / max_price < 0.03):
            # è®¡ç®—æ”¯æ’‘ä½ï¼ˆä¸¤ä¸ªè°·åº•çš„è¾ƒé«˜è€…ï¼‰
            valley1 = df.iloc[peak1_idx:peak2_idx]['low_qfq'].min()
            valley2 = df.iloc[peak2_idx:peak3_idx]['low_qfq'].min()
            support_level = max(valley1, valley2)

            strength = calculate_pattern_strength(df, peak1_idx, peak3_idx, 'triple_top')

            structure = {
                'type': 'ä¸‰é‡é¡¶',
                'period': period,
                'peak_prices': [peak1_price, peak2_price, peak3_price],
                'support_level': support_level,
                'strength': strength,
                'target_price': support_level - (max_price - support_level),
                'reliability': 'high' if strength > 75 else 'medium' if strength > 55 else 'low',
                'formation_dates': [df.iloc[peak1_idx]['trade_date'],
                                    df.iloc[peak2_idx]['trade_date'],
                                    df.iloc[peak3_idx]['trade_date']]
            }
            structures.append(structure)

    return structures


def detect_triple_bottom(df, valleys_idx, period):
    """æ£€æµ‹ä¸‰é‡åº•å½¢æ€ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    structures = []

    if len(valleys_idx) < 3:
        return structures

    lows = df['low_qfq'].values

    for i in range(len(valleys_idx) - 2):
        valley1_idx = valleys_idx[i]
        valley2_idx = valleys_idx[i + 1]
        valley3_idx = valleys_idx[i + 2]

        valley1_price = lows[valley1_idx]
        valley2_price = lows[valley2_idx]
        valley3_price = lows[valley3_idx]

        # ä¸‰é‡åº•æ¡ä»¶ï¼šä¸‰ä¸ªä½ç‚¹éƒ½ç›¸è¿‘ï¼ˆå·®å¼‚å°äº3%ï¼‰
        min_price = min(valley1_price, valley2_price, valley3_price)
        if (abs(valley1_price - min_price) / min_price < 0.03 and
                abs(valley2_price - min_price) / min_price < 0.03 and
                abs(valley3_price - min_price) / min_price < 0.03):
            # è®¡ç®—é˜»åŠ›ä½ï¼ˆä¸¤ä¸ªå³°é¡¶çš„è¾ƒä½è€…ï¼‰
            peak1 = df.iloc[valley1_idx:valley2_idx]['high_qfq'].max()
            peak2 = df.iloc[valley2_idx:valley3_idx]['high_qfq'].max()
            resistance_level = min(peak1, peak2)

            strength = calculate_pattern_strength(df, valley1_idx, valley3_idx, 'triple_bottom')

            structure = {
                'type': 'ä¸‰é‡åº•',
                'period': period,
                'valley_prices': [valley1_price, valley2_price, valley3_price],
                'resistance_level': resistance_level,
                'strength': strength,
                'target_price': resistance_level + (resistance_level - min_price),
                'reliability': 'high' if strength > 75 else 'medium' if strength > 55 else 'low',
                'formation_dates': [df.iloc[valley1_idx]['trade_date'],
                                    df.iloc[valley2_idx]['trade_date'],
                                    df.iloc[valley3_idx]['trade_date']]
            }
            structures.append(structure)

    return structures


def detect_head_shoulders_top(df, peaks_idx, period):
    """æ£€æµ‹å¤´è‚©é¡¶å½¢æ€ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    structures = []

    if len(peaks_idx) < 3:
        return structures

    highs = df['high_qfq'].values

    for i in range(len(peaks_idx) - 2):
        left_shoulder_idx = peaks_idx[i]
        head_idx = peaks_idx[i + 1]
        right_shoulder_idx = peaks_idx[i + 2]

        left_shoulder_price = highs[left_shoulder_idx]
        head_price = highs[head_idx]
        right_shoulder_price = highs[right_shoulder_idx]

        # å¤´è‚©é¡¶æ¡ä»¶ï¼šå¤´éƒ¨é«˜äºä¸¤è‚©ï¼Œä¸¤è‚©é«˜åº¦ç›¸è¿‘
        if (head_price > left_shoulder_price and head_price > right_shoulder_price and
                abs(left_shoulder_price - right_shoulder_price) / max(left_shoulder_price,
                                                                      right_shoulder_price) < 0.05):
            # è®¡ç®—é¢ˆçº¿ä½
            valley1 = df.iloc[left_shoulder_idx:head_idx]['low_qfq'].min()
            valley2 = df.iloc[head_idx:right_shoulder_idx]['low_qfq'].min()
            neckline = max(valley1, valley2)  # å–è¾ƒé«˜çš„è°·åº•ä½œä¸ºé¢ˆçº¿

            strength = calculate_pattern_strength(df, left_shoulder_idx, right_shoulder_idx, 'head_shoulders_top')

            structure = {
                'type': 'å¤´è‚©é¡¶',
                'period': period,
                'left_shoulder': left_shoulder_price,
                'head': head_price,
                'right_shoulder': right_shoulder_price,
                'neckline': neckline,
                'strength': strength,
                'target_price': neckline - (head_price - neckline),
                'reliability': 'high' if strength > 75 else 'medium' if strength > 55 else 'low',
                'formation_dates': [df.iloc[left_shoulder_idx]['trade_date'],
                                    df.iloc[head_idx]['trade_date'],
                                    df.iloc[right_shoulder_idx]['trade_date']]
            }
            structures.append(structure)

    return structures


def detect_head_shoulders_bottom(df, valleys_idx, period):
    """æ£€æµ‹å¤´è‚©åº•å½¢æ€ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    structures = []

    if len(valleys_idx) < 3:
        return structures

    lows = df['low_qfq'].values

    for i in range(len(valleys_idx) - 2):
        left_shoulder_idx = valleys_idx[i]
        head_idx = valleys_idx[i + 1]
        right_shoulder_idx = valleys_idx[i + 2]

        left_shoulder_price = lows[left_shoulder_idx]
        head_price = lows[head_idx]
        right_shoulder_price = lows[right_shoulder_idx]

        # å¤´è‚©åº•æ¡ä»¶ï¼šå¤´éƒ¨ä½äºä¸¤è‚©ï¼Œä¸¤è‚©é«˜åº¦ç›¸è¿‘
        if (head_price < left_shoulder_price and head_price < right_shoulder_price and
                abs(left_shoulder_price - right_shoulder_price) / max(left_shoulder_price,
                                                                      right_shoulder_price) < 0.05):
            # è®¡ç®—é¢ˆçº¿ä½
            peak1 = df.iloc[left_shoulder_idx:head_idx]['high_qfq'].max()
            peak2 = df.iloc[head_idx:right_shoulder_idx]['high_qfq'].max()
            neckline = min(peak1, peak2)  # å–è¾ƒä½çš„å³°é¡¶ä½œä¸ºé¢ˆçº¿

            strength = calculate_pattern_strength(df, left_shoulder_idx, right_shoulder_idx, 'head_shoulders_bottom')

            structure = {
                'type': 'å¤´è‚©åº•',
                'period': period,
                'left_shoulder': left_shoulder_price,
                'head': head_price,
                'right_shoulder': right_shoulder_price,
                'neckline': neckline,
                'strength': strength,
                'target_price': neckline + (neckline - head_price),
                'reliability': 'high' if strength > 75 else 'medium' if strength > 55 else 'low',
                'formation_dates': [df.iloc[left_shoulder_idx]['trade_date'],
                                    df.iloc[head_idx]['trade_date'],
                                    df.iloc[right_shoulder_idx]['trade_date']]
            }
            structures.append(structure)

    return structures


def detect_rising_wedge(df, period):
    """æ£€æµ‹ä¸Šå‡æ¥”å½¢ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    if len(df) < 15:
        return []

    # ç®€åŒ–çš„æ¥”å½¢æ£€æµ‹ï¼šå¯»æ‰¾æ”¶æ•›çš„ä¸Šå‡è¶‹åŠ¿çº¿
    recent_data = df.tail(15)
    highs = recent_data['high_qfq'].values
    lows = recent_data['low_qfq'].values

    # è®¡ç®—è¶‹åŠ¿çº¿æ–œç‡
    x = range(len(highs))
    high_slope = np.polyfit(x, highs, 1)[0]
    low_slope = np.polyfit(x, lows, 1)[0]

    # ä¸Šå‡æ¥”å½¢ï¼šä¸Šå‡è¶‹åŠ¿ä½†é«˜ç‚¹ä¸Šå‡æ–œç‡ < ä½ç‚¹ä¸Šå‡æ–œç‡ï¼Œä¸”éƒ½åœ¨ä¸Šå‡
    if (high_slope > 0 and low_slope > 0 and low_slope > high_slope * 1.2):
        structure = {
            'type': 'ä¸Šå‡æ¥”å½¢',
            'period': period,
            'high_slope': high_slope,
            'low_slope': low_slope,
            'convergence_rate': (low_slope - high_slope) / high_slope,
            'strength': 60,  # ä¸­ç­‰å¼ºåº¦
            'reliability': 'medium',
            'target_direction': 'ä¸‹è·Œ',
            'formation_dates': [recent_data.iloc[0]['trade_date'], recent_data.iloc[-1]['trade_date']]
        }
        return [structure]

    return []


def detect_falling_wedge(df, period):
    """æ£€æµ‹ä¸‹é™æ¥”å½¢ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    if len(df) < 15:
        return []

    recent_data = df.tail(15)
    highs = recent_data['high_qfq'].values
    lows = recent_data['low_qfq'].values

    # è®¡ç®—è¶‹åŠ¿çº¿æ–œç‡
    x = range(len(highs))
    high_slope = np.polyfit(x, highs, 1)[0]
    low_slope = np.polyfit(x, lows, 1)[0]

    # ä¸‹é™æ¥”å½¢ï¼šä¸‹é™è¶‹åŠ¿ä½†ä½ç‚¹ä¸‹é™æ–œç‡ < é«˜ç‚¹ä¸‹é™æ–œç‡ï¼Œä¸”éƒ½åœ¨ä¸‹é™
    if (high_slope < 0 and low_slope < 0 and abs(low_slope) < abs(high_slope) * 0.8):
        structure = {
            'type': 'ä¸‹é™æ¥”å½¢',
            'period': period,
            'high_slope': high_slope,
            'low_slope': low_slope,
            'convergence_rate': (abs(high_slope) - abs(low_slope)) / abs(high_slope),
            'strength': 60,  # ä¸­ç­‰å¼ºåº¦
            'reliability': 'medium',
            'target_direction': 'ä¸Šæ¶¨',
            'formation_dates': [recent_data.iloc[0]['trade_date'], recent_data.iloc[-1]['trade_date']]
        }
        return [structure]

    return []


def calculate_pattern_strength(df, start_idx, end_idx, pattern_type):
    """è®¡ç®—å½¢æ€å¼ºåº¦"""
    base_strength = 50

    # æ—¶é—´è·¨åº¦åŠ åˆ†ï¼ˆå½¢æˆæ—¶é—´è¶Šé•¿ï¼Œè¶Šå¯é ï¼‰
    time_span = end_idx - start_idx
    time_bonus = min(time_span * 2, 20)

    # æˆäº¤é‡ç¡®è®¤åŠ åˆ†
    if 'vol' in df.columns:
        pattern_volume = df.iloc[start_idx:end_idx + 1]['vol'].mean()
        total_avg_volume = df['vol'].mean()

        if pattern_volume > total_avg_volume * 1.2:
            volume_bonus = 15
        elif pattern_volume > total_avg_volume:
            volume_bonus = 10
        else:
            volume_bonus = 0
    else:
        volume_bonus = 0

    # ä»·æ ¼æ³¢åŠ¨ç‡åŠ åˆ†ï¼ˆé€‚åº¦æ³¢åŠ¨æ›´å¯é ï¼‰- ä½¿ç”¨å‰å¤æƒæ•°æ®
    pattern_data = df.iloc[start_idx:end_idx + 1]
    volatility = pattern_data['close_qfq'].std() / pattern_data['close_qfq'].mean()

    if 0.02 < volatility < 0.08:  # é€‚åº¦æ³¢åŠ¨
        volatility_bonus = 10
    elif volatility < 0.02:  # æ³¢åŠ¨å¤ªå°
        volatility_bonus = -5
    else:  # æ³¢åŠ¨å¤ªå¤§
        volatility_bonus = -10

    strength = base_strength + time_bonus + volume_bonus + volatility_bonus
    return min(max(strength, 0), 100)


def determine_current_structure(df, top_structures, bottom_structures):
    """åˆ¤æ–­å½“å‰æ‰€å¤„çš„ç»“æ„é˜¶æ®µ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    current_price = df['close_qfq'].iloc[-1]

    # æ£€æŸ¥æ˜¯å¦å¤„äºå·²è¯†åˆ«çš„å½¢æ€ä¸­
    active_tops = []
    active_bottoms = []

    for structure in top_structures:
        if structure['reliability'] in ['high', 'medium']:
            active_tops.append(structure)

    for structure in bottom_structures:
        if structure['reliability'] in ['high', 'medium']:
            active_bottoms.append(structure)

    # åˆ¤æ–­å½“å‰ä½ç½®
    if active_tops:
        latest_top = max(active_tops, key=lambda x: max(x.get('formation_dates', [''])))
        if latest_top['type'] == 'åŒé¡¶':
            if current_price > latest_top['neckline']:
                return f"åŒé¡¶å½¢æ€ç¡®è®¤ä¸­ï¼Œå½“å‰åœ¨é¢ˆçº¿{latest_top['neckline']:.2f}ä¸Šæ–¹"
            else:
                return f"åŒé¡¶é¢ˆçº¿{latest_top['neckline']:.2f}å·²ç ´ï¼Œä¸‹è·Œç›®æ ‡{latest_top['target_price']:.2f}"
        elif latest_top['type'] == 'å¤´è‚©é¡¶':
            if current_price > latest_top['neckline']:
                return f"å¤´è‚©é¡¶å½¢æ€æˆç«‹ï¼Œè­¦æƒ•é¢ˆçº¿{latest_top['neckline']:.2f}æ”¯æ’‘"
            else:
                return f"å¤´è‚©é¡¶ç¡®è®¤ï¼Œä¸‹è·Œç›®æ ‡{latest_top['target_price']:.2f}"

    if active_bottoms:
        latest_bottom = max(active_bottoms, key=lambda x: max(x.get('formation_dates', [''])))
        if latest_bottom['type'] == 'åŒåº•':
            if current_price < latest_bottom['neckline']:
                return f"åŒåº•å½¢æ€ç¡®è®¤ä¸­ï¼Œå½“å‰åœ¨é¢ˆçº¿{latest_bottom['neckline']:.2f}ä¸‹æ–¹"
            else:
                return f"åŒåº•é¢ˆçº¿{latest_bottom['neckline']:.2f}å·²ç ´ï¼Œä¸Šæ¶¨ç›®æ ‡{latest_bottom['target_price']:.2f}"
        elif latest_bottom['type'] == 'å¤´è‚©åº•':
            if current_price < latest_bottom['neckline']:
                return f"å¤´è‚©åº•å½¢æ€æˆç«‹ï¼Œå…³æ³¨é¢ˆçº¿{latest_bottom['neckline']:.2f}é˜»åŠ›"
            else:
                return f"å¤´è‚©åº•ç¡®è®¤ï¼Œä¸Šæ¶¨ç›®æ ‡{latest_bottom['target_price']:.2f}"

    # å¦‚æœæ²¡æœ‰æ˜ç¡®å½¢æ€ï¼Œåˆ†æè¶‹åŠ¿
    recent_20 = df.tail(20)
    trend_change = (recent_20['close_qfq'].iloc[-1] / recent_20['close_qfq'].iloc[0] - 1) * 100

    if trend_change > 5:
        return "ä¸Šå‡è¶‹åŠ¿ä¸­ï¼Œæš‚æ— æ˜ç¡®é¡¶åº•å½¢æ€"
    elif trend_change < -5:
        return "ä¸‹é™è¶‹åŠ¿ä¸­ï¼Œæš‚æ— æ˜ç¡®é¡¶åº•å½¢æ€"
    else:
        return "æ¨ªç›˜æ•´ç†ä¸­ï¼Œç­‰å¾…å½¢æ€æ˜ç¡®"


def assess_structure_reliability(df, top_structures, bottom_structures):
    """è¯„ä¼°ç»“æ„å¯é æ€§"""
    if not top_structures and not bottom_structures:
        return 30  # åŸºç¡€å¯é æ€§

    total_score = 0
    structure_count = 0

    for structure in top_structures + bottom_structures:
        if structure['reliability'] == 'high':
            total_score += 80
        elif structure['reliability'] == 'medium':
            total_score += 60
        else:
            total_score += 40
        structure_count += 1

    if structure_count == 0:
        return 30

    avg_reliability = total_score / structure_count

    # æˆäº¤é‡ç¡®è®¤åŠ åˆ†
    if 'vol' in df.columns:
        recent_volume = df.tail(10)['vol'].mean()
        overall_volume = df['vol'].mean()

        if recent_volume > overall_volume * 1.3:
            avg_reliability += 10
        elif recent_volume > overall_volume * 1.1:
            avg_reliability += 5

    return min(avg_reliability, 95)


def assess_breakout_probability(df, current_structure, reliability):
    """è¯„ä¼°çªç ´æ¦‚ç‡ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    base_probability = 50

    # æ ¹æ®ç»“æ„å¯é æ€§è°ƒæ•´
    reliability_factor = (reliability - 50) * 0.4

    # æ ¹æ®å½“å‰ä»·æ ¼ä½ç½®è°ƒæ•´
    recent_20 = df.tail(20)
    current_price = recent_20['close_qfq'].iloc[-1]
    period_high = recent_20['high_qfq'].max()
    period_low = recent_20['low_qfq'].min()

    price_position = (current_price - period_low) / (period_high - period_low) * 100

    if price_position > 80:  # é«˜ä½
        position_factor = 20  # å‘ä¸Šçªç ´æ¦‚ç‡å¢åŠ 
    elif price_position < 20:  # ä½ä½
        position_factor = 20  # å‘ä¸‹çªç ´æ¦‚ç‡å¢åŠ 
    else:
        position_factor = 0

    # æˆäº¤é‡å› ç´ 
    volume_factor = 0
    if 'vol' in df.columns:
        recent_volume = df.tail(5)['vol'].mean()
        avg_volume = df['vol'].mean()

        if recent_volume > avg_volume * 1.5:
            volume_factor = 15
        elif recent_volume > avg_volume * 1.2:
            volume_factor = 10

    breakout_probability = base_probability + reliability_factor + position_factor + volume_factor
    return min(max(breakout_probability, 10), 90)


def extract_key_levels(top_structures, bottom_structures):
    """æå–å…³é”®ä»·ä½"""
    key_levels = []

    for structure in top_structures:
        if structure['reliability'] in ['high', 'medium']:
            if 'neckline' in structure:
                key_levels.append({
                    'price': structure['neckline'],
                    'type': 'é˜»åŠ›ä½',
                    'source': f"{structure['type']}é¢ˆçº¿",
                    'strength': structure['strength']
                })
            if 'target_price' in structure:
                key_levels.append({
                    'price': structure['target_price'],
                    'type': 'æ”¯æ’‘ç›®æ ‡',
                    'source': f"{structure['type']}ç›®æ ‡",
                    'strength': structure['strength']
                })

    for structure in bottom_structures:
        if structure['reliability'] in ['high', 'medium']:
            if 'neckline' in structure:
                key_levels.append({
                    'price': structure['neckline'],
                    'type': 'æ”¯æ’‘ä½',
                    'source': f"{structure['type']}é¢ˆçº¿",
                    'strength': structure['strength']
                })
            if 'target_price' in structure:
                key_levels.append({
                    'price': structure['target_price'],
                    'type': 'é˜»åŠ›ç›®æ ‡',
                    'source': f"{structure['type']}ç›®æ ‡",
                    'strength': structure['strength']
                })

    # æŒ‰å¼ºåº¦æ’åºå¹¶å»é‡
    key_levels.sort(key=lambda x: x['strength'], reverse=True)
    return key_levels[:8]  # è¿”å›æœ€é‡è¦çš„8ä¸ªä½ç½®


def generate_structure_analysis_report(current_structure, top_structures, bottom_structures, reliability):
    """ç”Ÿæˆç»“æ„åˆ†ææŠ¥å‘Š"""
    report = f"å½“å‰ç»“æ„çŠ¶æ€ï¼š{current_structure}\n\n"

    if top_structures:
        report += "ğŸ”» è¯†åˆ«åˆ°çš„é¡¶éƒ¨ç»“æ„ï¼š\n"
        for i, structure in enumerate(top_structures[:3], 1):  # åªæ˜¾ç¤ºå‰3ä¸ª
            report += f"{i}. {structure['type']}ï¼ˆ{structure['period']}ï¼Œå¯é æ€§ï¼š{structure['reliability']}ï¼‰\n"
            if 'neckline' in structure:
                report += f"   é¢ˆçº¿ä½ï¼š{structure['neckline']:.2f}\n"
            if 'target_price' in structure:
                report += f"   ç›®æ ‡ä½ï¼š{structure['target_price']:.2f}\n"
        report += "\n"

    if bottom_structures:
        report += "ğŸ”º è¯†åˆ«åˆ°çš„åº•éƒ¨ç»“æ„ï¼š\n"
        for i, structure in enumerate(bottom_structures[:3], 1):  # åªæ˜¾ç¤ºå‰3ä¸ª
            report += f"{i}. {structure['type']}ï¼ˆ{structure['period']}ï¼Œå¯é æ€§ï¼š{structure['reliability']}ï¼‰\n"
            if 'neckline' in structure:
                report += f"   é¢ˆçº¿ä½ï¼š{structure['neckline']:.2f}\n"
            if 'target_price' in structure:
                report += f"   ç›®æ ‡ä½ï¼š{structure['target_price']:.2f}\n"
        report += "\n"

    report += f"ç»“æ„å¯é æ€§è¯„åˆ†ï¼š{reliability:.1f}/100\n\n"

    # æ“ä½œå»ºè®®
    if reliability > 70:
        report += "ğŸ“ˆ æ“ä½œå»ºè®®ï¼šç»“æ„å½¢æ€æ¸…æ™°ï¼Œå¯æŒ‰å½¢æ€ç†è®ºè¿›è¡Œæ“ä½œ\n"
    elif reliability > 50:
        report += "âš ï¸ æ“ä½œå»ºè®®ï¼šç»“æ„å½¢æ€ä¸€èˆ¬ï¼Œéœ€ç»“åˆå…¶ä»–æŒ‡æ ‡ç¡®è®¤\n"
    else:
        report += "ğŸ¤” æ“ä½œå»ºè®®ï¼šç»“æ„å½¢æ€ä¸æ˜ç¡®ï¼Œå»ºè®®ç­‰å¾…æ›´æ¸…æ™°ä¿¡å·\n"

    return report


def calculate_td_sequential_enhanced(hist_data):
    """å¢å¼ºç‰ˆTDåºåˆ—è®¡ç®— - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    df = hist_data.copy()
    df = df.sort_values('trade_date')

    # åˆå§‹åŒ–TDæŒ‡æ ‡åˆ—
    df['td_setup'] = 0
    df['td_countdown'] = 0
    df['td_perfected'] = False
    df['td_combo'] = 0
    df['td_flip_price'] = 0.0
    df['tdst_resistance'] = 0.0
    df['tdst_support'] = 0.0
    df['td_risk_level'] = 0
    df['td_sequential_13'] = False
    df['td_pressure'] = 0
    df['td_momentum'] = 0

    # TD Setupè®¡ç®—
    buy_setup_count = 0
    sell_setup_count = 0
    setup_direction = 0
    setup_start_idx = 0

    # TD Countdownè®¡ç®—
    countdown_active = False
    countdown_type = 0
    countdown_count = 0
    countdown_start_idx = 0

    # TD Comboè®¡ç®—
    combo_count = 0
    combo_type = 0

    for i in range(4, len(df)):
        # è·å–ç¿»è½¬ä»·æ ¼ï¼ˆ4å¤©å‰çš„æ”¶ç›˜ä»·ï¼‰- ä½¿ç”¨å‰å¤æƒæ•°æ®
        flip_price = df.iloc[i - 4]['close_qfq']
        df.iloc[i, df.columns.get_loc('td_flip_price')] = flip_price

        current_close = df.iloc[i]['close_qfq']
        current_low = df.iloc[i]['low_qfq']
        current_high = df.iloc[i]['high_qfq']

        # TD Buy Setup
        if current_close < flip_price:
            if buy_setup_count >= 0:
                buy_setup_count += 1
                sell_setup_count = 0
                df.iloc[i, df.columns.get_loc('td_setup')] = buy_setup_count
                setup_direction = 1

                if buy_setup_count == 1:
                    setup_start_idx = i

                # æ£€æŸ¥å®Œç¾è®¾ç½®
                if buy_setup_count == 8 or buy_setup_count == 9:
                    if i >= 7:
                        low_6 = df.iloc[i - 2]['low_qfq']
                        low_7 = df.iloc[i - 1]['low_qfq']
                        if current_low < min(low_6, low_7):
                            df.iloc[i, df.columns.get_loc('td_perfected')] = True

                # Setup 9å®Œæˆ
                if buy_setup_count == 9:
                    countdown_active = True
                    countdown_type = 1
                    countdown_count = 0
                    countdown_start_idx = i

                    # è®¡ç®—TDSTæ”¯æ’‘çº¿
                    setup_data = df.iloc[setup_start_idx:i + 1]
                    tdst_support = setup_data['low_qfq'].min()
                    df.iloc[i, df.columns.get_loc('tdst_support')] = tdst_support

                    # å¼€å§‹Comboè®¡æ•°
                    combo_count = 1
                    combo_type = 1

            else:
                buy_setup_count = 1
                sell_setup_count = 0
                df.iloc[i, df.columns.get_loc('td_setup')] = buy_setup_count
                setup_direction = 1
                setup_start_idx = i

        # TD Sell Setup
        elif current_close > flip_price:
            if sell_setup_count <= 0:
                sell_setup_count -= 1
                buy_setup_count = 0
                df.iloc[i, df.columns.get_loc('td_setup')] = sell_setup_count
                setup_direction = -1

                if sell_setup_count == -1:
                    setup_start_idx = i

                # æ£€æŸ¥å®Œç¾è®¾ç½®
                if sell_setup_count == -8 or sell_setup_count == -9:
                    if i >= 7:
                        high_6 = df.iloc[i - 2]['high_qfq']
                        high_7 = df.iloc[i - 1]['high_qfq']
                        if current_high > max(high_6, high_7):
                            df.iloc[i, df.columns.get_loc('td_perfected')] = True

                # Setup -9å®Œæˆ
                if sell_setup_count == -9:
                    countdown_active = True
                    countdown_type = -1
                    countdown_count = 0
                    countdown_start_idx = i

                    # è®¡ç®—TDSTé˜»åŠ›çº¿
                    setup_data = df.iloc[setup_start_idx:i + 1]
                    tdst_resistance = setup_data['high_qfq'].max()
                    df.iloc[i, df.columns.get_loc('tdst_resistance')] = tdst_resistance

                    # å¼€å§‹Comboè®¡æ•°
                    combo_count = -1
                    combo_type = -1

            else:
                sell_setup_count = -1
                buy_setup_count = 0
                df.iloc[i, df.columns.get_loc('td_setup')] = sell_setup_count
                setup_direction = -1
                setup_start_idx = i
        else:
            # ä»·æ ¼ç­‰äºç¿»è½¬ä»·æ ¼ï¼ŒSetupä¸­æ–­
            buy_setup_count = 0
            sell_setup_count = 0
            combo_count = 0

        # TD Countdownè®¡ç®— - ä½¿ç”¨å‰å¤æƒæ•°æ®
        if countdown_active and i > countdown_start_idx and i >= 2:
            if countdown_type == 1:  # ä¹°å…¥å€’è®¡æ—¶
                if current_close <= df.iloc[i - 2]['low_qfq']:
                    countdown_count += 1
                    df.iloc[i, df.columns.get_loc('td_countdown')] = countdown_count

                    if countdown_count == 13:
                        df.iloc[i, df.columns.get_loc('td_sequential_13')] = True

            elif countdown_type == -1:  # å–å‡ºå€’è®¡æ—¶
                if current_close >= df.iloc[i - 2]['high_qfq']:
                    countdown_count -= 1
                    df.iloc[i, df.columns.get_loc('td_countdown')] = countdown_count

                    if countdown_count == -13:
                        df.iloc[i, df.columns.get_loc('td_sequential_13')] = True

            # å€’è®¡æ—¶å®Œæˆ
            if abs(countdown_count) >= 13:
                countdown_active = False
                countdown_count = 0

        # TD Comboè®¡ç®— - ä½¿ç”¨å‰å¤æƒæ•°æ®
        if combo_type != 0 and i > setup_start_idx:
            if combo_type == 1 and current_close < df.iloc[i - 1]['close_qfq']:
                combo_count += 1
                df.iloc[i, df.columns.get_loc('td_combo')] = combo_count
            elif combo_type == -1 and current_close > df.iloc[i - 1]['close_qfq']:
                combo_count -= 1
                df.iloc[i, df.columns.get_loc('td_combo')] = combo_count

            if abs(combo_count) >= 13:
                combo_count = 0
                combo_type = 0

        # è®¡ç®—TDå‹åŠ›æŒ‡æ ‡ï¼ˆæ–°å¢ï¼‰- ä½¿ç”¨å‰å¤æƒæ•°æ®
        pressure = 0
        if i >= 9:
            recent_highs = df.iloc[i - 9:i + 1]['high_qfq'].max()
            recent_lows = df.iloc[i - 9:i + 1]['low_qfq'].min()
            if recent_highs > recent_lows:
                price_position = (current_close - recent_lows) / (recent_highs - recent_lows)
                pressure = int((1 - price_position) * 10)  # 0-10çš„å‹åŠ›çº§åˆ«
        df.iloc[i, df.columns.get_loc('td_pressure')] = pressure

        # è®¡ç®—TDåŠ¨é‡æŒ‡æ ‡ï¼ˆæ–°å¢ï¼‰- ä½¿ç”¨å‰å¤æƒæ•°æ®
        momentum = 0
        if i >= 4:
            price_change = (current_close - df.iloc[i - 4]['close_qfq']) / df.iloc[i - 4]['close_qfq']
            momentum = min(max(price_change * 100, -10), 10)  # -10åˆ°+10çš„åŠ¨é‡
        df.iloc[i, df.columns.get_loc('td_momentum')] = momentum

        # è®¡ç®—ç»¼åˆTDé£é™©ç­‰çº§ï¼ˆå¢å¼ºç‰ˆï¼‰
        risk_level = 0

        # Setupé£é™©
        if abs(df.iloc[i]['td_setup']) >= 7:
            risk_level += 1 * np.sign(df.iloc[i]['td_setup'])
        if abs(df.iloc[i]['td_setup']) == 9:
            risk_level += 2 * np.sign(df.iloc[i]['td_setup'])

        # Countdowné£é™©
        if abs(df.iloc[i]['td_countdown']) >= 10:
            risk_level += 1 * np.sign(df.iloc[i]['td_countdown'])
        if abs(df.iloc[i]['td_countdown']) == 13:
            risk_level += 3 * np.sign(df.iloc[i]['td_countdown'])

        # Comboé£é™©
        if abs(df.iloc[i]['td_combo']) >= 10:
            risk_level += 1 * np.sign(df.iloc[i]['td_combo'])

        # å‹åŠ›å’ŒåŠ¨é‡è°ƒæ•´
        if pressure >= 8:
            risk_level -= 1
        if momentum > 5:
            risk_level += 1
        elif momentum < -5:
            risk_level -= 1

        df.iloc[i, df.columns.get_loc('td_risk_level')] = max(min(risk_level, 5), -5)

    return df


def calculate_support_resistance_enhanced(hist_data, periods=20):
    """å¢å¼ºç‰ˆæ”¯æ’‘é˜»åŠ›ä½è®¡ç®— - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    df = hist_data.copy()
    df = df.sort_values('trade_date')

    recent_data = df.tail(periods)

    # åŸºç¡€æ”¯æ’‘é˜»åŠ›ä½ - ä½¿ç”¨å‰å¤æƒæ•°æ®
    support1 = recent_data['low_qfq'].min()
    support2 = recent_data['low_qfq'].nsmallest(2).iloc[-1] if len(recent_data) >= 2 else support1

    resistance1 = recent_data['high_qfq'].max()
    resistance2 = recent_data['high_qfq'].nlargest(2).iloc[-1] if len(recent_data) >= 2 else resistance1

    # è½´å¿ƒç‚¹ - ä½¿ç”¨å‰å¤æƒæ•°æ®
    latest = recent_data.iloc[-1]
    pivot = (latest['high_qfq'] + latest['low_qfq'] + latest['close_qfq']) / 3

    return {
        'support1': support1,
        'support2': support2,
        'resistance1': resistance1,
        'resistance2': resistance2,
        'pivot': pivot,
        'support_strength': len(recent_data[recent_data['low_qfq'] <= support1 * 1.02]),
        'resistance_strength': len(recent_data[recent_data['high_qfq'] >= resistance1 * 0.98])
    }


def analyze_volume_pattern_enhanced(hist_data):
    """å¢å¼ºç‰ˆæˆäº¤é‡åˆ†æ"""
    df = hist_data.copy().sort_values('trade_date')
    recent = df.tail(20)
    latest = recent.iloc[-1]

    volume_col = 'vol'

    if volume_col not in df.columns:
        return {
            'volume_trend': "æ•°æ®ç¼ºå¤±",
            'volume_ratio': 0,
            'volume_price_match': "æ— æ³•åˆ†æ",
            'volume_surge': False,
            'volume_consistency': 0
        }

    # åŸºç¡€é‡æ¯”åˆ†æ
    avg_volume = recent[volume_col].mean()
    recent_volume = latest[volume_col]
    volume_ratio = recent_volume / avg_volume if avg_volume > 0 else 0

    # æˆäº¤é‡è¶‹åŠ¿
    volume_trend = "å¹³ç¨³"
    volume_surge = False

    if volume_ratio > 3.0:
        volume_trend = "çˆ†é‡"
        volume_surge = True
    elif volume_ratio > 2.0:
        volume_trend = "å·¨é‡"
        volume_surge = True
    elif volume_ratio > 1.5:
        volume_trend = "æ˜¾è‘—æ”¾é‡"
    elif volume_ratio > 1.2:
        volume_trend = "æ¸©å’Œæ”¾é‡"
    elif volume_ratio < 0.5:
        volume_trend = "æåº¦ç¼©é‡"
    elif volume_ratio < 0.8:
        volume_trend = "ç¼©é‡"

    # æˆäº¤é‡ä¸€è‡´æ€§ï¼ˆè¿ç»­æ€§ï¼‰
    volume_consistency = 0
    for i in range(1, min(6, len(recent))):
        prev_ratio = recent.iloc[-i - 1][volume_col] / avg_volume
        if prev_ratio > 1.2 and volume_ratio > 1.2:
            volume_consistency += 1
        elif prev_ratio < 0.8 and volume_ratio < 0.8:
            volume_consistency += 1

    # å¢å¼ºç‰ˆä»·é‡é…åˆåˆ†æ
    price_change = latest['pct_chg'] if 'pct_chg' in recent.columns else 0
    volume_price_match = ""

    if price_change > 5 and volume_ratio > 2.0:
        volume_price_match = "æ¶¨åœæ”¾é‡ï¼Œå¼ºçƒˆä¿¡å·"
    elif price_change > 3 and volume_ratio > 1.5:
        volume_price_match = "æ”¾é‡å¤§æ¶¨ï¼Œè¶‹åŠ¿ç¡®è®¤"
    elif price_change > 0 and volume_ratio > 1.2:
        volume_price_match = "ä»·æ¶¨é‡å¢ï¼Œè¶‹åŠ¿å¥åº·"
    elif price_change > 0 and volume_ratio < 0.8:
        volume_price_match = "ä»·æ¶¨é‡ç¼©ï¼Œç¼ºä¹ååŠ²"
    elif price_change < -5 and volume_ratio > 2.0:
        volume_price_match = "æ”¾é‡æš´è·Œï¼Œææ…Œæ€è·Œ"
    elif price_change < -3 and volume_ratio > 1.5:
        volume_price_match = "æ”¾é‡ä¸‹è·Œï¼Œå‹åŠ›è¾ƒå¤§"
    elif price_change < 0 and volume_ratio < 0.8:
        volume_price_match = "ç¼©é‡ä¸‹è·Œï¼Œå¯èƒ½è§åº•"
    else:
        volume_price_match = "ä»·é‡é…åˆæ­£å¸¸"

    return {
        'volume_trend': volume_trend,
        'volume_ratio': volume_ratio,
        'volume_price_match': volume_price_match,
        'volume_surge': volume_surge,
        'volume_consistency': volume_consistency
    }


def analyze_pattern_enhanced(hist_data):
    """å¢å¼ºç‰ˆKçº¿å½¢æ€åˆ†æ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""
    recent = hist_data.tail(10)
    latest = recent.iloc[-1]

    if len(recent) < 3:
        return "æ•°æ®ä¸è¶³"

    last3 = recent.tail(3)

    # åŸºç¡€è¶‹åŠ¿åˆ¤æ–­ - ä½¿ç”¨å‰å¤æƒæ•°æ®
    if all(last3.iloc[i]['close_qfq'] > last3.iloc[i - 1]['close_qfq'] for i in range(1, 3)):
        trend = "è¿ç»­ä¸Šæ¶¨"
    elif all(last3.iloc[i]['close_qfq'] < last3.iloc[i - 1]['close_qfq'] for i in range(1, 3)):
        trend = "è¿ç»­ä¸‹è·Œ"
    else:
        trend = "éœ‡è¡æ•´ç†"

    # Kçº¿å½¢æ€åˆ†æ - ä½¿ç”¨å‰å¤æƒæ•°æ®
    body_ratio = abs(latest['close_qfq'] - latest['open_qfq']) / (latest['high_qfq'] - latest['low_qfq'] + 0.0001)
    upper_shadow = (latest['high_qfq'] - max(latest['close_qfq'], latest['open_qfq'])) / (
            latest['high_qfq'] - latest['low_qfq'] + 0.0001)
    lower_shadow = (min(latest['close_qfq'], latest['open_qfq']) - latest['low_qfq']) / (
            latest['high_qfq'] - latest['low_qfq'] + 0.0001)

    pattern = trend

    # ç‰¹æ®ŠKçº¿å½¢æ€
    if body_ratio < 0.1:
        pattern += "ï¼Œåå­—æ˜Ÿï¼ˆå˜ç›˜ä¿¡å·ï¼‰"
    elif upper_shadow > 0.6:
        pattern += "ï¼Œé•¿ä¸Šå½±çº¿ï¼ˆä¸Šæ–¹å‹åŠ›å¤§ï¼‰"
    elif lower_shadow > 0.6:
        pattern += "ï¼Œé•¿ä¸‹å½±çº¿ï¼ˆä¸‹æ–¹æ”¯æ’‘å¼ºï¼‰"
    elif latest['close_qfq'] > latest['open_qfq'] and body_ratio > 0.7:
        pattern += "ï¼Œå¤§é˜³çº¿ï¼ˆå¤šå¤´å¼ºåŠ¿ï¼‰"
    elif latest['close_qfq'] < latest['open_qfq'] and body_ratio > 0.7:
        pattern += "ï¼Œå¤§é˜´çº¿ï¼ˆç©ºå¤´å¼ºåŠ¿ï¼‰"

    # æ ¹æ®æ¶¨å¹…åˆ¤æ–­å¼ºåŠ¿
    if 'pct_chg' in hist_data.columns:
        pct_chg = latest['pct_chg']
        if pct_chg > 0:
            if pct_chg > 7:
                pattern += "ï¼Œæ¶¨åœå¼ºåŠ¿"
            elif pct_chg > 5:
                pattern += "ï¼Œå¼ºåŠ¿ä¸Šæ¶¨"
            elif pct_chg > 2:
                pattern += "ï¼Œæ¸©å’Œä¸Šæ¶¨"
        elif pct_chg < -7:
            pattern += "ï¼Œè·Œåœå¼±åŠ¿"
        elif pct_chg < -5:
            pattern += "ï¼Œæ€¥è·Œ"

        # åˆ¤æ–­ä¸­æœŸè¶‹åŠ¿å¼ºåº¦
        if len(recent) >= 5:
            recent_5 = recent.tail(5)
            up_days = sum(1 for _, row in recent_5.iterrows() if row.get('pct_chg', 0) > 0)
            total_change = recent_5['pct_chg'].sum()

            if up_days >= 4 and total_change > 5:
                pattern += "ï¼Œä¸­æœŸå¼ºåŠ¿"
            elif up_days <= 1 and total_change < -5:
                pattern += "ï¼Œä¸­æœŸå¼±åŠ¿"

    return pattern


def generate_enhanced_td_strategy(latest_data, sr_levels, td_setup, td_countdown,
                                  td_perfected, td_combo, tdst_support, tdst_resistance,
                                  ma_trend, volume_analysis, market_strength, atr_value):
    """ç”Ÿæˆå¢å¼ºç‰ˆTDäº¤æ˜“ç­–ç•¥ - ä½¿ç”¨å‰å¤æƒæ•°æ®"""

    price = latest_data['close_qfq']  # ä½¿ç”¨å‰å¤æƒä»·æ ¼
    strategy = {
        'direction': '',
        'signal_strength': '',
        'entry_points': {},
        'stop_loss': 0,
        'targets': [],
        'position_size': '',
        'time_frame': '',
        'risk_reward': '',
        'confidence': 0,
        'notes': []
    }

    # è®¡ç®—åŠ¨æ€æ­¢æŸï¼ˆåŸºäºATRï¼‰
    atr_stop_distance = atr_value * 2.5 if atr_value > 0 else price * 0.05

    # ç»¼åˆä¿¡å·å¼ºåº¦è¯„ä¼°ï¼ˆä¼˜åŒ–åæ ‡å‡†ï¼‰
    signal_score = 0
    confidence_factors = []

    # TD Setupè¯„åˆ†ï¼ˆé™ä½é—¨æ§›ï¼‰
    if abs(td_setup) == 9:
        signal_score += 35
        confidence_factors.append("Setup 9å®Œæˆ")
    elif abs(td_setup) >= 7:
        signal_score += 20
        confidence_factors.append(f"Setup {abs(td_setup)}æ¥è¿‘å®Œæˆ")
    elif abs(td_setup) >= 4:
        signal_score += 12  # æé«˜ä¸­æœŸSetupæƒé‡
        confidence_factors.append(f"Setup {abs(td_setup)}è¿›è¡Œä¸­")
    elif abs(td_setup) >= 1:
        signal_score += 5
        confidence_factors.append(f"Setup {abs(td_setup)}åˆæœŸ")

    # TD Countdownè¯„åˆ†
    if abs(td_countdown) == 13:
        signal_score += 45
        confidence_factors.append("Countdown 13å®Œæˆ")
    elif abs(td_countdown) >= 10:
        signal_score += 30
        confidence_factors.append(f"Countdown {abs(td_countdown)}æ¥è¿‘å®Œæˆ")
    elif abs(td_countdown) >= 7:
        signal_score += 20
        confidence_factors.append(f"Countdown {abs(td_countdown)}ä¸­åæœŸ")
    elif abs(td_countdown) >= 3:
        signal_score += 10
        confidence_factors.append(f"Countdown {abs(td_countdown)}è¿›è¡Œä¸­")

    # TD Comboè¯„åˆ†
    if abs(td_combo) >= 10:
        signal_score += 18
        confidence_factors.append(f"Combo {abs(td_combo)}é«˜çº§åˆ«")
    elif abs(td_combo) >= 5:
        signal_score += 8
        confidence_factors.append(f"Combo {abs(td_combo)}ä¸­çº§åˆ«")

    # å®Œç¾è®¾ç½®åŠ åˆ†
    if td_perfected:
        signal_score += 20
        confidence_factors.append("å®Œç¾è®¾ç½®ç¡®è®¤")

    # æˆäº¤é‡ç¡®è®¤ï¼ˆæé«˜æƒé‡ï¼‰
    if volume_analysis['volume_surge']:
        signal_score += 18
        confidence_factors.append("çˆ†é‡ç¡®è®¤")
    elif volume_analysis['volume_ratio'] > 1.5:
        signal_score += 12
        confidence_factors.append("æ˜¾è‘—æ”¾é‡")
    elif volume_analysis['volume_ratio'] > 1.2:
        signal_score += 8
        confidence_factors.append("æ¸©å’Œæ”¾é‡")
    elif volume_analysis['volume_ratio'] < 0.8:
        signal_score -= 3
        confidence_factors.append("é‡èƒ½ä¸è¶³")

    # å‡çº¿ä½ç½®åŠ åˆ†
    if ma_trend == "å¤šå¤´æ’åˆ—":
        signal_score += 12
        confidence_factors.append("å‡çº¿å¤šå¤´")
    elif ma_trend == "ç©ºå¤´æ’åˆ—":
        signal_score -= 8
        confidence_factors.append("å‡çº¿ç©ºå¤´")

    # å¸‚åœºå¼ºåº¦è°ƒæ•´
    if market_strength['strength_ratio'] > 0.65:
        signal_score += 8
        confidence_factors.append("å¸‚åœºå¼ºåŠ¿")
    elif market_strength['strength_ratio'] < 0.35:
        signal_score -= 8
        confidence_factors.append("å¸‚åœºå¼±åŠ¿")

    # ä¿¡å·ç­‰çº§åˆ¤å®šï¼ˆå¤§å¹…ä¼˜åŒ–æ ‡å‡†ï¼‰
    if signal_score >= 70:
        strategy['signal_strength'] = "Sçº§ï¼ˆæå¼ºï¼‰"
        strategy['confidence'] = min(80 + signal_score * 0.15, 95)
    elif signal_score >= 50:  # é™ä½é—¨æ§›
        strategy['signal_strength'] = "Açº§ï¼ˆå¼ºï¼‰"
        strategy['confidence'] = min(65 + signal_score * 0.25, 85)
    elif signal_score >= 25:  # å¤§å¹…é™ä½é—¨æ§›
        strategy['signal_strength'] = "Bçº§ï¼ˆä¸­ç­‰ï¼‰"
        strategy['confidence'] = min(45 + signal_score * 0.4, 70)
    elif signal_score >= 10:  # é™ä½é—¨æ§›
        strategy['signal_strength'] = "C+çº§ï¼ˆåå¼±ï¼‰"
        strategy['confidence'] = min(35 + signal_score * 0.6, 55)
    else:
        strategy['signal_strength'] = "Cçº§ï¼ˆå¼±ï¼‰"
        strategy['confidence'] = min(25 + signal_score * 0.8, 45)

    # äº¤æ˜“æ–¹å‘åˆ¤æ–­ï¼ˆæ›´çµæ´»çš„æ ‡å‡†ï¼‰
    is_bullish_signal = (td_setup > 0 and td_setup >= 3) or (td_countdown > 0 and abs(td_countdown) >= 3)
    is_bearish_signal = (td_setup < 0 and td_setup <= -3) or (td_countdown < 0 and abs(td_countdown) >= 3)

    if is_bullish_signal or signal_score >= 20:  # é™ä½ä¹°å…¥é—¨æ§›
        strategy['direction'] = "ä¹°å…¥"

        # å…¥åœºç‚¹è®¾ç½®ï¼ˆæ›´å®ç”¨ï¼‰
        if signal_score >= 50:
            strategy['entry_points'] = {
                'æ¿€è¿›': f"{price:.2f}ï¼ˆå½“å‰ä»·ç«‹å³å…¥åœºï¼‰",
                'ç¨³å¥': f"{price * 0.99:.2f}ï¼ˆå°å¹…å›è°ƒ1%ï¼‰",
                'ä¿å®ˆ': f"{max(tdst_support if tdst_support > 0 else sr_levels['support1'], sr_levels['support1']) * 1.01:.2f}ï¼ˆæ”¯æ’‘ä½ç¡®è®¤ï¼‰"
            }
        elif signal_score >= 25:
            strategy['entry_points'] = {
                'ç¨³å¥': f"{price * 0.985:.2f}ï¼ˆå›è°ƒ1.5%å…¥åœºï¼‰",
                'ä¿å®ˆ': f"{sr_levels['support1'] * 1.015:.2f}ï¼ˆå¼ºæ”¯æ’‘ç¡®è®¤ï¼‰"
            }
        else:
            strategy['entry_points'] = {
                'ä¿å®ˆ': f"{sr_levels['support1'] * 1.01:.2f}ï¼ˆæ”¯æ’‘ä½ä¼ç¨³åè¯•æ¢ï¼‰",
                'è§‚å¯Ÿ': "ä¿¡å·åå¼±ï¼Œå»ºè®®å°ä»“ä½è¯•æ¢"
            }

        # åŠ¨æ€æ­¢æŸè®¾ç½®
        dynamic_support = max(
            tdst_support * 0.98 if tdst_support > 0 else 0,
            sr_levels['support1'] * 0.97,
            price - atr_stop_distance
        )
        strategy['stop_loss'] = dynamic_support

        # ç›®æ ‡ä½è®¾ç½®ï¼ˆå…³é”®ä¿®å¤ï¼ï¼‰
        # çŸ­çº¿ç›®æ ‡ï¼ˆ3-5%ï¼‰
        target1 = price * 1.035

        # æŠ€æœ¯é˜»åŠ›ç›®æ ‡
        tech_resistance = sr_levels['resistance1']
        if tdst_resistance > price * 1.02:
            tech_resistance = min(tdst_resistance, tech_resistance)
        target2 = min(tech_resistance, price * 1.08)

        # æ³¢æ®µç›®æ ‡ï¼ˆ10-15%ï¼‰
        target3 = price * 1.12
        if target2 > target3:
            target3 = target2 * 1.05

        strategy['targets'] = [
            f"T1: {target1:.2f}ï¼ˆ+{((target1 / price - 1) * 100):.1f}%ï¼ŒçŸ­çº¿ï¼‰",
            f"T2: {target2:.2f}ï¼ˆ+{((target2 / price - 1) * 100):.1f}%ï¼ŒæŠ€æœ¯é˜»åŠ›ï¼‰",
            f"T3: {target3:.2f}ï¼ˆ+{((target3 / price - 1) * 100):.1f}%ï¼Œæ³¢æ®µï¼‰"
        ]

    elif is_bearish_signal:
        strategy['direction'] = "å–å‡º/è§‚æœ›"

        if signal_score >= 40:
            strategy['entry_points'] = {
                'åšç©º': f"{price * 1.01:.2f}ï¼ˆåå¼¹åšç©ºï¼‰",
                'æŒä»“è€…': "è€ƒè™‘å‡ä»“æˆ–æ­¢ç›ˆ"
            }
        else:
            strategy['entry_points'] = {
                'è§‚æœ›': "TDå–å‡ºä¿¡å·ï¼Œæš‚ä¸ä¹°å…¥",
                'æŒä»“è€…': "è®¾ç½®æ­¢æŸï¼Œé˜²èŒƒå›è°ƒ"
            }

        # å–å‡ºæ­¢æŸ
        strategy['stop_loss'] = min(
            sr_levels['resistance1'] * 1.03,
            price + atr_stop_distance
        )

        # ä¸‹è·Œç›®æ ‡ä½
        target1 = price * 0.965  # -3.5%
        target2 = max(sr_levels['support1'], price * 0.92)  # æŠ€æœ¯æ”¯æ’‘
        target3 = price * 0.88  # -12%

        strategy['targets'] = [
            f"T1: {target1:.2f}ï¼ˆ{((target1 / price - 1) * 100):.1f}%ï¼ŒçŸ­çº¿ä¸‹è·Œï¼‰",
            f"T2: {target2:.2f}ï¼ˆ{((target2 / price - 1) * 100):.1f}%ï¼ŒæŠ€æœ¯æ”¯æ’‘ï¼‰",
            f"T3: {target3:.2f}ï¼ˆ{((target3 / price - 1) * 100):.1f}%ï¼Œæ·±åº¦å›è°ƒï¼‰"
        ]

    else:
        strategy['direction'] = "è§‚æœ›"

        # è§‚æœ›ä¹Ÿè¦è®¾ç½®å…³é”®ä½ç½®
        strategy['entry_points'] = {
            'ç­‰å¾…ä¹°å…¥': f"ä¸‹æ¢{sr_levels['support1']:.2f}æ”¯æ’‘ä½ç¡®è®¤å",
            'ç­‰å¾…å–å‡º': f"çªç ´{sr_levels['resistance1']:.2f}é˜»åŠ›ä½å"
        }

        # è®¾ç½®å…³é”®è§‚å¯Ÿä½ç½®
        upside_target = sr_levels['resistance1']
        downside_target = sr_levels['support1']

        strategy['targets'] = [
            f"ä¸Šæ–¹é˜»åŠ›: {upside_target:.2f}ï¼ˆ+{((upside_target / price - 1) * 100):.1f}%ï¼‰",
            f"ä¸‹æ–¹æ”¯æ’‘: {downside_target:.2f}ï¼ˆ{((downside_target / price - 1) * 100):.1f}%ï¼‰",
            f"è½´å¿ƒç‚¹: {sr_levels['pivot']:.2f}ï¼ˆ{((sr_levels['pivot'] / price - 1) * 100):.1f}%ï¼‰"
        ]

    # ä»“ä½ç®¡ç†ï¼ˆæ›´å®ç”¨çš„æ ‡å‡†ï¼‰
    if strategy['confidence'] >= 75:
        strategy['position_size'] = "50-70%ï¼ˆé«˜ä¿¡å¿ƒé‡ä»“ï¼‰"
    elif strategy['confidence'] >= 60:
        strategy['position_size'] = "40-50%ï¼ˆè¾ƒé«˜ä¿¡å¿ƒï¼‰"
    elif strategy['confidence'] >= 45:
        strategy['position_size'] = "30-40%ï¼ˆä¸­ç­‰ä¿¡å¿ƒï¼‰"
    elif strategy['confidence'] >= 35:
        strategy['position_size'] = "20-30%ï¼ˆåä½ä¿¡å¿ƒï¼‰"
    else:
        strategy['position_size'] = "10-20%ï¼ˆä½ä¿¡å¿ƒè¯•æ¢ï¼‰"

    # æ—¶é—´æ¡†æ¶
    if abs(td_countdown) >= 8:
        strategy['time_frame'] = "ä¸­çº¿ï¼ˆ1-3ä¸ªæœˆï¼‰"
    elif abs(td_setup) >= 6 or signal_score >= 40:
        strategy['time_frame'] = "æ³¢æ®µï¼ˆ2-4å‘¨ï¼‰"
    else:
        strategy['time_frame'] = "çŸ­çº¿ï¼ˆ5-15å¤©ï¼‰"

    # é£é™©æ”¶ç›Šæ¯”è®¡ç®—
    if strategy['stop_loss'] > 0 and len(strategy['targets']) > 0:
        try:
            first_target = float(strategy['targets'][0].split('T1: ')[1].split('ï¼ˆ')[0])
            risk = abs(price - strategy['stop_loss'])
            reward = abs(first_target - price)
            if risk > 0:
                rr_ratio = reward / risk
                strategy['risk_reward'] = f"1:{rr_ratio:.1f}"
            else:
                strategy['risk_reward'] = "é£é™©æå°"
        except:
            strategy['risk_reward'] = "æ— æ³•è®¡ç®—"
    else:
        strategy['risk_reward'] = "è§‚æœ›çŠ¶æ€"

    # ç‰¹æ®Šæç¤º
    if td_perfected:
        strategy['notes'].append("â­ å®Œç¾è®¾ç½®å‡ºç°ï¼Œä¿¡å·å¯é æ€§å¤§å¹…æå‡")

    if abs(td_countdown) >= 11:
        strategy['notes'].append("ğŸš¨ Countdownæ¥è¿‘å®Œæˆï¼Œé‡ç‚¹å…³æ³¨åè½¬æœºä¼š")

    if volume_analysis['volume_surge']:
        strategy['notes'].append("ğŸ“ˆ æˆäº¤é‡çˆ†å‘ï¼Œèµ„é‡‘å…³æ³¨åº¦é«˜")
    elif "ä»·æ¶¨é‡å¢" in volume_analysis['volume_price_match']:
        strategy['notes'].append("âœ… é‡ä»·é…åˆè‰¯å¥½ï¼Œè¶‹åŠ¿å¥åº·")
    elif "ä»·è·Œé‡å¢" in volume_analysis['volume_price_match']:
        strategy['notes'].append("âš ï¸ æ”¾é‡ä¸‹è·Œï¼Œè°¨æ…æ“ä½œ")

    if ma_trend == "å¤šå¤´æ’åˆ—":
        strategy['notes'].append("ğŸ“Š å‡çº¿å¤šå¤´æ’åˆ—ï¼Œä¸­æœŸè¶‹åŠ¿å‘å¥½")
    elif ma_trend == "ç©ºå¤´æ’åˆ—":
        strategy['notes'].append("ğŸ“‰ å‡çº¿ç©ºå¤´æ’åˆ—ï¼Œæ³¨æ„åå¼¹é«˜åº¦")

    # æ ¹æ®ä¿¡å·å¼ºåº¦æ·»åŠ é¢å¤–æç¤º
    if signal_score >= 50:
        strategy['notes'].append("ğŸ¯ é«˜è´¨é‡ä¿¡å·ï¼Œå»ºè®®é‡ç‚¹å…³æ³¨")
    elif signal_score >= 25:
        strategy['notes'].append("ğŸ‘€ ä¸­ç­‰ä¿¡å·ï¼Œé€‚åº¦å‚ä¸")
    else:
        strategy['notes'].append("ğŸ” å¼±ä¿¡å·ï¼Œå°ä»“ä½è¯•æ¢æˆ–è§‚æœ›")

    return strategy


def perform_td_analysis_enhanced(stock_code, stock_name, target_date):
    """å¢å¼ºç‰ˆTDæŠ€æœ¯åˆ†æï¼ˆä½¿ç”¨æ–°æ¥å£å’Œå‰å¤æƒæ•°æ®ï¼‰- å¹¶è¡Œä¼˜åŒ–ç‰ˆæœ¬"""
    try:
        end_date = target_date
        start_date = (pd.to_datetime(target_date) - timedelta(days=180)).strftime('%Y%m%d')

        # ä½¿ç”¨å¢å¼ºç‰ˆæ¥å£è·å–å‰å¤æƒæ•°æ®ï¼ˆåŒ…å«æƒ…ç»ªæŒ‡æ ‡ï¼‰
        hist_data = get_enhanced_stock_data_with_emotion(stock_code, start_date, end_date)

        if len(hist_data) == 0:
            return {
                'code': stock_code,
                'name': stock_name,
                'analysis': "æ— æ³•è·å–è‚¡ç¥¨æ•°æ®"
            }

        if len(hist_data) < 30:
            return {
                'code': stock_code,
                'name': stock_name,
                'analysis': "å†å²æ•°æ®ä¸è¶³ï¼Œæ— æ³•è¿›è¡Œå®Œæ•´åˆ†æ"
            }

        hist_data = hist_data.sort_values('trade_date')

        # è®¡ç®—å‡çº¿ï¼ˆä½¿ç”¨å‰å¤æƒæ•°æ®ï¼‰
        hist_data['ma5'] = hist_data['close_qfq'].rolling(window=5).mean()
        hist_data['ma10'] = hist_data['close_qfq'].rolling(window=10).mean()
        hist_data['ma20'] = hist_data['close_qfq'].rolling(window=20).mean()
        hist_data['ma60'] = hist_data['close_qfq'].rolling(window=60).mean()

        # è®¡ç®—ATR
        atr_value = calculate_atr(hist_data)

        # è®¡ç®—å¸‚åœºå¼ºåº¦
        market_strength = calculate_market_strength(hist_data)

        # è®¡ç®—å¢å¼ºç‰ˆTDåºåˆ—
        td_data = calculate_td_sequential_enhanced(hist_data)

        # è®¡ç®—å¢å¼ºç‰ˆæ”¯æ’‘é˜»åŠ›ä½
        sr_levels = calculate_support_resistance_enhanced(hist_data)

        # å¢å¼ºç‰ˆæˆäº¤é‡åˆ†æ
        volume_analysis = analyze_volume_pattern_enhanced(hist_data)

        # å››ç»´ç»“æ„åˆ†æ
        four_dimensional_analysis = calculate_four_dimensional_analysis(hist_data)

        # é¡¶åº•ç»“æ„åˆ†æ
        top_bottom_analysis = analyze_top_bottom_structure(hist_data)

        # ã€æ–°å¢ã€‘ä¸“ä¸šæƒ…ç»ªåˆ†æ
        emotion_analysis = calculate_emotion_analysis(hist_data)

        # ã€æ–°å¢ã€‘è®¡ç®—ç›®æ ‡æ—¥æœŸä¹‹å60ä¸ªäº¤æ˜“æ—¥å†…çš„æœ€å¤§ç›ˆåˆ©
        max_profit_result = calculate_max_profit_after_target_date(stock_code, target_date)

        # è·å–æœ€æ–°æ•°æ®
        latest = hist_data.iloc[-1]

        # å‡çº¿è¶‹åŠ¿åˆ†æï¼ˆä½¿ç”¨å‰å¤æƒæ•°æ®ï¼‰
        ma_trend = "å‡çº¿ç²˜åˆ"
        if pd.notna(latest['ma5']) and pd.notna(latest['ma10']) and pd.notna(latest['ma20']):
            if latest['ma5'] > latest['ma10'] > latest['ma20']:
                ma_trend = "å¤šå¤´æ’åˆ—"
            elif latest['ma5'] < latest['ma10'] < latest['ma20']:
                ma_trend = "ç©ºå¤´æ’åˆ—"

        # TDåºåˆ—è¯¦ç»†åˆ†æ
        td_setup_current = td_data.iloc[-1]['td_setup']
        td_countdown_current = td_data.iloc[-1]['td_countdown']
        td_perfected_current = td_data.iloc[-1]['td_perfected']
        td_combo_current = td_data.iloc[-1]['td_combo']
        td_risk_current = td_data.iloc[-1]['td_risk_level']
        td_sequential_13 = td_data.iloc[-1]['td_sequential_13']
        td_pressure = td_data.iloc[-1]['td_pressure']
        td_momentum = td_data.iloc[-1]['td_momentum']
        tdst_support = td_data.iloc[-1]['tdst_support']
        tdst_resistance = td_data.iloc[-1]['tdst_resistance']

        # TDå†å²ç»Ÿè®¡
        td_stats = {
            'setup_9_count': len(td_data[abs(td_data['td_setup']) == 9]),
            'perfected_count': len(td_data[td_data['td_perfected'] == True]),
            'countdown_13_count': len(td_data[abs(td_data['td_countdown']) == 13]),
            'sequential_13_count': len(td_data[td_data['td_sequential_13'] == True]),
            'combo_13_count': len(td_data[abs(td_data['td_combo']) == 13]),
            'current_phase': "æ— æ˜æ˜¾ä¿¡å·"
        }

        # åˆ¤æ–­å½“å‰TDé˜¶æ®µ
        phase_parts = []
        if abs(td_setup_current) >= 1:
            if abs(td_setup_current) <= 3:
                phase_parts.append(f"SetupåˆæœŸ({abs(td_setup_current)}/9)")
            elif abs(td_setup_current) <= 6:
                phase_parts.append(f"Setupä¸­æœŸ({abs(td_setup_current)}/9)")
            elif abs(td_setup_current) <= 8:
                phase_parts.append(f"SetupåæœŸ({abs(td_setup_current)}/9)")
            elif abs(td_setup_current) == 9:
                phase_parts.append("Setupå®Œæˆï¼")

        if abs(td_countdown_current) > 0:
            phase_parts.append(f"Countdownè¿›è¡Œä¸­({abs(td_countdown_current)}/13)")

        if abs(td_combo_current) > 0:
            phase_parts.append(f"Comboè®¡æ•°({abs(td_combo_current)}/13)")

        td_stats['current_phase'] = " + ".join(phase_parts) if phase_parts else "æ— æ˜æ˜¾ä¿¡å·"

        # å¢å¼ºç‰ˆå½¢æ€åˆ†æ
        pattern = analyze_pattern_enhanced(hist_data)

        # ç”Ÿæˆå¢å¼ºç‰ˆTDäº¤æ˜“ç­–ç•¥
        td_strategy = generate_enhanced_td_strategy(
            latest, sr_levels, td_setup_current, td_countdown_current,
            td_perfected_current, td_combo_current, tdst_support, tdst_resistance,
            ma_trend, volume_analysis, market_strength, atr_value
        )

        # è®¡ç®—ä¿¡å·è¯„åˆ†ï¼ˆç”¨äºæ’åºï¼‰
        signal_score = 0
        if abs(td_setup_current) == 9:
            signal_score += 35
        elif abs(td_setup_current) >= 7:
            signal_score += 20
        elif abs(td_setup_current) >= 4:
            signal_score += 12
        elif abs(td_setup_current) >= 1:
            signal_score += 5

        if abs(td_countdown_current) == 13:
            signal_score += 45
        elif abs(td_countdown_current) >= 10:
            signal_score += 30
        elif abs(td_countdown_current) >= 7:
            signal_score += 20
        elif abs(td_countdown_current) >= 3:
            signal_score += 10

        if abs(td_combo_current) >= 10:
            signal_score += 18
        elif abs(td_combo_current) >= 5:
            signal_score += 8

        if td_perfected_current:
            signal_score += 20

        if volume_analysis['volume_surge']:
            signal_score += 18
        elif volume_analysis['volume_ratio'] > 1.5:
            signal_score += 12
        elif volume_analysis['volume_ratio'] > 1.2:
            signal_score += 8

        if ma_trend == "å¤šå¤´æ’åˆ—":
            signal_score += 12
        elif ma_trend == "ç©ºå¤´æ’åˆ—":
            signal_score -= 8

        # ç”Ÿæˆç»¼åˆåˆ†æ
        analysis = {
            'code': stock_code,
            'name': stock_name,
            'current_price': latest['close_qfq'],  # ä½¿ç”¨å‰å¤æƒä»·æ ¼
            'ma_trend': ma_trend,
            'td_setup': td_setup_current,
            'td_countdown': td_countdown_current,
            'td_perfected': td_perfected_current,
            'td_combo': td_combo_current,
            'td_risk_level': td_risk_current,
            'td_pressure': td_pressure,
            'td_momentum': td_momentum,
            'td_phase': td_stats['current_phase'],
            'td_signal_grade': td_strategy['signal_strength'],
            'td_score': signal_score,
            'confidence': td_strategy['confidence'],
            'reversal_probability': td_strategy['confidence'],
            'tdst_levels': f"æ”¯æ’‘: {tdst_support:.2f}, é˜»åŠ›: {tdst_resistance:.2f}" if tdst_support > 0 or tdst_resistance > 0 else "æš‚æ— TDSTä½",
            'support_levels': f"S1: {sr_levels['support1']:.2f}, S2: {sr_levels['support2']:.2f}",
            'resistance_levels': f"R1: {sr_levels['resistance1']:.2f}, R2: {sr_levels['resistance2']:.2f}",
            'pivot': f"{sr_levels['pivot']:.2f}",
            'volume_analysis': volume_analysis,
            'pattern': pattern,
            'td_stats': td_stats,
            'td_strategy': td_strategy,
            'market_strength': market_strength,
            'atr_value': atr_value,
            'four_dimensional_analysis': four_dimensional_analysis,
            'top_bottom_analysis': top_bottom_analysis,
            'hist_data': hist_data,  # æ·»åŠ å†å²æ•°æ®
            'td_data': td_data,  # æ·»åŠ TDæ•°æ®
            # ã€æ–°å¢ã€‘60æ—¥æœ€å¤§ç›ˆåˆ©æ•°æ®
            'max_profit_pct': max_profit_result['max_profit_pct'],
            'max_profit_days': max_profit_result['max_profit_days'],
            'max_profit_status': max_profit_result['status'],
            'max_profit_status': max_profit_result['status'],
            # ã€æ–°å¢ã€‘æƒ…ç»ªåˆ†ææ•°æ®
            'emotion_analysis': emotion_analysis
        }

        return analysis

    except Exception as e:
        return {
            'code': stock_code,
            'name': stock_name,
            'analysis': f"TDåˆ†æè¿‡ç¨‹å‡ºé”™: {str(e)}"
        }


def draw_td_chart(hist_data, td_data, analysis, save_path=None):
    """
    ç»˜åˆ¶TDæŠ€æœ¯åˆ†æå›¾è¡¨ï¼ˆä½¿ç”¨å‰å¤æƒæ•°æ®ï¼‰
    """
    try:
        # ç¡®ä¿ä½¿ç”¨éäº¤äº’å¼åç«¯
        import matplotlib
        matplotlib.use('Agg')

        # å‡†å¤‡æ•°æ®
        df = td_data.copy().sort_values('trade_date')
        df['trade_date'] = pd.to_datetime(df['trade_date'])

        # åªæ˜¾ç¤ºæœ€è¿‘60ä¸ªäº¤æ˜“æ—¥
        df = df.tail(60)

        if len(df) < 10:
            print(f"æ•°æ®ä¸è¶³ï¼Œæ— æ³•ç»˜åˆ¶å›¾è¡¨")
            return None

        # åˆ›å»ºå›¾è¡¨æ—¶æ˜ç¡®æŒ‡å®šå›¾å½¢å¯¹è±¡
        plt.ioff()  # å…³é—­äº¤äº’æ¨¡å¼
        fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(16, 12), gridspec_kw={'height_ratios': [3, 1]})
        fig.suptitle(f'{analysis["name"]} ({analysis["code"]}) - TDåºåˆ—æŠ€æœ¯åˆ†æå›¾è¡¨(å‰å¤æƒ)',
                     fontsize=16, fontweight='bold', y=0.95)

        # ä¸»å›¾ï¼šKçº¿å›¾å’ŒTDæ ‡æ³¨ï¼ˆä½¿ç”¨å‰å¤æƒæ•°æ®ï¼‰
        ax1.set_title(
            f'ä»·æ ¼: Â¥{analysis["current_price"]:.2f}(å‰å¤æƒ) | TD Setup: {analysis["td_setup"]} | TD Countdown: {analysis["td_countdown"]} | ä¿¡å·: {analysis["td_signal_grade"]}',
            fontsize=12, pad=20)

        # ç»˜åˆ¶Kçº¿ï¼ˆä½¿ç”¨å‰å¤æƒæ•°æ®ï¼‰
        for i in range(len(df)):
            row = df.iloc[i]
            date = row['trade_date']
            open_price = row['open_qfq']
            high_price = row['high_qfq']
            low_price = row['low_qfq']
            close_price = row['close_qfq']

            # Kçº¿é¢œè‰²
            color = 'red' if close_price >= open_price else 'green'

            # ç»˜åˆ¶ä¸Šä¸‹å½±çº¿
            ax1.plot([date, date], [low_price, high_price], color='black', linewidth=1)

            # ç»˜åˆ¶å®ä½“
            body_height = abs(close_price - open_price)
            body_bottom = min(open_price, close_price)

            if close_price >= open_price:
                # é˜³çº¿
                rect = Rectangle((mdates.date2num(date) - 0.3, body_bottom), 0.6, body_height,
                                 facecolor='red', edgecolor='black', linewidth=0.5)
            else:
                # é˜´çº¿
                rect = Rectangle((mdates.date2num(date) - 0.3, body_bottom), 0.6, body_height,
                                 facecolor='green', edgecolor='black', linewidth=0.5)

            ax1.add_patch(rect)

        # ç»˜åˆ¶å‡çº¿ï¼ˆä½¿ç”¨å‰å¤æƒæ•°æ®ï¼‰
        if 'ma5' in df.columns:
            ax1.plot(df['trade_date'], df['ma5'], label='MA5', color='purple', linewidth=1, alpha=0.8)
        if 'ma10' in df.columns:
            ax1.plot(df['trade_date'], df['ma10'], label='MA10', color='orange', linewidth=1, alpha=0.8)
        if 'ma20' in df.columns:
            ax1.plot(df['trade_date'], df['ma20'], label='MA20', color='blue', linewidth=2, alpha=0.8)

        # æ ‡æ³¨TD Setupåºå·
        for i in range(len(df)):
            row = df.iloc[i]
            setup_value = row['td_setup']

            if setup_value != 0:
                date = row['trade_date']
                high_price = row['high_qfq']
                low_price = row['low_qfq']

                # ç¡®å®šæ ‡æ³¨ä½ç½®
                if setup_value > 0:  # ä¹°å…¥Setup
                    y_pos = low_price * 0.995
                    color = 'blue'
                    marker = 'o'
                else:  # å–å‡ºSetup
                    y_pos = high_price * 1.005
                    color = 'red'
                    marker = 'v'

                # ç»˜åˆ¶Setupåºå·
                ax1.scatter(date, y_pos, c=color, s=100, marker=marker, alpha=0.8, edgecolors='white', linewidths=1)
                ax1.annotate(f'{abs(setup_value)}', (date, y_pos),
                             textcoords="offset points", xytext=(0, -15 if setup_value > 0 else 15),
                             ha='center', va='center', fontsize=8, fontweight='bold', color='white',
                             bbox=dict(boxstyle="round,pad=0.3", facecolor=color, alpha=0.8))

                # Setup 9ç‰¹æ®Šæ ‡è®°
                if abs(setup_value) == 9:
                    ax1.annotate('Setup 9!', (date, y_pos),
                                 textcoords="offset points", xytext=(20, -30 if setup_value > 0 else 30),
                                 ha='center', va='center', fontsize=10, fontweight='bold', color=color,
                                 bbox=dict(boxstyle="round,pad=0.5", facecolor='yellow', alpha=0.8),
                                 arrowprops=dict(arrowstyle='->', color=color, lw=1.5))

        # æ ‡æ³¨TD Countdownåºå·
        for i in range(len(df)):
            row = df.iloc[i]
            countdown_value = row['td_countdown']

            if countdown_value != 0:
                date = row['trade_date']
                high_price = row['high_qfq']
                low_price = row['low_qfq']

                # ç¡®å®šæ ‡æ³¨ä½ç½®
                if countdown_value > 0:  # ä¹°å…¥Countdown
                    y_pos = low_price * 0.99
                    color = 'darkblue'
                    marker = 's'
                else:  # å–å‡ºCountdown
                    y_pos = high_price * 1.01
                    color = 'darkred'
                    marker = 's'

                # ç»˜åˆ¶Countdownåºå·
                ax1.scatter(date, y_pos, c=color, s=120, marker=marker, alpha=0.9, edgecolors='white', linewidths=2)
                ax1.annotate(f'C{abs(countdown_value)}', (date, y_pos),
                             textcoords="offset points", xytext=(0, 0),
                             ha='center', va='center', fontsize=7, fontweight='bold', color='white')

                # Countdown 13ç‰¹æ®Šæ ‡è®°
                if abs(countdown_value) == 13:
                    ax1.annotate('Countdown 13!', (date, y_pos),
                                 textcoords="offset points", xytext=(-30, -40 if countdown_value > 0 else 40),
                                 ha='center', va='center', fontsize=11, fontweight='bold', color=color,
                                 bbox=dict(boxstyle="round,pad=0.5", facecolor='gold', alpha=0.9),
                                 arrowprops=dict(arrowstyle='->', color=color, lw=2))

        # æ ‡æ³¨å®Œç¾è®¾ç½®
        for i in range(len(df)):
            row = df.iloc[i]
            if row['td_perfected']:
                date = row['trade_date']
                high_price = row['high_qfq']
                ax1.annotate('â˜… å®Œç¾è®¾ç½®', (date, high_price),
                             textcoords="offset points", xytext=(10, 20),
                             ha='center', va='center', fontsize=9, fontweight='bold', color='gold',
                             bbox=dict(boxstyle="round,pad=0.3", facecolor='purple', alpha=0.8),
                             arrowprops=dict(arrowstyle='->', color='purple', lw=1.5))

        # ç»˜åˆ¶TDSTæ”¯æ’‘é˜»åŠ›çº¿
        latest_data = df.iloc[-1]
        if latest_data['tdst_support'] > 0:
            ax1.axhline(y=latest_data['tdst_support'], color='green', linestyle='--', linewidth=2, alpha=0.7,
                        label='TDSTæ”¯æ’‘')
        if latest_data['tdst_resistance'] > 0:
            ax1.axhline(y=latest_data['tdst_resistance'], color='red', linestyle='--', linewidth=2, alpha=0.7,
                        label='TDSTé˜»åŠ›')

        # ç»˜åˆ¶å…³é”®æ”¯æ’‘é˜»åŠ›ä½
        support1 = float(analysis['support_levels'].split('S1: ')[1].split(',')[0])
        resistance1 = float(analysis['resistance_levels'].split('R1: ')[1].split(',')[0])

        ax1.axhline(y=support1, color='blue', linestyle=':', linewidth=1.5, alpha=0.6, label='æŠ€æœ¯æ”¯æ’‘')
        ax1.axhline(y=resistance1, color='red', linestyle=':', linewidth=1.5, alpha=0.6, label='æŠ€æœ¯é˜»åŠ›')

        # è®¾ç½®ä¸»å›¾æ ·å¼
        ax1.set_ylabel('ä»·æ ¼ (Â¥,å‰å¤æƒ)', fontsize=12)
        ax1.legend(loc='upper left', fontsize=10)
        ax1.grid(True, alpha=0.3)
        ax1.xaxis.set_major_formatter(mdates.DateFormatter('%m-%d'))
        ax1.xaxis.set_major_locator(mdates.DayLocator(interval=5))

        # æˆäº¤é‡å›¾
        ax2.bar(df['trade_date'], df['vol'] / 10000, width=0.8,
                color=['red' if c >= o else 'green' for c, o in zip(df['close_qfq'], df['open_qfq'])],
                alpha=0.6, label='æˆäº¤é‡(ä¸‡æ‰‹)')

        # æ ‡æ³¨æ”¾é‡ç‚¹
        volume_avg = df['vol'].rolling(window=10).mean()
        for i in range(len(df)):
            if df.iloc[i]['vol'] > volume_avg.iloc[i] * 2:  # æ”¾é‡2å€ä»¥ä¸Š
                ax2.annotate('æ”¾é‡', (df.iloc[i]['trade_date'], df.iloc[i]['vol'] / 10000),
                             textcoords="offset points", xytext=(0, 10),
                             ha='center', va='bottom', fontsize=8, color='red', fontweight='bold')

        ax2.set_ylabel('æˆäº¤é‡ (ä¸‡æ‰‹)', fontsize=12)
        ax2.set_xlabel('æ—¥æœŸ', fontsize=12)
        ax2.legend(loc='upper left', fontsize=10)
        ax2.grid(True, alpha=0.3)
        ax2.xaxis.set_major_formatter(mdates.DateFormatter('%m-%d'))
        ax2.xaxis.set_major_locator(mdates.DayLocator(interval=5))

        # æ·»åŠ åˆ†æä¿¡æ¯æ–‡æœ¬æ¡†
        info_text = f"""TDåˆ†æä¿¡æ¯(å‰å¤æƒ):
â€¢ å½“å‰é˜¶æ®µ: {analysis['td_phase']}
â€¢ é£é™©ç­‰çº§: {analysis['td_risk_level']} (-5åˆ°+5)
â€¢ ä¿¡å·è¯„åˆ†: {analysis['td_score']}åˆ†
â€¢ åè½¬æ¦‚ç‡: {analysis['reversal_probability']:.1f}%
â€¢ æ“ä½œå»ºè®®: {analysis['td_strategy']['direction']}
â€¢ å»ºè®®ä»“ä½: {analysis['td_strategy']['position_size']}"""

        ax1.text(0.02, 0.98, info_text, transform=ax1.transAxes, fontsize=10,
                 verticalalignment='top', bbox=dict(boxstyle='round', facecolor='lightblue', alpha=0.8))

        # è°ƒæ•´å¸ƒå±€
        plt.tight_layout()

        # ä¿å­˜å›¾è¡¨
        if save_path:
            plt.savefig(save_path, dpi=300, bbox_inches='tight', facecolor='white')

        # å…³é—­å›¾è¡¨å¹¶æ¸…ç†èµ„æº
        plt.close(fig)
        plt.clf()  # æ¸…ç†å½“å‰å›¾å½¢

        return save_path

    except Exception as e:
        print(f"ç»˜åˆ¶å›¾è¡¨æ—¶å‡ºé”™: {e}")
        # ç¡®ä¿èµ„æºæ¸…ç†
        try:
            plt.close('all')
            plt.clf()
        except:
            pass
        return None


def analyze_stocks_parallel(stock_data, target_date, max_workers=4):
    """å¹¶è¡Œåˆ†æè‚¡ç¥¨ - ä¼˜åŒ–ç‰ˆæœ¬"""
    # è®¾ç½®matplotlibåç«¯
    import matplotlib
    matplotlib.use('Agg')

    analyses = []

    # ... å…¶ä½™ä»£ç ä¿æŒä¸å˜ ...

    def analyze_single_stock(stock_info):
        idx, stock = stock_info
        return perform_td_analysis_enhanced(stock['ts_code'], stock['name'], target_date)

    # ä½¿ç”¨çº¿ç¨‹æ± å¹¶è¡Œå¤„ç†
    with ThreadPoolExecutor(max_workers=max_workers) as executor:
        # æäº¤æ‰€æœ‰ä»»åŠ¡
        futures = [
            executor.submit(analyze_single_stock, (idx, stock))
            for idx, stock in stock_data.iterrows()
        ]

        # æ”¶é›†ç»“æœ
        for idx, future in enumerate(as_completed(futures), 1):
            try:
                result = future.result()
                analyses.append(result)
                print(f"ğŸ“Š åˆ†æè¿›åº¦: {idx}/{len(stock_data)} - {result.get('name', 'æœªçŸ¥è‚¡ç¥¨')}")
            except Exception as e:
                print(f"åˆ†æè‚¡ç¥¨æ—¶å‡ºé”™: {e}")
                continue

    return analyses


def create_td_charts_for_focus_stocks(analyses, target_date):
    """ä¸ºé‡ç‚¹å…³æ³¨è‚¡ç¥¨åˆ›å»ºTDå›¾è¡¨"""
    # è®¾ç½®matplotlibåç«¯
    import matplotlib
    matplotlib.use('Agg')
    plt.ioff()  # å…³é—­äº¤äº’æ¨¡å¼

    # åˆ›å»ºå›¾è¡¨ä¿å­˜ç›®å½•
    chart_dir = f"td_charts_{target_date}_{datetime.now().strftime('%H%M%S')}"
    if not os.path.exists(chart_dir):
        os.makedirs(chart_dir)

    print(f"\nğŸ“Š å¼€å§‹ä¸ºé‡ç‚¹å…³æ³¨è‚¡ç¥¨ç”ŸæˆTDå›¾è¡¨(å‰å¤æƒæ•°æ®)...")

    # ç­›é€‰é‡ç‚¹å…³æ³¨è‚¡ç¥¨
    focus_stocks = []
    for analysis in analyses:
        if 'analysis' in analysis and isinstance(analysis['analysis'], str):
            continue

        score = analysis.get('td_score', 0)
        countdown = abs(analysis.get('td_countdown', 0))
        confidence = analysis.get('confidence', 0)

        # ç­›é€‰æ ‡å‡†ï¼šè¯„åˆ†â‰¥25åˆ† OR Countdownâ‰¥8 OR ä¿¡å¿ƒåº¦â‰¥50%
        if score >= 25 or countdown >= 8 or confidence >= 50:
            focus_stocks.append(analysis)

    # æŒ‰è¯„åˆ†æ’åºï¼Œå–å‰10åª
    focus_stocks.sort(key=lambda x: x.get('td_score', 0), reverse=True)
    focus_stocks = focus_stocks[:10]

    print(f"ğŸ¯ ç­›é€‰å‡º {len(focus_stocks)} åªé‡ç‚¹å…³æ³¨è‚¡ç¥¨è¿›è¡Œå›¾è¡¨ç»˜åˆ¶")

    chart_files = []

    for i, analysis in enumerate(focus_stocks, 1):
        try:
            print(f"ğŸ“ˆ æ­£åœ¨ç»˜åˆ¶ {i}/{len(focus_stocks)}: {analysis['name']}")

            # ä½¿ç”¨å·²æœ‰çš„å†å²æ•°æ®å’ŒTDæ•°æ®
            hist_data = analysis.get('hist_data')
            td_data = analysis.get('td_data')

            if hist_data is None or td_data is None:
                print(f"âš ï¸ {analysis['name']} ç¼ºå°‘å›¾è¡¨æ•°æ®ï¼Œè·³è¿‡...")
                continue

            # ç”Ÿæˆå®‰å…¨çš„å›¾è¡¨æ–‡ä»¶å
            safe_name = analysis['name'].replace('/', '_').replace('\\', '_').replace('*', '_').replace('?',
                                                                                                        '_').replace(
                ':', '_').replace('|', '_').replace('<', '_').replace('>', '_').replace('"', '_')
            chart_filename = f"{safe_name}_{analysis['code'].replace('.', '_')}_td_chart.png"
            chart_path = os.path.join(chart_dir, chart_filename)

            # ç»˜åˆ¶å›¾è¡¨ - æ·»åŠ å¼‚å¸¸å¤„ç†
            try:
                saved_path = draw_td_chart(hist_data, td_data, analysis, chart_path)

                if saved_path:
                    chart_files.append({
                        'analysis': analysis,
                        'chart_path': saved_path,
                        'chart_filename': chart_filename,
                        'chart_dir': chart_dir
                    })

            except Exception as draw_error:
                print(f"âš ï¸ ç»˜åˆ¶ {analysis['name']} å›¾è¡¨å¤±è´¥: {draw_error}")
                continue

        except Exception as e:
            print(f"âŒ å¤„ç† {analysis['name']} æ—¶å‡ºé”™: {e}")
            continue

        print(f"âœ… æˆåŠŸç”Ÿæˆ {len(chart_files)} ä¸ªTDå›¾è¡¨(å‰å¤æƒ)")
        return chart_files, chart_dir


def generate_html_report(analyses, target_date, chart_files=None):
    """ç”ŸæˆHTMLå¯è§†åŒ–æŠ¥å‘Šï¼ˆå‰å¤æƒæ•°æ®ç‰ˆæœ¬ï¼‰"""
    # ç»Ÿè®¡æ•°æ®
    total_stocks = len(analyses)
    valid_analyses = [a for a in analyses if 'analysis' not in a or not isinstance(a.get('analysis'), str)]

    # é‡ç‚¹å…³æ³¨è‚¡ç¥¨ï¼ˆä¼˜åŒ–åæ ‡å‡†ï¼‰
    focus_stocks = []
    for analysis in valid_analyses:
        score = analysis.get('td_score', 0)
        countdown = abs(analysis.get('td_countdown', 0))
        confidence = analysis.get('confidence', 0)

        # æ›´çµæ´»çš„ç­›é€‰æ ‡å‡†
        if (score >= 20 or countdown >= 8 or confidence >= 45 or
                analysis.get('td_signal_grade', '').startswith('B') or
                analysis.get('td_signal_grade', '').startswith('A') or
                analysis.get('td_signal_grade', '').startswith('S')):
            focus_stocks.append(analysis)

    # æŒ‰ç»¼åˆå¾—åˆ†æ’åº
    focus_stocks.sort(key=lambda x: x.get('td_score', 0), reverse=True)

    # ä¿¡å·ç­‰çº§ç»Ÿè®¡
    signal_grades = {}
    for analysis in valid_analyses:
        grade = analysis.get('td_signal_grade', 'Cçº§ï¼ˆå¼±ï¼‰').split('çº§')[0]
        signal_grades[grade] = signal_grades.get(grade, 0) + 1

    # Setupé˜¶æ®µç»Ÿè®¡
    setup_stats = {'åˆæœŸ': 0, 'ä¸­æœŸ': 0, 'åæœŸ': 0, 'å®Œæˆ': 0}
    countdown_active = 0

    for analysis in valid_analyses:
        setup = abs(analysis.get('td_setup', 0))
        countdown = abs(analysis.get('td_countdown', 0))

        if setup >= 1 and setup <= 3:
            setup_stats['åˆæœŸ'] += 1
        elif setup >= 4 and setup <= 6:
            setup_stats['ä¸­æœŸ'] += 1
        elif setup >= 7 and setup <= 8:
            setup_stats['åæœŸ'] += 1
        elif setup == 9:
            setup_stats['å®Œæˆ'] += 1

        if countdown > 0:
            countdown_active += 1

    avg_price = sum(a.get('current_price', 0) for a in valid_analyses) / len(valid_analyses) if valid_analyses else 0

    # åˆ›å»ºå›¾è¡¨ä»£ç æ˜ å°„
    chart_map = {}
    chart_dir_name = ""
    if chart_files:
        chart_dir_name = chart_files[0]['chart_dir']
        for chart_info in chart_files:
            chart_map[chart_info['analysis']['code']] = f"{chart_dir_name}/{chart_info['chart_filename']}"

    html_content = f"""
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢å¼ºç‰ˆTDè‚¡ç¥¨ç­›é€‰åˆ†ææŠ¥å‘Š - {target_date}</title>
    <link rel="stylesheet" href="professional_styles.css">
    <script src="professional_scripts.js"></script>
    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}

        body {{
            font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }}

        .container {{
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }}

        .header {{
            text-align: center;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }}

        .header h1 {{
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }}

        .stats-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }}

        .stat-card {{
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transform: translateY(0);
            transition: transform 0.3s ease;
        }}

        .stat-card:hover {{
            transform: translateY(-5px);
        }}

        .stat-number {{
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }}

        .stat-label {{
            font-size: 1rem;
            opacity: 0.9;
        }}

        .focus-section {{
            margin-bottom: 40px;
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            padding: 30px;
            border-radius: 15px;
            color: white;
        }}

        .focus-title {{
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }}

        .focus-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }}

        .focus-card {{
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }}

        /* æ–°å¢ï¼šè‚¡ç¥¨åç§°å’Œä»£ç çš„ç‚¹å‡»æ ·å¼ */
        .stock-link {{
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: inline-block;
        }}

        .stock-link:hover {{
            color: #ff4757;
            text-decoration: underline;
            transform: translateY(-1px);
        }}

        .stock-link::after {{
            content: 'ğŸ”—';
            opacity: 0;
            margin-left: 5px;
            transition: opacity 0.3s ease;
            font-size: 0.8em;
        }}

        .stock-link:hover::after {{
            opacity: 1;
        }}

        /* é›ªçƒè·³è½¬æç¤º */
        .xueqiu-tooltip {{
            position: relative;
            display: inline-block;
        }}

        .xueqiu-tooltip .tooltiptext {{
            visibility: hidden;
            width: 160px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -80px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }}

        .xueqiu-tooltip .tooltiptext::after {{
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }}

        .xueqiu-tooltip:hover .tooltiptext {{
            visibility: visible;
            opacity: 1;
        }}

        /* ä¼˜åŒ–çš„æ™ºèƒ½æ’åºæ§åˆ¶åŒºåŸŸ */
        .sort-controls {{
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            color: white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }}

        .sort-title {{
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }}

        .sort-subtitle {{
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1rem;
            opacity: 0.9;
        }}

        .sort-buttons {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }}

        .sort-button {{
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }}

        .sort-button::before {{
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }}

        .sort-button:hover {{
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }}

        .sort-button:hover::before {{
            left: 100%;
        }}

        .sort-button.active {{
            background: rgba(255, 255, 255, 0.9);
            color: #4facfe;
            border-color: white;
            font-weight: 700;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
            transform: translateY(-3px);
        }}

        .sort-button .icon {{
            margin-right: 8px;
            font-size: 16px;
        }}

        .sort-button .arrow {{
            margin-left: 8px;
            font-size: 16px;
            transition: transform 0.3s ease;
        }}

        .sort-button.active .arrow {{
            animation: bounce 1s infinite;
        }}

        @keyframes bounce {{
            0%, 50%, 100% {{ transform: translateY(0); }}
            25% {{ transform: translateY(-3px); }}
            75% {{ transform: translateY(3px); }}
        }}

        .sort-status {{
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }}

        .sort-status .status-icon {{
            font-size: 18px;
            margin-right: 8px;
        }}

        .stock-table {{
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }}

        .table-header {{
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }}

        table {{
            width: 100%;
            border-collapse: collapse;
        }}

        th, td {{
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }}

        th {{
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }}

        /* ä¼˜åŒ–åçš„è‚¡ç¥¨è¡Œæ ·å¼ */
        .stock-row {{
            transition: all 0.3s ease;
            cursor: pointer;
        }}

        .stock-row:hover {{
            background: #f8f9fa;
            transform: translateX(5px);
        }}

        .stock-row.expanded {{
            background: #e3f2fd;
            font-weight: 600;
        }}

        /* æ–°å¢ï¼šè¯¦æƒ…è¡Œæ ·å¼ */
        .detail-row {{
            display: none;
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            animation: slideDown 0.5s ease-out;
        }}

        .detail-row.show {{
            display: table-row;
        }}

        .detail-content {{
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            margin: 20px;
            position: relative;
        }}

        @keyframes slideDown {{
            from {{
                opacity: 0;
                transform: translateY(-20px);
            }}
            to {{
                opacity: 1;
                transform: translateY(0);
            }}
        }}

        .detail-header {{
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }}

        .close-btn {{
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }}

        .close-btn:hover {{
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }}

        .analysis-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }}

        .analysis-card {{
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }}

        .analysis-card:hover {{
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.15);
        }}

        .analysis-card h3 {{
            color: #fff;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 8px;
        }}

        .analysis-card p {{
            margin-bottom: 8px;
            line-height: 1.5;
        }}

        .chart-section {{
            margin: 20px 0;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }}

        .chart-image {{
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            margin: 10px 0;
        }}

        .signal-badge {{
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
            text-align: center;
            min-width: 80px;
        }}

        .signal-s {{ 
            background: linear-gradient(135deg, #ff4757, #ff3742); 
            color: white; 
            box-shadow: 0 2px 10px rgba(255, 71, 87, 0.3);
        }}
        .signal-a {{ 
            background: linear-gradient(135deg, #ff7f50, #ff6348); 
            color: white; 
            box-shadow: 0 2px 10px rgba(255, 127, 80, 0.3);
        }}
        .signal-b {{ 
            background: linear-gradient(135deg, #ffa502, #ff9500); 
            color: white; 
            box-shadow: 0 2px 10px rgba(255, 165, 2, 0.3);
        }}
        .signal-c {{ 
            background: linear-gradient(135deg, #a4b0be, #9c88a4); 
            color: white; 
            box-shadow: 0 2px 10px rgba(164, 176, 190, 0.3);
        }}

        .probability-bar {{
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }}

        .probability-fill {{
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
        }}

        .action-button {{
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 2px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }}

        .action-button::before {{
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }}

        .action-button:hover {{
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }}

        .action-button:hover::before {{
            left: 100%;
        }}

        .action-button.active {{
            background: linear-gradient(135deg, #ff4757, #ff3742);
        }}

        .footer {{
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-top: 40px;
        }}

        .search-box {{
            margin-bottom: 20px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            width: 100%;
            max-width: 400px;
            transition: border-color 0.3s ease;
        }}

        .search-box:focus {{
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }}

        .back-to-top {{
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: all 0.3s ease;
            display: none;
        }}

        .back-to-top:hover {{
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }}

        /* å››ç»´ç»“æ„åˆ†æä¸“ç”¨æ ·å¼ */
        .four-dimensional-section {{
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            backdrop-filter: blur(10px);
        }}

        .dimension-card {{
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }}

        .structure-badge {{
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            margin: 5px;
            display: inline-block;
        }}

        .structure-strong {{ background: #28a745; color: white; }}
        .structure-medium {{ background: #ffc107; color: black; }}
        .structure-weak {{ background: #dc3545; color: white; }}

        .level-indicator {{
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin: 2px;
        }}

        .level-high {{ background: #ff4757; color: white; }}
        .level-medium {{ background: #ffa502; color: white; }}
        .level-low {{ background: #a4b0be; color: white; }}

        /* æ»šåŠ¨åŠ¨ç”» */
        .highlight-section {{
            border: 3px solid #667eea;
            border-radius: 15px;
            animation: highlightBorder 2s ease-in-out;
        }}

        @keyframes highlightBorder {{
            0% {{ border-color: #667eea; }}
            50% {{ border-color: #ff4757; }}
            100% {{ border-color: #667eea; }}
        }}

        /* æ’åºè¿‡æ¸¡åŠ¨ç”» */
        .table-row-transition {{
            transition: all 0.5s ease;
        }}

        .sorting-indicator {{
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            z-index: 9999;
            display: none;
        }}

        /* ã€æ–°å¢ã€‘60æ—¥æœ€å¤§ç›ˆåˆ©ç›¸å…³æ ·å¼ */
        .profit-badge {{
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 2px;
            display: inline-block;
        }}

        .profit-high {{ background: #28a745; color: white; }}
        .profit-medium {{ background: #ffc107; color: black; }}
        .profit-low {{ background: #dc3545; color: white; }}
        .profit-none {{ background: #6c757d; color: white; }}

        /* æƒ…ç»ªåˆ†æç›¸å…³æ ·å¼ */
        .emotion-badge {{
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 2px;
            display: inline-block;
        }}

        .emotion-ä¹è§‚ {{ background: #28a745; color: white; }}
        .emotion-æ‚²è§‚ {{ background: #dc3545; color: white; }}
        .emotion-ä¸­æ€§ {{ background: #6c757d; color: white; }}
        .emotion-ç§¯æ {{ background: #20c997; color: white; }}
        .emotion-æ¶ˆæ {{ background: #e83e8c; color: white; }}

        .emotion-section {{
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            backdrop-filter: blur(10px);
        }}

        .emotion-positive {{ background: #28a745; color: white; }}
        .emotion-negative {{ background: #dc3545; color: white; }}
        .emotion-neutral {{ background: #6c757d; color: white; }}

        /* æ€»å¸‚å€¼æ ‡è¯†æ ·å¼ */
        .market-cap-badge {{
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
            text-align: center;
            min-width: 60px;
        }}

        .market-cap-huge {{
            background-color: #7c3aed;
            color: white;
        }}

        .market-cap-large {{
            background-color: #2563eb;
            color: white;
        }}

        .market-cap-medium {{
            background-color: #059669;
            color: white;
        }}

        .market-cap-small {{
            background-color: #dc2626;
            color: white;
        }}

        .market-cap-micro {{
            background-color: #9ca3af;
            color: white;
        }}

        .market-cap-unknown {{
            background-color: #6b7280;
            color: #f3f4f6;
        }}

        @media (max-width: 768px) {{
            .container {{
                padding: 15px;
                margin: 10px;
            }}

            .header h1 {{
                font-size: 2rem;
            }}

            .stats-grid {{
                grid-template-columns: 1fr;
            }}

            .sort-buttons {{
                grid-template-columns: 1fr;
            }}

            table {{
                font-size: 0.9rem;
            }}

            th, td {{
                padding: 10px 8px;
            }}

            .analysis-grid {{
                grid-template-columns: 1fr;
            }}

            .detail-content {{
                margin: 10px;
                padding: 20px;
            }}

            .back-to-top {{
                bottom: 20px;
                right: 20px;
                padding: 12px;
                font-size: 16px;
            }}
        }}
    </style>
    <script>
        // å…¨å±€å˜é‡
        let currentSortField = 'market_cap';
        let currentSortDirection = 'asc';
        let originalOrder = [];
        let sortingInProgress = false;
        let activeDetailRow = null;

        // æ–°å¢ï¼šé›ªçƒè·³è½¬åŠŸèƒ½
        function openXueqiu(stockCode) {{
            try {{
                // è½¬æ¢è‚¡ç¥¨ä»£ç æ ¼å¼ï¼šä» "002413.SZ" è½¬æ¢ä¸º "SZ002413"
                let xueqiuCode = '';

                if (stockCode.endsWith('.SZ')) {{
                    // æ·±äº¤æ‰€è‚¡ç¥¨
                    xueqiuCode = 'SZ' + stockCode.replace('.SZ', '');
                }} else if (stockCode.endsWith('.SH')) {{
                    // ä¸Šäº¤æ‰€è‚¡ç¥¨
                    xueqiuCode = 'SH' + stockCode.replace('.SH', '');
                }} else {{
                    // å…¶ä»–æƒ…å†µç›´æ¥ä½¿ç”¨åŸä»£ç 
                    xueqiuCode = stockCode;
                }}

                // æ„å»ºé›ªçƒURL
                const xueqiuUrl = `https://xueqiu.com/S/${{xueqiuCode}}`;

                // åœ¨æ–°çª—å£ä¸­æ‰“å¼€é›ªçƒé¡µé¢
                window.open(xueqiuUrl, '_blank');

                console.log(`âœ… å·²æ‰“å¼€é›ªçƒé“¾æ¥: ${{xueqiuUrl}}`);

                // æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆå¯é€‰ï¼‰
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 10000;
                    background: #28a745; color: white; padding: 10px 20px;
                    border-radius: 5px; font-size: 14px; opacity: 0.9;
                `;
                notification.textContent = `å·²æ‰“å¼€ ${{stockCode}} çš„é›ªçƒé¡µé¢`;
                document.body.appendChild(notification);
                setTimeout(() => document.body.removeChild(notification), 2000);

            }} catch (error) {{
                console.error('âŒ æ‰“å¼€é›ªçƒé“¾æ¥æ—¶å‡ºé”™:', error);
                alert(`æŠ±æ­‰ï¼Œæ— æ³•æ‰“å¼€ ${{stockCode}} çš„é›ªçƒé“¾æ¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚`);
            }}
        }}

        // æ˜¾ç¤ºé›ªçƒè·³è½¬æç¤º
        function showXueqiuTooltip(element, stockCode, stockName) {{
            let xueqiuCode = '';
            if (stockCode.endsWith('.SZ')) {{
                xueqiuCode = 'SZ' + stockCode.replace('.SZ', '');
            }} else if (stockCode.endsWith('.SH')) {{
                xueqiuCode = 'SH' + stockCode.replace('.SH', '');
            }} else {{
                xueqiuCode = stockCode;
            }}

            // æ›´æ–°æç¤ºæ–‡æœ¬
            const tooltip = element.querySelector('.tooltiptext');
            if (tooltip) {{
                tooltip.textContent = `ç‚¹å‡»æŸ¥çœ‹ ${{stockName}} åœ¨é›ªçƒçš„æœ€æ–°ä¿¡æ¯`;
            }}
        }}

        // æ’åºæŒ‡ç¤ºå™¨
        function showSortingIndicator(text) {{
            const indicator = document.getElementById('sortingIndicator');
            indicator.textContent = text;
            indicator.style.display = 'block';
        }}

        function hideSortingIndicator() {{
            const indicator = document.getElementById('sortingIndicator');
            indicator.style.display = 'none';
        }}

        // æœç´¢åŠŸèƒ½
        function searchStocks() {{
            const input = document.getElementById('searchInput');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('stockTable');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {{
                // è·³è¿‡è¯¦æƒ…è¡Œ
                if (tr[i].classList.contains('detail-row')) {{
                    continue;
                }}

                const td = tr[i].getElementsByTagName('td')[0];
                const td2 = tr[i].getElementsByTagName('td')[1];
                if (td || td2) {{
                    const txtValue = (td.textContent || td.innerText) + (td2.textContent || td2.innerText);
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {{
                        tr[i].style.display = '';
                        // å¦‚æœå¯¹åº”çš„è¯¦æƒ…è¡Œæ˜¯å±•å¼€çš„ï¼Œä¹Ÿæ˜¾ç¤º
                        const nextRow = tr[i].nextElementSibling;
                        if (nextRow && nextRow.classList.contains('detail-row') && nextRow.classList.contains('show')) {{
                            nextRow.style.display = 'table-row';
                        }}
                    }} else {{
                        tr[i].style.display = 'none';
                        // éšè—å¯¹åº”çš„è¯¦æƒ…è¡Œ
                        const nextRow = tr[i].nextElementSibling;
                        if (nextRow && nextRow.classList.contains('detail-row')) {{
                            nextRow.style.display = 'none';
                        }}
                    }}
                }}
            }}
        }}

        // ä¼˜åŒ–åçš„æ˜¾ç¤ºè¯¦æƒ…åŠŸèƒ½
        function toggleDetails(stockCode) {{
            const stockRow = document.querySelector(`[data-stock-code="${{stockCode}}"]`);
            const detailRow = document.getElementById(`detail_${{stockCode.replace('.', '_')}}`);
            const actionButton = stockRow.querySelector('.action-button');

            if (!detailRow) {{
                console.error('Detail row not found for:', stockCode);
                return;
            }}

            // å¦‚æœå½“å‰æœ‰å…¶ä»–å±•å¼€çš„è¯¦æƒ…ï¼Œå…ˆå…³é—­
            if (activeDetailRow && activeDetailRow !== detailRow) {{
                activeDetailRow.classList.remove('show');
                activeDetailRow.style.display = 'none';

                // é‡ç½®ä¹‹å‰çš„æŒ‰é’®çŠ¶æ€
                const prevStockRow = activeDetailRow.previousElementSibling;
                if (prevStockRow) {{
                    prevStockRow.classList.remove('expanded');
                    const prevButton = prevStockRow.querySelector('.action-button');
                    if (prevButton) {{
                        prevButton.classList.remove('active');
                        prevButton.textContent = prevButton.textContent.replace('ğŸ”½ æ”¶èµ·è¯¦æƒ…', 'ğŸ“‹ æŸ¥çœ‹è¯¦æƒ…');
                    }}
                }}
            }}

            // åˆ‡æ¢å½“å‰è¯¦æƒ…è¡Œ
            if (detailRow.classList.contains('show')) {{
                // æ”¶èµ·è¯¦æƒ…
                detailRow.classList.remove('show');
                detailRow.style.display = 'none';
                stockRow.classList.remove('expanded');
                actionButton.classList.remove('active');
                actionButton.textContent = actionButton.textContent.replace('ğŸ”½ æ”¶èµ·è¯¦æƒ…', 'ğŸ“‹ æŸ¥çœ‹è¯¦æƒ…');
                activeDetailRow = null;
            }} else {{
                // å±•å¼€è¯¦æƒ…
                detailRow.classList.add('show');
                detailRow.style.display = 'table-row';
                stockRow.classList.add('expanded');
                actionButton.classList.add('active');
                actionButton.textContent = actionButton.textContent.replace('ğŸ“‹ æŸ¥çœ‹è¯¦æƒ…', 'ğŸ”½ æ”¶èµ·è¯¦æƒ…');
                activeDetailRow = detailRow;

                // å¹³æ»‘æ»šåŠ¨åˆ°è¯¦æƒ…åŒºåŸŸ
                setTimeout(() => {{
                    detailRow.scrollIntoView({{
                        behavior: 'smooth',
                        block: 'center'
                    }});
                }}, 100);
            }}
        }}

        // å…³é—­è¯¦æƒ…åŠŸèƒ½
        function closeDetails(stockCode) {{
            const detailRow = document.getElementById(`detail_${{stockCode.replace('.', '_')}}`);
            const stockRow = document.querySelector(`[data-stock-code="${{stockCode}}"]`);

            if (detailRow && stockRow) {{
                detailRow.classList.remove('show');
                detailRow.style.display = 'none';
                stockRow.classList.remove('expanded');

                const actionButton = stockRow.querySelector('.action-button');
                if (actionButton) {{
                    actionButton.classList.remove('active');
                    actionButton.textContent = actionButton.textContent.replace('ğŸ”½ æ”¶èµ·è¯¦æƒ…', 'ğŸ“‹ æŸ¥çœ‹è¯¦æƒ…');
                }}

                activeDetailRow = null;

                // æ»šåŠ¨å›è‚¡ç¥¨è¡Œ
                stockRow.scrollIntoView({{
                    behavior: 'smooth',
                    block: 'center'
                }});
            }}
        }}

        // å›åˆ°é¡¶éƒ¨
        function scrollToTop() {{
            window.scrollTo({{
                top: 0,
                behavior: 'smooth'
            }});
        }}

        // å¢å¼ºç‰ˆæ™ºèƒ½æ’åºåŠŸèƒ½ï¼ˆæ–°å¢æ”¯æŒ60æ—¥æœ€å¤§ç›ˆåˆ©æ’åºï¼‰
        function smartSort(field, forceDirection = null) {{
            if (sortingInProgress) return;
            sortingInProgress = true;

            showSortingIndicator('ğŸ›ï¸ æ™ºèƒ½æ’åºä¸­ï¼Œè¯·ç¨å€™...');

            setTimeout(() => {{
                const table = document.getElementById('stockTable');
                const tbody = table.getElementsByTagName('tbody')[0];
                const rows = Array.from(tbody.getElementsByTagName('tr'));

                // åˆ†ç¦»è‚¡ç¥¨è¡Œå’Œè¯¦æƒ…è¡Œ
                const stockRows = [];
                const detailRowsMap = new Map();

                for (let i = 0; i < rows.length; i++) {{
                    const row = rows[i];
                    if (row.classList.contains('detail-row')) {{
                        // è¯¦æƒ…è¡Œï¼Œæ‰¾åˆ°å¯¹åº”çš„è‚¡ç¥¨è¡Œ
                        const stockRow = rows[i - 1];
                        if (stockRow && !stockRow.classList.contains('detail-row')) {{
                            detailRowsMap.set(stockRow, row);
                        }}
                    }} else {{
                        // è‚¡ç¥¨è¡Œ
                        stockRows.push(row);
                    }}
                }}

                // ç¡®å®šæ’åºæ–¹å‘
                let direction = forceDirection;
                if (!direction) {{
                    if (currentSortField === field) {{
                        direction = currentSortDirection === 'asc' ? 'desc' : 'asc';
                    }} else {{
                        // é»˜è®¤æ’åºæ–¹å‘
                        const defaultAscFields = ['price', 'market_cap'];
                        direction = defaultAscFields.includes(field) ? 'asc' : 'desc';
                    }}
                }}

                // æ’åºè‚¡ç¥¨è¡Œ
                stockRows.sort((a, b) => {{
                    let aVal, bVal;

                    switch(field) {{
                        case 'signal_grade':
                            const gradeOrder = {{'S': 4, 'A': 3, 'B': 2, 'C': 1}};
                            aVal = gradeOrder[a.dataset.signalGrade] || 0;
                            bVal = gradeOrder[b.dataset.signalGrade] || 0;
                            break;
                        case 'probability':
                            aVal = parseFloat(a.dataset.probability) || 0;
                            bVal = parseFloat(b.dataset.probability) || 0;
                            break;
                        case 'price':
                            aVal = parseFloat(a.dataset.price) || 0;
                            bVal = parseFloat(b.dataset.price) || 0;
                            break;
                        case 'market_cap':
                            aVal = parseFloat(a.dataset.marketCap) || 0;
                            bVal = parseFloat(b.dataset.marketCap) || 0;
                            break;
                        case 'td_setup':
                            aVal = Math.abs(parseInt(a.dataset.tdSetup) || 0);
                            bVal = Math.abs(parseInt(b.dataset.tdSetup) || 0);
                            break;
                        case 'td_countdown':
                            aVal = Math.abs(parseInt(a.dataset.tdCountdown) || 0);
                            bVal = Math.abs(parseInt(b.dataset.tdCountdown) || 0);
                            break;
                        case 'risk_level':
                            aVal = parseInt(a.dataset.riskLevel) || 0;
                            bVal = parseInt(b.dataset.riskLevel) || 0;
                            break;
                        case 'td_score':
                            aVal = parseInt(a.dataset.tdScore) || 0;
                            bVal = parseInt(b.dataset.tdScore) || 0;
                            break;
                        case 'max_profit':
                            aVal = parseFloat(a.dataset.maxProfit) || 0;
                            bVal = parseFloat(b.dataset.maxProfit) || 0;
                            break;
                        default:
                            return 0;
                    }}

                    if (direction === 'asc') {{
                        return aVal - bVal;
                    }} else {{
                        return bVal - aVal;
                    }}
                }});

                // é‡æ–°æ’å…¥è¡¨æ ¼ï¼ˆå¸¦åŠ¨ç”»æ•ˆæœï¼‰
                tbody.style.opacity = '0.5';
                setTimeout(() => {{
                    // æ¸…ç©ºtbody
                    tbody.innerHTML = '';

                    // é‡æ–°æ’å…¥æ’åºåçš„è‚¡ç¥¨è¡Œå’Œå¯¹åº”çš„è¯¦æƒ…è¡Œ
                    stockRows.forEach(stockRow => {{
                        tbody.appendChild(stockRow);
                        const detailRow = detailRowsMap.get(stockRow);
                        if (detailRow) {{
                            tbody.appendChild(detailRow);
                        }}
                    }});

                    tbody.style.opacity = '1';
                }}, 300);

                // æ›´æ–°çŠ¶æ€
                currentSortField = field;
                currentSortDirection = direction;

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                updateSortButtons();

                // æ›´æ–°æ’åºçŠ¶æ€æ˜¾ç¤º
                updateSortStatus();

                setTimeout(() => {{
                    hideSortingIndicator();
                    sortingInProgress = false;
                }}, 800);
            }}, 200);
        }}

        // æ›´æ–°æ’åºæŒ‰é’®çŠ¶æ€
        function updateSortButtons() {{
            const buttons = document.querySelectorAll('.sort-button');
            buttons.forEach(btn => {{
                btn.classList.remove('active');
                const arrow = btn.querySelector('.arrow');
                if (arrow) {{
                    arrow.textContent = 'â†•ï¸';
                }}
            }});

            // æ¿€æ´»å½“å‰æ’åºæŒ‰é’®
            const activeBtn = document.querySelector(`[data-sort="${{currentSortField}}"]`);
            if (activeBtn) {{
                activeBtn.classList.add('active');
                const arrow = activeBtn.querySelector('.arrow');
                if (arrow) {{
                    arrow.textContent = currentSortDirection === 'asc' ? 'â†‘' : 'â†“';
                }}
            }}
        }}

        // æ›´æ–°æ’åºçŠ¶æ€æ˜¾ç¤º
        function updateSortStatus() {{
            const statusDiv = document.getElementById('sortStatus');
            const fieldNames = {{
                'signal_grade': 'ä¿¡å·ç­‰çº§',
                'probability': 'åè½¬æ¦‚ç‡',
                'price': 'è‚¡ä»·',
                'market_cap': 'æ€»å¸‚å€¼',
                'td_setup': 'TD Setup',
                'td_countdown': 'TD Countdown',
                'risk_level': 'é£é™©ç­‰çº§',
                'td_score': 'TDè¯„åˆ†',
                'max_profit': '60æ—¥æœ€å¤§ç›ˆåˆ©'
            }};

            const fieldName = fieldNames[currentSortField] || currentSortField;
            const directionText = currentSortDirection === 'asc' ? 'å‡åº' : 'é™åº';

            statusDiv.innerHTML = `<span class="status-icon">ğŸ“Š</span>å½“å‰æ’åºï¼š<strong>${{fieldName}}</strong> (${{directionText}}) | ç‚¹å‡»ä»»æ„æ’åºæŒ‰é’®åˆ‡æ¢æ’åºæ–¹å¼ | ğŸ”— ç‚¹å‡»è‚¡ç¥¨åç§°æˆ–ä»£ç æŸ¥çœ‹é›ªçƒä¿¡æ¯`;
        }}

        // æ˜¾ç¤º/éšè—å›åˆ°é¡¶éƒ¨æŒ‰é’®
        window.onscroll = function() {{
            const backToTopBtn = document.getElementById('backToTopBtn');
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {{
                backToTopBtn.style.display = 'block';
            }} else {{
                backToTopBtn.style.display = 'none';
            }}
        }};

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {{
            // ä¿å­˜åŸå§‹é¡ºåº
            const table = document.getElementById('stockTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            originalOrder = Array.from(tbody.getElementsByTagName('tr'));

            // åˆå§‹åŒ–æ’åºçŠ¶æ€
            updateSortButtons();
            updateSortStatus();

            console.log('ğŸ›ï¸ TDåˆ†ææŠ¥å‘Šå·²åŠ è½½å®Œæˆï¼ä¼˜åŒ–åçš„è¯¦æƒ…å±•ç¤º + 8ç§æ™ºèƒ½æ’åºåŠŸèƒ½ + ğŸ’¼æ€»å¸‚å€¼ç­›é€‰ + ğŸ”—é›ªçƒè·³è½¬åŠŸèƒ½ + ğŸ’°60æ—¥æœ€å¤§ç›ˆåˆ©åŠŸèƒ½å·²å¯ç”¨ã€‚');

            // åˆå§‹åŒ–é›ªçƒè·³è½¬æç¤º
            const stockLinks = document.querySelectorAll('.stock-link');
            stockLinks.forEach(link => {{
                link.addEventListener('mouseenter', function() {{
                    const stockCode = this.dataset.stockCode;
                    const stockName = this.dataset.stockName;
                    showXueqiuTooltip(this.parentElement, stockCode, stockName);
                }});
            }});

            // æ·»åŠ é›ªçƒè·³è½¬ä½¿ç”¨æç¤º
            console.log('ğŸ”— é›ªçƒè·³è½¬åŠŸèƒ½è¯´æ˜ï¼š');
            console.log('â€¢ ç‚¹å‡»è‚¡ç¥¨ä»£ç æˆ–è‚¡ç¥¨åç§°å¯ç›´æ¥è·³è½¬åˆ°é›ªçƒæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯');
            console.log('â€¢ æ”¯æŒæ·±äº¤æ‰€(.SZ)å’Œä¸Šäº¤æ‰€(.SH)è‚¡ç¥¨');
            console.log('â€¢ ä¼šåœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ï¼Œä¸å½±å“å½“å‰åˆ†æé¡µé¢');
            console.log('â€¢ æ‚¬åœæ—¶æ˜¾ç¤ºé“¾æ¥å›¾æ ‡å’Œæç¤ºä¿¡æ¯');

            console.log('ğŸ’¼ æ€»å¸‚å€¼ç­›é€‰åŠŸèƒ½è¯´æ˜ï¼š');
            console.log('â€¢ è‡ªåŠ¨è®¡ç®—å„è‚¡ç¥¨çš„æ€»å¸‚å€¼ï¼ˆåŸºäºå½“å‰ä»·æ ¼å’Œæ¨¡æ‹Ÿè‚¡æœ¬ï¼‰');
            console.log('â€¢ æ”¯æŒæŒ‰å°ç›˜è‚¡ã€ä¸­ç›˜è‚¡ã€å¤§ç›˜è‚¡ç­‰åˆ†ç±»ç­›é€‰');
            console.log('â€¢ æä¾›æ€»å¸‚å€¼å‡åº/é™åºæ’åºåŠŸèƒ½');
            console.log('â€¢ é¢œè‰²æ ‡è¯†ï¼šç´«è‰²(è¶…å¤§ç›˜)ã€è“è‰²(å¤§ç›˜)ã€ç»¿è‰²(ä¸­ç›˜)ã€çº¢è‰²(å°ç›˜)ã€ç°è‰²(å¾®ç›˜)');

            console.log('ğŸ’° 60æ—¥æœ€å¤§ç›ˆåˆ©åŠŸèƒ½è¯´æ˜ï¼š');
            console.log('â€¢ è®¡ç®—ç›®æ ‡æ—¥æœŸå60ä¸ªäº¤æ˜“æ—¥å†…çš„æœ€å¤§ç›ˆåˆ©ç™¾åˆ†æ¯”');
            console.log('â€¢ ä½¿ç”¨å‰å¤æƒæ•°æ®è®¡ç®—ï¼Œæ¶ˆé™¤é™¤æƒé™¤æ¯å½±å“');
            console.log('â€¢ æ˜¾ç¤ºè¾¾åˆ°æœ€å¤§ç›ˆåˆ©çš„å¤©æ•°');
            console.log('â€¢ æ”¯æŒæŒ‰60æ—¥æœ€å¤§ç›ˆåˆ©æ’åºç­›é€‰');
        }});
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ å¢å¼ºç‰ˆTDè‚¡ç¥¨ç­›é€‰åˆ†ææŠ¥å‘Š</h1>
            <p>åˆ†ææ—¥æœŸï¼š{target_date} | å››ç»´ç»“æ„åˆ†æ + é¡¶åº•ç»“æ„åˆ†æ + ä¼˜åŒ–è¯¦æƒ…å±•ç¤º + 7ç§æ™ºèƒ½æ’åº + Kçº¿å›¾è¡¨ + ğŸ”—é›ªçƒè·³è½¬ + ğŸ’°60æ—¥æœ€å¤§ç›ˆåˆ©</p>
        </div>

        <!-- æ’åºæŒ‡ç¤ºå™¨ -->
        <div id="sortingIndicator" class="sorting-indicator">
            ğŸ›ï¸ æ™ºèƒ½æ’åºä¸­ï¼Œè¯·ç¨å€™...
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{total_stocks}</div>
                <div class="stat-label">æ€»è‚¡ç¥¨æ•°é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{len(focus_stocks)}</div>
                <div class="stat-label">é‡ç‚¹å…³æ³¨è‚¡ç¥¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{countdown_active}</div>
                <div class="stat-label">Countdownæ´»è·ƒ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">Â¥{avg_price:.2f}</div>
                <div class="stat-label">å¹³å‡è‚¡ä»·</div>
            </div>
        </div>
"""

    # é‡ç‚¹å…³æ³¨è‚¡ç¥¨éƒ¨åˆ†
    if focus_stocks:
        html_content += f"""
        <div class="focus-section">
            <div class="focus-title">ğŸš¨ é‡ç‚¹å…³æ³¨è‚¡ç¥¨ ({len(focus_stocks)}åª) - å°å¸‚å€¼ä½ä»·è‚¡ç²¾é€‰ + ğŸ”—é›ªçƒå¿«é€Ÿè·³è½¬ + ğŸ’°60æ—¥æœ€å¤§ç›ˆåˆ©</div>
            <div class="focus-grid">
"""
        for stock in focus_stocks[:10]:  # æ˜¾ç¤ºå‰10åª
            chart_available = stock['code'] in chart_map
            chart_icon = "ğŸ“Š" if chart_available else ""

            # 60æ—¥æœ€å¤§ç›ˆåˆ©æ˜¾ç¤º
            max_profit_pct = stock.get('max_profit_pct', 0)
            max_profit_days = stock.get('max_profit_days', 0)

            profit_display = ""
            if max_profit_pct > 0:
                profit_display = f"ğŸ’° 60æ—¥æœ€å¤§ç›ˆåˆ©: +{max_profit_pct}% (ç¬¬{max_profit_days}å¤©)"
            else:
                profit_display = "ğŸ’° 60æ—¥æœ€å¤§ç›ˆåˆ©: æš‚æ— æ•°æ®"

            html_content += f"""
                <div class="focus-card">
                    <h3>
                        <span class="stock-link" 
                              onclick="openXueqiu('{stock['code']}')"
                              data-stock-code="{stock['code']}"
                              data-stock-name="{stock['name']}"
                              title="ç‚¹å‡»æŸ¥çœ‹é›ªçƒæœ€æ–°ä¿¡æ¯" 
                              style="color: white;">
                            {stock['name']} ({stock['code']})
                        </span> {chart_icon}
                    </h3>
                    <p><strong>ä»·æ ¼ï¼š</strong>Â¥{stock['current_price']:.2f}</p>
                    <p><strong>Setupï¼š</strong>{stock['td_setup']} | <strong>Countdownï¼š</strong>{stock['td_countdown']}</p>
                    <p><strong>ä¿¡å·ç­‰çº§ï¼š</strong>{stock['td_signal_grade']}</p>
                    <p><strong>è¯„åˆ†ï¼š</strong>{stock['td_score']}åˆ†</p>
                    <p><strong>æ“ä½œå»ºè®®ï¼š</strong>{stock['td_strategy']['direction']}</p>
                    <p><strong>ä»“ä½ï¼š</strong>{stock['td_strategy']['position_size']}</p>
                    <p><strong>{profit_display}</strong></p>
                    <button class="action-button" onclick="toggleDetails('{stock['code']}')">ğŸ“‹ æŸ¥çœ‹è¯¦æƒ…{' + å›¾è¡¨' if chart_available else ''}</button>
                </div>
"""
        html_content += """
            </div>
        </div>
"""

    # å¢å¼ºç‰ˆæ™ºèƒ½æ’åºæ§åˆ¶åŒºåŸŸï¼ˆæ–°å¢æ€»å¸‚å€¼æ’åºå’Œ60æ—¥æœ€å¤§ç›ˆåˆ©æ’åºï¼‰
    html_content += f"""
        <div class="sort-controls">
            <div class="sort-title">ğŸ›ï¸ 8ç§æ™ºèƒ½æ’åºæ–¹å¼ + ğŸ’¼æ€»å¸‚å€¼ç­›é€‰ + ğŸ”—é›ªçƒè·³è½¬åŠŸèƒ½ + ğŸ’°60æ—¥æœ€å¤§ç›ˆåˆ©</div>
            <div class="sort-subtitle">ä¸€é”®æ’åºï¼Œå¿«é€Ÿç­›é€‰ç›®æ ‡è‚¡ç¥¨ | æ”¯æŒå‡åº/é™åºåˆ‡æ¢ | å®æ—¶æ’åºçŠ¶æ€æ˜¾ç¤º | ä¼˜åŒ–è¯¦æƒ…å±•ç¤º | ç‚¹å‡»è‚¡ç¥¨åç§°è·³è½¬é›ªçƒ | æ–°å¢æ€»å¸‚å€¼æ’åºå’Œ60æ—¥æœ€å¤§ç›ˆåˆ©æ’åº</div>
            <div class="sort-buttons">
                <button class="sort-button" data-sort="signal_grade" onclick="smartSort('signal_grade')">
                    <span class="icon">ğŸ“ˆ</span>
                    æŒ‰ä¿¡å·ç­‰çº§æ’åº
                    <span class="arrow">â†•ï¸</span>
                </button>
                <button class="sort-button" data-sort="probability" onclick="smartSort('probability')">
                    <span class="icon">ğŸ¯</span>
                    æŒ‰åè½¬æ¦‚ç‡æ’åº
                    <span class="arrow">â†•ï¸</span>
                </button>
                <button class="sort-button" data-sort="price" onclick="smartSort('price')">
                    <span class="icon">ğŸ’°</span>
                    æŒ‰è‚¡ä»·æ’åº
                    <span class="arrow">â†•ï¸</span>
                </button>
                <button class="sort-button" data-sort="market_cap" onclick="smartSort('market_cap')">
                    <span class="icon">ğŸ’¼</span>
                    æŒ‰æ€»å¸‚å€¼æ’åº
                    <span class="arrow">â†•ï¸</span>
                </button>
                <button class="sort-button" data-sort="td_setup" onclick="smartSort('td_setup')">
                    <span class="icon">ğŸ”¢</span>
                    æŒ‰TD Setupæ’åº
                    <span class="arrow">â†•ï¸</span>
                </button>
                <button class="sort-button" data-sort="td_countdown" onclick="smartSort('td_countdown')">
                    <span class="icon">â°</span>
                    æŒ‰Countdownæ’åº
                    <span class="arrow">â†•ï¸</span>
                </button>
                <button class="sort-button" data-sort="risk_level" onclick="smartSort('risk_level')">
                    <span class="icon">âš–ï¸</span>
                    æŒ‰é£é™©ç­‰çº§æ’åº
                    <span class="arrow">â†•ï¸</span>
                </button>
                <button class="sort-button" data-sort="max_profit" onclick="smartSort('max_profit')">
                    <span class="icon">ğŸ’°</span>
                    æŒ‰60æ—¥æœ€å¤§ç›ˆåˆ©æ’åº
                    <span class="arrow">â†•ï¸</span>
                </button>
            </div>
            <div class="sort-status" id="sortStatus">
                <span class="status-icon">ğŸ“Š</span>å½“å‰æ’åºï¼š<strong>æ€»å¸‚å€¼</strong> (å‡åº) | ç‚¹å‡»ä»»æ„æ’åºæŒ‰é’®è¿›è¡Œæ™ºèƒ½æ’åº | ğŸ”— ç‚¹å‡»è‚¡ç¥¨åç§°æˆ–ä»£ç æŸ¥çœ‹é›ªçƒä¿¡æ¯ | ğŸ’¼ æ–°å¢æ€»å¸‚å€¼æ’åº + ğŸ’° 60æ—¥æœ€å¤§ç›ˆåˆ©æ’åº
            </div>
        </div>
"""

    # è‚¡ç¥¨åˆ—è¡¨è¡¨æ ¼ï¼ˆä¼˜åŒ–åï¼šæ¯ä¸ªè‚¡ç¥¨è¡Œåç´§è·Ÿè¯¦æƒ…è¡Œï¼Œæ–°å¢60æ—¥æœ€å¤§ç›ˆåˆ©åˆ—ï¼‰
    html_content += f"""
        <div class="stock-table">
            <div class="table-header">
                ğŸ“Š ç­›é€‰è‚¡ç¥¨TDåˆ†æåˆ—è¡¨ ({len(valid_analyses)}åª) - {len(chart_map)}åªå«Kçº¿å›¾è¡¨ - ğŸ›ï¸ ä¼˜åŒ–è¯¦æƒ…å±•ç¤º + 8ç§æ™ºèƒ½æ’åº + ğŸ’¼æ€»å¸‚å€¼ç­›é€‰ + ğŸ”—é›ªçƒè·³è½¬ + ğŸ’°60æ—¥æœ€å¤§ç›ˆåˆ©
            </div>
            <div style="padding: 20px;">
                <input type="text" id="searchInput" class="search-box" onkeyup="searchStocks()" 
                       placeholder="ğŸ” æœç´¢è‚¡ç¥¨åç§°æˆ–ä»£ç ... (ç‚¹å‡»è‚¡ç¥¨åç§°å¯è·³è½¬é›ªçƒ)">
            </div>
            <table id="stockTable">
                <thead>
                    <tr>
                        <th>è‚¡ç¥¨ä»£ç  ğŸ”—</th>
                        <th>è‚¡ç¥¨åç§° ğŸ”—</th>
                        <th>å½“å‰ä»·æ ¼</th>
                        <th>ğŸ’¼æ€»å¸‚å€¼(äº¿)</th>
                        <th>TD Setup</th>
                        <th>TD Countdown</th>
                        <th>é£é™©ç­‰çº§</th>
                        <th>ä¿¡å·ç­‰çº§</th>
                        <th>åè½¬æ¦‚ç‡</th>
                        <th>ğŸ’°60æ—¥æœ€å¤§ç›ˆåˆ©</th>
                        <th>æ“ä½œå»ºè®®</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
"""

    # æ·»åŠ è‚¡ç¥¨è¡Œå’Œå¯¹åº”çš„è¯¦æƒ…è¡Œï¼ˆç´§å¯†æ’åˆ—ï¼‰ - ä¿®æ”¹è¿™éƒ¨åˆ†æ·»åŠ é›ªçƒè·³è½¬åŠŸèƒ½å’Œ60æ—¥æœ€å¤§ç›ˆåˆ©åŠŸèƒ½
    for analysis in valid_analyses:
        if 'analysis' in analysis and isinstance(analysis['analysis'], str):
            continue

        signal_class = 'signal-c'
        signal_grade_letter = 'C'
        if analysis['td_signal_grade'].startswith('S'):
            signal_class = 'signal-s'
            signal_grade_letter = 'S'
        elif analysis['td_signal_grade'].startswith('A'):
            signal_class = 'signal-a'
            signal_grade_letter = 'A'
        elif analysis['td_signal_grade'].startswith('B'):
            signal_class = 'signal-b'
            signal_grade_letter = 'B'

        risk_color = 'color: red;' if analysis['td_risk_level'] < -1 else 'color: green;' if analysis[
                                                                                                 'td_risk_level'] > 1 else 'color: gray;'

        chart_available = analysis['code'] in chart_map
        chart_icon = "ğŸ“Š" if chart_available else ""
        stock_id = analysis['code'].replace('.', '_')

        # è®¡ç®—æ€»å¸‚å€¼ï¼ˆæ¨¡æ‹Ÿè®¡ç®—ï¼Œå®é™…åº”ç”¨ä¸­åº”ä»æ•°æ®æºè·å–ï¼‰
        try:
            # ä½¿ç”¨è‚¡ç¥¨ä»£ç ç”Ÿæˆä¸€è‡´çš„æ¨¡æ‹Ÿè‚¡æœ¬æ•°æ®
            stock_code_hash = hash(analysis['code']) % 1000000
            simulated_shares = 500000000 + (stock_code_hash * 100000)  # 5äº¿åˆ°15äº¿è‚¡
            market_cap_yi = (analysis['current_price'] * simulated_shares / 100000000)  # è½¬æ¢ä¸ºäº¿å…ƒ
            market_cap_text = f"{market_cap_yi:.1f}äº¿"

            # å¸‚å€¼åˆ†ç±»æ ·å¼
            if market_cap_yi >= 1000:
                market_cap_class = 'market-cap-huge'  # è¶…å¤§ç›˜è‚¡
            elif market_cap_yi >= 500:
                market_cap_class = 'market-cap-large'  # å¤§ç›˜è‚¡
            elif market_cap_yi >= 200:
                market_cap_class = 'market-cap-medium'  # ä¸­ç›˜è‚¡
            elif market_cap_yi >= 50:
                market_cap_class = 'market-cap-small'  # å°ç›˜è‚¡
            else:
                market_cap_class = 'market-cap-micro'  # å¾®ç›˜è‚¡

        except Exception as e:
            market_cap_yi = 0
            market_cap_text = "æœªçŸ¥"
            market_cap_class = 'market-cap-unknown'

        # 60æ—¥æœ€å¤§ç›ˆåˆ©æ˜¾ç¤ºå’Œæ ·å¼
        max_profit_pct = analysis.get('max_profit_pct', 0)
        max_profit_days = analysis.get('max_profit_days', 0)
        max_profit_status = analysis.get('max_profit_status', 'unknown')

        if max_profit_pct > 20:
            profit_class = 'profit-high'
            profit_text = f"+{max_profit_pct}% ({max_profit_days}å¤©)"
        elif max_profit_pct > 10:
            profit_class = 'profit-medium'
            profit_text = f"+{max_profit_pct}% ({max_profit_days}å¤©)"
        elif max_profit_pct > 0:
            profit_class = 'profit-low'
            profit_text = f"+{max_profit_pct}% ({max_profit_days}å¤©)"
        else:
            profit_class = 'profit-none'
            if max_profit_status == 'success':
                profit_text = "æ— ç›ˆåˆ©"
            else:
                profit_text = "æ— æ•°æ®"

        # ä¸»è‚¡ç¥¨è¡Œ - ä¿®æ”¹è¿™éƒ¨åˆ†æ·»åŠ é›ªçƒè·³è½¬åŠŸèƒ½ã€æ€»å¸‚å€¼å’Œ60æ—¥æœ€å¤§ç›ˆåˆ©æ•°æ®
        html_content += f"""
                    <tr class="stock-row table-row-transition"
                        data-stock-code="{analysis['code']}"
                        data-signal-grade="{signal_grade_letter}" 
                        data-probability="{analysis['reversal_probability']}" 
                        data-price="{analysis['current_price']}"
                        data-market-cap="{market_cap_yi}"
                        data-td-setup="{analysis['td_setup']}" 
                        data-td-countdown="{analysis['td_countdown']}" 
                        data-risk-level="{analysis['td_risk_level']}"
                        data-td-score="{analysis.get('td_score', 0)}"
                        data-max-profit="{max_profit_pct}">
                        <td>
                            <div class="xueqiu-tooltip">
                                <strong class="stock-link" 
                                        onclick="openXueqiu('{analysis['code']}')"
                                        data-stock-code="{analysis['code']}"
                                        data-stock-name="{analysis['name']}"
                                        title="ç‚¹å‡»æŸ¥çœ‹é›ªçƒæœ€æ–°ä¿¡æ¯">
                                    {analysis['code']}
                                </strong>
                                <span class="tooltiptext">ç‚¹å‡»æŸ¥çœ‹ {analysis['name']} åœ¨é›ªçƒçš„æœ€æ–°ä¿¡æ¯</span>
                            </div>
                        </td>
                        <td>
                            <div class="xueqiu-tooltip">
                                <strong class="stock-link" 
                                        onclick="openXueqiu('{analysis['code']}')"
                                        data-stock-code="{analysis['code']}"
                                        data-stock-name="{analysis['name']}"
                                        title="ç‚¹å‡»æŸ¥çœ‹é›ªçƒæœ€æ–°ä¿¡æ¯">
                                    {analysis['name']} {chart_icon}
                                </strong>
                                <span class="tooltiptext">ç‚¹å‡»æŸ¥çœ‹ {analysis['name']} åœ¨é›ªçƒçš„æœ€æ–°ä¿¡æ¯</span>
                            </div>
                        </td>
                        <td><strong>Â¥{analysis['current_price']:.2f}</strong></td>
                        <td><span class="market-cap-badge {market_cap_class}">{market_cap_text}</span></td>
                        <td>{analysis['td_setup']}</td>
                        <td>{analysis['td_countdown'] if analysis['td_countdown'] != 0 else '-'}</td>
                        <td style="{risk_color}"><strong>{analysis['td_risk_level']}</strong></td>
                        <td><span class="signal-badge {signal_class}">{analysis['td_signal_grade']}</span></td>
                        <td>
                            {analysis['reversal_probability']:.1f}%
                            <div class="probability-bar">
                                <div class="probability-fill" style="width: {min(analysis['reversal_probability'], 100)}%"></div>
                            </div>
                        </td>
                        <td>
                            <span class="profit-badge {profit_class}">{profit_text}</span>
                        </td>
                        <td>
                            <strong>{analysis['td_strategy']['direction']}</strong><br>
                            <small>{analysis['td_strategy']['position_size']}</small>
                        </td>
                        <td>
                            <button class="action-button" onclick="toggleDetails('{analysis['code']}')">ğŸ“‹ æŸ¥çœ‹è¯¦æƒ…{' + å›¾è¡¨' if chart_available else ''}</button>
                        </td>
                    </tr>
"""

        # ç´§è·Ÿçš„è¯¦æƒ…è¡Œï¼ˆåŒ…å«å®Œæ•´åˆ†æå†…å®¹ï¼‰
        html_content += f"""
                    <tr id="detail_{stock_id}" class="detail-row">
                        <td colspan="12" style="padding: 0;">
                            <div class="detail-content">
                                <div class="detail-header">
                                    <h2>ğŸ“ˆ 
                                        <span class="stock-link" 
                                              onclick="openXueqiu('{analysis['code']}')"
                                              data-stock-code="{analysis['code']}"
                                              data-stock-name="{analysis['name']}"
                                              title="ç‚¹å‡»æŸ¥çœ‹é›ªçƒæœ€æ–°ä¿¡æ¯"
                                              style="color: white; cursor: pointer;">
                                            {analysis['name']} ({analysis['code']})
                                        </span> - å¢å¼ºç‰ˆTDåˆ†æ{' + Kçº¿å›¾è¡¨' if chart_available else ''} + ğŸ”—é›ªçƒè·³è½¬ + ğŸ’°60æ—¥æœ€å¤§ç›ˆåˆ©
                                    </h2>
                                    <button class="close-btn" onclick="closeDetails('{analysis['code']}')">âœ– æ”¶èµ·</button>
                                </div>
                                <p style="margin-bottom: 25px; font-size: 1.1rem;">å½“å‰ä»·æ ¼ï¼šÂ¥{analysis['current_price']:.2f} | ä¿¡å·ç­‰çº§ï¼š{analysis['td_signal_grade']} | è¯„åˆ†ï¼š{analysis['td_score']}åˆ† | ğŸ’°60æ—¥æœ€å¤§ç›ˆåˆ©ï¼š{profit_text} | 
                                   <span class="stock-link" 
                                         onclick="openXueqiu('{analysis['code']}')"
                                         style="color: #FFD700; text-decoration: underline; cursor: pointer;"
                                         title="ç‚¹å‡»æŸ¥çœ‹é›ªçƒæœ€æ–°ä¿¡æ¯">
                                       ğŸ”— æŸ¥çœ‹é›ªçƒè¯¦æƒ…
                                   </span>
                                </p>
"""

        # TDæŠ€æœ¯å›¾è¡¨éƒ¨åˆ†ï¼ˆå¦‚æœæœ‰å›¾è¡¨ï¼‰
        if chart_available:
            chart_filename = chart_map[analysis['code']]
            html_content += f"""
                                <div class="chart-section">
                                    <h3>ğŸ“ˆ TDåºåˆ—Kçº¿æŠ€æœ¯å›¾è¡¨</h3>
                                    <img src="{chart_filename}" alt="{analysis['name']} TDå›¾è¡¨" class="chart-image" 
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <div style="display: none; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; text-align: center; border: 2px dashed rgba(255, 255, 255, 0.3);">
                                        <p>ğŸ“Š å›¾è¡¨æ–‡ä»¶æœªæ‰¾åˆ°</p>
                                        <p>å›¾è¡¨è·¯å¾„: {chart_filename}</p>
                                    </div>
                                    <div style="margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; text-align: left;">
                                        <h4>ğŸ“‹ å›¾è¡¨è¯´æ˜ï¼š</h4>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin-top: 10px;">
                                            <p>â€¢ <strong>è“è‰²åœ†ç‚¹ + æ•°å­—ï¼š</strong>TDä¹°å…¥Setupåºå· (1-9)</p>
                                            <p>â€¢ <strong>çº¢è‰²ä¸‰è§’ + æ•°å­—ï¼š</strong>TDå–å‡ºSetupåºå· (1-9)</p>
                                            <p>â€¢ <strong>è“è‰²æ–¹å— Cæ•°å­—ï¼š</strong>TDä¹°å…¥Countdownåºå· (1-13)</p>
                                            <p>â€¢ <strong>çº¢è‰²æ–¹å— Cæ•°å­—ï¼š</strong>TDå–å‡ºCountdownåºå· (1-13)</p>
                                            <p>â€¢ <strong>â˜… å®Œç¾è®¾ç½®ï¼š</strong>ç´«è‰²æ ‡è®°ï¼Œæé«˜ä¿¡å·å¯é æ€§</p>
                                            <p>â€¢ <strong>è™šçº¿ï¼š</strong>TDSTåŠ¨æ€æ”¯æ’‘é˜»åŠ›çº¿</p>
                                            <p>â€¢ <strong>ç‚¹çº¿ï¼š</strong>ä¼ ç»ŸæŠ€æœ¯æ”¯æ’‘é˜»åŠ›ä½</p>
                                            <p>â€¢ <strong>å½©è‰²çº¿æ¡ï¼š</strong>MA5(ç´«) MA10(æ©™) MA20(è“)</p>
                                        </div>
                                    </div>
                                </div>
"""

        # åˆ†æç½‘æ ¼ï¼ˆæ–°å¢60æ—¥æœ€å¤§ç›ˆåˆ©åˆ†æå¡ç‰‡ï¼‰
        html_content += f"""
                                <div class="analysis-grid">
                                    <div class="analysis-card">
                                        <h3>ğŸ¯ TDåºåˆ—çŠ¶æ€</h3>
                                        <p><strong>Setupï¼š</strong>{analysis['td_setup']} {'âœ¨å®Œç¾è®¾ç½®' if analysis['td_perfected'] else ''}</p>
                                        <p><strong>Countdownï¼š</strong>{analysis['td_countdown']}</p>
                                        <p><strong>Comboï¼š</strong>{analysis['td_combo']}</p>
                                        <p><strong>å½“å‰é˜¶æ®µï¼š</strong>{analysis['td_phase']}</p>
                                        <p><strong>é£é™©ç­‰çº§ï¼š</strong>{analysis['td_risk_level']} (-5åˆ°+5)</p>
                                    </div>

                                    <div class="analysis-card">
                                        <h3>ğŸ’° å…³é”®ä»·ä½</h3>
                                        <p><strong>æ”¯æ’‘ä½ï¼š</strong>{analysis['support_levels']}</p>
                                        <p><strong>é˜»åŠ›ä½ï¼š</strong>{analysis['resistance_levels']}</p>
                                        <p><strong>è½´å¿ƒç‚¹ï¼š</strong>{analysis['pivot']}</p>
                                        <p><strong>TDSTä½ï¼š</strong>{analysis['tdst_levels']}</p>
                                    </div>

                                    <div class="analysis-card">
                                        <h3>ğŸ’¼ å¸‚å€¼åˆ†æ</h3>
                                        <p><strong>æ€»å¸‚å€¼ï¼š</strong><span class="market-cap-badge {market_cap_class}">{market_cap_text}</span></p>
                                        <p><strong>å¸‚å€¼åˆ†ç±»ï¼š</strong>{
        'è¶…å¤§ç›˜è‚¡' if market_cap_yi >= 1000 else
        'å¤§ç›˜è‚¡' if market_cap_yi >= 500 else
        'ä¸­ç›˜è‚¡' if market_cap_yi >= 200 else
        'å°ç›˜è‚¡' if market_cap_yi >= 50 else
        'å¾®ç›˜è‚¡'
        }</p>
                                        <p><strong>ç›¸å¯¹ä¼°å€¼ï¼š</strong>åŸºäºå½“å‰ä»·æ ¼è®¡ç®—</p>
                                        <p><strong>è¯´æ˜ï¼š</strong>å¸‚å€¼æ•°æ®ä¸ºæ¨¡æ‹Ÿè®¡ç®—ï¼Œä»…ä¾›å‚è€ƒ</p>
                                    </div>

                                    <div class="analysis-card">
                                        <h3>ğŸ“Š æŠ€æœ¯å½¢æ€</h3>
                                        <p><strong>å‡çº¿è¶‹åŠ¿ï¼š</strong>{analysis['ma_trend']}</p>
                                        <p><strong>Kçº¿å½¢æ€ï¼š</strong>{analysis['pattern']}</p>
                                        <p><strong>æˆäº¤é‡ï¼š</strong>{analysis['volume_analysis']['volume_trend']}</p>
                                        <p><strong>é‡ä»·å…³ç³»ï¼š</strong>{analysis['volume_analysis']['volume_price_match']}</p>
                                    </div>

                                    <div class="analysis-card">
                                        <h3>ğŸ’° 60æ—¥æœ€å¤§ç›ˆåˆ©åˆ†æ</h3>
                                        <p><strong>æœ€å¤§ç›ˆåˆ©ï¼š</strong><span class="profit-badge {profit_class}">{profit_text}</span></p>
                                        <p><strong>è®¡ç®—çŠ¶æ€ï¼š</strong>{max_profit_status}</p>
                                        <p><strong>è¯´æ˜ï¼š</strong>åŸºäºç›®æ ‡æ—¥æœŸå60ä¸ªäº¤æ˜“æ—¥å†…å‰å¤æƒæœ€é«˜ä»·è®¡ç®—</p>
                                        <p><strong>é£é™©æç¤ºï¼š</strong>å†å²æ•°æ®ä¸ä»£è¡¨æœªæ¥è¡¨ç°</p>
                                    </div>

                                    <div class="analysis-card">
                                        <h3>ğŸ­ æƒ…ç»ªåˆ†æ</h3>
                                        <p><strong>ç»¼åˆæƒ…ç»ªï¼š</strong><span class="emotion-badge emotion-{analysis.get('emotion_analysis', {}).get('emotion_level', 'ä¸­æ€§').replace('æåº¦', '').replace('å', '').lower()}">{analysis.get('emotion_analysis', {}).get('emotion_level', 'ä¸­æ€§')}({analysis.get('emotion_analysis', {}).get('emotion_score', 50)}åˆ†)</span></p>
                                        <p><strong>RSIæƒ…ç»ªï¼š</strong>{analysis.get('emotion_analysis', {}).get('rsi_emotion', 'æœªçŸ¥')}</p>
                                        <p><strong>MACDæƒ…ç»ªï¼š</strong>{analysis.get('emotion_analysis', {}).get('macd_emotion', 'æœªçŸ¥')}</p>
                                        <p><strong>èµ„é‡‘æƒ…ç»ªï¼š</strong>{analysis.get('emotion_analysis', {}).get('obv_emotion', 'æœªçŸ¥')}</p>
                                    </div>

                                    <div class="analysis-card">
                                        <h3>ğŸ¯ äº¤æ˜“ç­–ç•¥</h3>
                                        <p><strong>æ“ä½œæ–¹å‘ï¼š</strong>{analysis['td_strategy']['direction']}</p>
                                        <p><strong>ä¿¡å¿ƒç­‰çº§ï¼š</strong>{analysis['td_strategy']['confidence']:.1f}%</p>
                                        <p><strong>å»ºè®®ä»“ä½ï¼š</strong>{analysis['td_strategy']['position_size']}</p>
                                        <p><strong>æ—¶é—´æ¡†æ¶ï¼š</strong>{analysis['td_strategy']['time_frame']}</p>
                                        <p><strong>é£é™©æ”¶ç›Šæ¯”ï¼š</strong>{analysis['td_strategy']['risk_reward']}</p>
                                    </div>

                                    <div class="analysis-card">
                                        <h3>ğŸ“ å…¥åœºç‚¹ä½</h3>
"""

        for level, price in analysis['td_strategy']['entry_points'].items():
            html_content += f"<p><strong>{level}ï¼š</strong>{price}</p>"

        html_content += f"""
                                    </div>

                                    <div class="analysis-card">
                                        <h3>ğŸ¯ ç›®æ ‡ä½è®¾ç½®</h3>
                                        <p><strong>æ­¢æŸä½ï¼š</strong>Â¥{analysis['td_strategy']['stop_loss']:.2f}</p>
"""

        for target in analysis['td_strategy']['targets']:
            html_content += f"<p>{target}</p>"

        html_content += """
                                    </div>
                                </div>
"""

        # å››ç»´ç»“æ„åˆ†æå±•ç¤º
        if analysis.get('four_dimensional_analysis'):
            four_dim = analysis['four_dimensional_analysis']
            structure_strength_class = 'structure-strong' if four_dim.get('structure_strength') in ['å¼º',
                                                                                                    'æå¼º'] else 'structure-medium' if four_dim.get(
                'structure_strength') == 'ä¸­ç­‰' else 'structure-weak'

            html_content += f"""
                                <div class="four-dimensional-section">
                                    <h3>ğŸ” å››ç»´ç»“æ„åˆ†ææ³•</h3>
                                    <div style="text-align: center; margin-bottom: 20px;">
                                        <span class="structure-badge {structure_strength_class}">
                                            {four_dim.get('structure_type', 'ç»“æ„æœªæ˜')} - {four_dim.get('structure_strength', 'æœªçŸ¥')}
                                        </span>
                                        <p style="margin-top: 10px;">ç»¼åˆè¯„åˆ†ï¼š{four_dim.get('comprehensive_score', 0):.1f}/100</p>
                                    </div>

                                    <div class="analysis-grid">
                                        <div class="dimension-card">
                                            <h4>â° æ—¶é—´ç»´åº¦</h4>
"""
            if 'time_dimension' in four_dim:
                time_dim = four_dim['time_dimension']
                html_content += f"""
                                            <p><strong>çŸ­æœŸè¶‹åŠ¿ï¼ˆ5æ—¥ï¼‰ï¼š</strong>{time_dim.get('short_trend', 'æœªçŸ¥')}</p>
                                            <p><strong>ä¸­æœŸè¶‹åŠ¿ï¼ˆ20æ—¥ï¼‰ï¼š</strong>{time_dim.get('medium_trend', 'æœªçŸ¥')}</p>
                                            <p><strong>é•¿æœŸè¶‹åŠ¿ï¼ˆ60æ—¥ï¼‰ï¼š</strong>{time_dim.get('long_trend', 'æœªçŸ¥')}</p>
                                            <p><strong>è¶‹åŠ¿ä¸€è‡´æ€§ï¼š</strong>{time_dim.get('trend_consistency', 0):.1f}%</p>
                                            <p><strong>å½“å‰ä½ç½®ï¼š</strong>{time_dim.get('current_position', 'æœªçŸ¥')}</p>
                                            <p><strong>åŠ¨èƒ½åˆ†æï¼š</strong>çŸ­æœŸ{time_dim.get('momentum_5d', 0):.1f}% | ä¸­æœŸ{time_dim.get('momentum_20d', 0):.1f}%</p>
"""
            html_content += """
                                        </div>

                                        <div class="dimension-card">
                                            <h4>ğŸ’° ä»·æ ¼ç»´åº¦</h4>
"""
            if 'price_dimension' in four_dim:
                price_dim = four_dim['price_dimension']
                html_content += f"""
                                            <p><strong>ä»·æ ¼ä½ç½®ï¼š</strong>{price_dim.get('current_position_pct', 50):.1f}%ï¼ˆåŒºé—´å†…ï¼‰</p>
                                            <p><strong>æ³¢åŠ¨ç‡ï¼š</strong>{price_dim.get('volatility', 0):.1f}%ï¼ˆå¹´åŒ–ï¼‰</p>
                                            <p><strong>ä»·æ ¼å½¢æ€ï¼š</strong>{price_dim.get('price_pattern', 'æœªè¯†åˆ«')}</p>
                                            <p><strong>æ”¯æ’‘çº§åˆ«ï¼š</strong>
"""
                for level in price_dim.get('key_support_levels', []):
                    html_content += f"<span class='level-indicator level-high'>{level:.2f}</span>"
                html_content += """</p>
                                            <p><strong>é˜»åŠ›çº§åˆ«ï¼š</strong>
"""
                for level in price_dim.get('key_resistance_levels', []):
                    html_content += f"<span class='level-indicator level-high'>{level:.2f}</span>"
            html_content += """</p>
                                        </div>

                                        <div class="dimension-card">
                                            <h4>ğŸ“Š æˆäº¤é‡ç»´åº¦</h4>
"""
            if 'volume_dimension' in four_dim:
                vol_dim = four_dim['volume_dimension']
                html_content += f"""
                                            <p><strong>é‡èƒ½è¶‹åŠ¿ï¼š</strong>{vol_dim.get('volume_trend', 'æœªçŸ¥')}</p>
                                            <p><strong>é‡æ¯”ï¼š</strong>{vol_dim.get('volume_ratio', 0):.2f}å€</p>
                                            <p><strong>ä»·é‡ç›¸å…³æ€§ï¼š</strong>{vol_dim.get('price_volume_correlation', 0):.2f}</p>
                                            <p><strong>é‡èƒ½å¼‚å¸¸ï¼š</strong>{vol_dim.get('volume_anomaly', 'æ­£å¸¸')}</p>
                                            <p><strong>æˆäº¤åˆ†å¸ƒï¼š</strong>{vol_dim.get('volume_distribution', 'æœªçŸ¥')}</p>
"""
            html_content += """
                                        </div>

                                        <div class="dimension-card">
                                            <h4>ğŸŒ ç©ºé—´ç»´åº¦</h4>
"""
            if 'space_dimension' in four_dim:
                space_dim = four_dim['space_dimension']
                html_content += f"""
                                            <p><strong>ç©ºé—´ä½ç½®ï¼š</strong>{space_dim.get('current_position_pct', 50):.1f}%</p>
                                            <p><strong>æ—¥å‡æ³¢å¹…ï¼š</strong>{space_dim.get('avg_daily_range', 0):.1f}%</p>
                                            <p><strong>æ”¯æ’‘å¼ºåº¦ï¼š</strong>{space_dim.get('support_strength', 0):.2f}</p>
                                            <p><strong>é˜»åŠ›å¼ºåº¦ï¼š</strong>{space_dim.get('resistance_strength', 0):.2f}</p>
                                            <p><strong>çªç ´æ¦‚ç‡ï¼š</strong>{space_dim.get('breakthrough_probability', 50):.1f}%</p>
"""
            html_content += """
                                        </div>
                                    </div>
                                </div>
"""

            # æƒ…ç»ªåˆ†æå±•ç¤º
            if analysis.get('emotion_analysis'):
                emotion = analysis['emotion_analysis']
                emotion_class = 'emotion-positive' if emotion.get('emotion_score',
                                                                  50) > 60 else 'emotion-negative' if emotion.get(
                    'emotion_score', 50) < 40 else 'emotion-neutral'

                html_content += f"""
                                            <div class="emotion-section">
                                                <h3>ğŸ­ ä¸“ä¸šæƒ…ç»ªåˆ†æ</h3>
                                                <div style="text-align: center; margin-bottom: 20px;">
                                                    <span class="emotion-badge {emotion_class}">
                                                        {emotion.get('emotion_level', 'ä¸­æ€§')} - {emotion.get('emotion_score', 50)}åˆ†
                                                    </span>
                                                </div>

                                                <div class="analysis-grid">
                                                    <div class="dimension-card">
                                                        <h4>ğŸ“Š æŠ€æœ¯æƒ…ç»ªæŒ‡æ ‡</h4>
                                                        <p><strong>RSIæƒ…ç»ªï¼š</strong>{emotion.get('rsi_emotion', 'æœªçŸ¥')}</p>
                                                        <p><strong>CCIæƒ…ç»ªï¼š</strong>{emotion.get('cci_emotion', 'æœªçŸ¥')}</p>
                                                        <p><strong>KDJæƒ…ç»ªï¼š</strong>{emotion.get('kdj_emotion', 'æœªçŸ¥')}</p>
                                                        <p><strong>MACDæƒ…ç»ªï¼š</strong>{emotion.get('macd_emotion', 'æœªçŸ¥')}</p>
                                                    </div>

                                                    <div class="dimension-card">
                                                        <h4>ğŸ’° èµ„é‡‘æƒ…ç»ªæŒ‡æ ‡</h4>
                                                        <p><strong>PSYå¿ƒç†ï¼š</strong>{emotion.get('psy_emotion', 'æœªçŸ¥')}</p>
                                                        <p><strong>VRæˆäº¤ï¼š</strong>{emotion.get('vr_emotion', 'æœªçŸ¥')}</p>
                                                        <p><strong>OBVèµ„é‡‘ï¼š</strong>{emotion.get('obv_emotion', 'æœªçŸ¥')}</p>
                                                        <p><strong>MFIæµé‡ï¼š</strong>{emotion.get('mfi_emotion', 'æœªçŸ¥')}</p>
                                                    </div>
                                                </div>

                                                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                                    <h4>ğŸ“‹ ä¸“ä¸šæƒ…ç»ªåˆ†ææŠ¥å‘Šï¼š</h4>
                                                    <div style="white-space: pre-line; line-height: 1.6;">
                                                        {emotion.get('emotion_analysis', 'æš‚æ— è¯¦ç»†åˆ†æ').replace(chr(10), '<br>')}
                                                    </div>
                                                </div>
                                            </div>
            """

        # é¡¶åº•ç»“æ„åˆ†æå±•ç¤º
        if analysis.get('top_bottom_analysis'):
            top_bottom = analysis['top_bottom_analysis']
            reliability_class = 'level-high' if top_bottom.get('structure_reliability',
                                                               0) > 70 else 'level-medium' if top_bottom.get(
                'structure_reliability', 0) > 50 else 'level-low'

            html_content += f"""
                                <div class="four-dimensional-section">
                                    <h3>ğŸ”ºğŸ”» é¡¶åº•ç»“æ„åˆ†æ</h3>
                                    <div style="text-align: center; margin-bottom: 20px;">
                                        <p><strong>å½“å‰ç»“æ„ï¼š</strong>{top_bottom.get('current_structure', 'ç»“æ„ä¸æ˜')}</p>
                                        <span class="level-indicator {reliability_class}">å¯é æ€§ï¼š{top_bottom.get('structure_reliability', 0):.1f}%</span>
                                        <span class="level-indicator level-medium">çªç ´æ¦‚ç‡ï¼š{top_bottom.get('breakout_probability', 50):.1f}%</span>
                                    </div>

                                    <div class="analysis-grid">
"""
            # é¡¶éƒ¨ç»“æ„
            if top_bottom.get('top_structures'):
                html_content += """
                                        <div class="dimension-card">
                                            <h4>ğŸ”» é¡¶éƒ¨ç»“æ„å½¢æ€</h4>
"""
                for structure in top_bottom['top_structures'][:3]:  # æ˜¾ç¤ºå‰3ä¸ª
                    reliability_badge = 'level-high' if structure.get(
                        'reliability') == 'high' else 'level-medium' if structure.get(
                        'reliability') == 'medium' else 'level-low'
                    html_content += f"""
                                            <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                                <p><strong>{structure.get('type', 'æœªçŸ¥å½¢æ€')}</strong> 
                                                   <span class="level-indicator {reliability_badge}">{structure.get('reliability', 'low')}</span></p>
                                                <p><strong>å‘¨æœŸï¼š</strong>{structure.get('period', 'æœªçŸ¥')}</p>
"""
                    if 'neckline' in structure:
                        html_content += f"<p><strong>é¢ˆçº¿ä½ï¼š</strong>{structure['neckline']:.2f}</p>"
                    if 'target_price' in structure:
                        html_content += f"<p><strong>ç›®æ ‡ä½ï¼š</strong>{structure['target_price']:.2f}</p>"
                    html_content += "</div>"
                html_content += "</div>"

            # åº•éƒ¨ç»“æ„
            if top_bottom.get('bottom_structures'):
                html_content += """
                                        <div class="dimension-card">
                                            <h4>ğŸ”º åº•éƒ¨ç»“æ„å½¢æ€</h4>
"""
                for structure in top_bottom['bottom_structures'][:3]:  # æ˜¾ç¤ºå‰3ä¸ª
                    reliability_badge = 'level-high' if structure.get(
                        'reliability') == 'high' else 'level-medium' if structure.get(
                        'reliability') == 'medium' else 'level-low'
                    html_content += f"""
                                            <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                                <p><strong>{structure.get('type', 'æœªçŸ¥å½¢æ€')}</strong> 
                                                   <span class="level-indicator {reliability_badge}">{structure.get('reliability', 'low')}</span></p>
                                                <p><strong>å‘¨æœŸï¼š</strong>{structure.get('period', 'æœªçŸ¥')}</p>
"""
                    if 'neckline' in structure:
                        html_content += f"<p><strong>é¢ˆçº¿ä½ï¼š</strong>{structure['neckline']:.2f}</p>"
                    if 'target_price' in structure:
                        html_content += f"<p><strong>ç›®æ ‡ä½ï¼š</strong>{structure['target_price']:.2f}</p>"
                    html_content += "</div>"
                html_content += "</div>"

            # å…³é”®ä»·ä½
            if top_bottom.get('key_levels'):
                html_content += """
                                        <div class="dimension-card">
                                            <h4>ğŸ¯ å…³é”®ç»“æ„ä»·ä½</h4>
"""
                for level in top_bottom['key_levels'][:6]:  # æ˜¾ç¤ºå‰6ä¸ª
                    level_class = 'level-high' if level.get('strength', 0) > 70 else 'level-medium' if level.get(
                        'strength', 0) > 50 else 'level-low'
                    html_content += f"""
                                            <p><span class="level-indicator {level_class}">{level.get('type', 'æœªçŸ¥')}</span> 
                                               {level.get('price', 0):.2f} ({level.get('source', 'æœªçŸ¥æ¥æº')})</p>
"""
                html_content += "</div>"

            html_content += """
                                    </div>

                                    <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                        <h4>ğŸ“‹ ç»“æ„åˆ†ææŠ¥å‘Šï¼š</h4>
                                        <div style="white-space: pre-line; line-height: 1.6;">
"""
            html_content += top_bottom.get('structure_analysis', 'æš‚æ— è¯¦ç»†åˆ†æ').replace('\n', '<br>')
            html_content += """
                                        </div>
                                    </div>
                                </div>
"""

        # ç‰¹æ®Šæç¤º
        if analysis['td_strategy']['notes']:
            html_content += """
                                <div style="margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; border-left: 4px solid rgba(255, 255, 255, 0.5);">
                                    <h4>ğŸ’¡ ç‰¹æ®Šæç¤ºï¼š</h4>
"""
            for note in analysis['td_strategy']['notes']:
                html_content += f"<p>â€¢ {note}</p>"
            html_content += "</div>"

        html_content += """
                            </div>
                        </td>
                    </tr>
"""

    html_content += """
                </tbody>
            </table>
        </div>
"""

    # æ·»åŠ å›åˆ°é¡¶éƒ¨æŒ‰é’®
    html_content += """
        <button id="backToTopBtn" class="back-to-top" onclick="scrollToTop()" title="å›åˆ°é¡¶éƒ¨">
            â¬†ï¸
        </button>
"""

    # ç»“å°¾
    html_content += f"""
        <div class="footer">
            <h3>ğŸ“Š å¢å¼ºç‰ˆTDåˆ†æè¯´æ˜ + ğŸ”—é›ªçƒè·³è½¬åŠŸèƒ½ + ğŸ’°60æ—¥æœ€å¤§ç›ˆåˆ©åŠŸèƒ½</h3>
            <div style="text-align: left; max-width: 1000px; margin: 0 auto;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div>
                        <h4>ğŸ”¢ TD Setup è¯´æ˜ï¼š</h4>
                        <p>â€¢ 1-3ï¼šåˆæœŸï¼Œè§‚å¯Ÿé˜¶æ®µ</p>
                        <p>â€¢ 4-6ï¼šä¸­æœŸï¼Œå…³æ³¨å‘å±•</p>
                        <p>â€¢ 7-8ï¼šåæœŸï¼Œå‡†å¤‡åè½¬</p>
                        <p>â€¢ 9ï¼šå®Œæˆï¼Œå¼ºçƒˆåè½¬ä¿¡å·</p>
                    </div>
                    <div>
                        <h4>â° TD Countdown è¯´æ˜ï¼š</h4>
                        <p>â€¢ 1-9ï¼šå€’è®¡æ—¶è¿›è¡Œä¸­</p>
                        <p>â€¢ 10-12ï¼šæ¥è¿‘å®Œæˆï¼Œé‡ç‚¹å…³æ³¨</p>
                        <p>â€¢ 13ï¼šå€’è®¡æ—¶å®Œæˆï¼Œåè½¬ç¡®è®¤</p>
                    </div>
                    <div>
                        <h4>âš¡ ä¿¡å·ç­‰çº§è¯´æ˜ï¼š</h4>
                        <p>â€¢ Sçº§ï¼šæå¼ºä¿¡å·ï¼ˆâ‰¥70åˆ†ï¼‰</p>
                        <p>â€¢ Açº§ï¼šå¼ºä¿¡å·ï¼ˆ50-69åˆ†ï¼‰</p>
                        <p>â€¢ Bçº§ï¼šä¸­ç­‰ä¿¡å·ï¼ˆ25-49åˆ†ï¼‰</p>
                        <p>â€¢ Cçº§ï¼šå¼±ä¿¡å·ï¼ˆ<25åˆ†ï¼‰</p>
                    </div>
                    <div>
                        <h4>ğŸ”— é›ªçƒè·³è½¬åŠŸèƒ½ï¼š</h4>
                        <p>â€¢ ç‚¹å‡»è‚¡ç¥¨ä»£ç æˆ–åç§°è·³è½¬é›ªçƒ</p>
                        <p>â€¢ è‡ªåŠ¨è¯†åˆ«æ·±äº¤æ‰€(.SZ)å’Œä¸Šäº¤æ‰€(.SH)</p>
                        <p>â€¢ æ–°çª—å£æ‰“å¼€ï¼Œä¸å½±å“å½“å‰é¡µé¢</p>
                        <p>â€¢ æ‚¬åœæ˜¾ç¤ºè·³è½¬æç¤ºå’Œé“¾æ¥å›¾æ ‡</p>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div>
                        <h4>ğŸ›ï¸ æ™ºèƒ½æ’åºè¯´æ˜ï¼š</h4>
                        <p>â€¢ ğŸ“ˆ ä¿¡å·ç­‰çº§ï¼šS>A>B>Cæ’åº</p>
                        <p>â€¢ ğŸ¯ åè½¬æ¦‚ç‡ï¼šæŒ‰æ¦‚ç‡é«˜ä½æ’åº</p>
                        <p>â€¢ ğŸ’° è‚¡ä»·ï¼šæŒ‰ä»·æ ¼é«˜ä½æ’åº</p>
                        <p>â€¢ ğŸ”¢ TD Setupï¼šæŒ‰Setupæ•°å€¼æ’åº</p>
                        <p>â€¢ â° Countdownï¼šæŒ‰å€’è®¡æ—¶æ’åº</p>
                        <p>â€¢ âš–ï¸ é£é™©ç­‰çº§ï¼šæŒ‰é£é™©é«˜ä½æ’åº</p>
                        <p>â€¢ ğŸ’° 60æ—¥æœ€å¤§ç›ˆåˆ©ï¼šæŒ‰ç›ˆåˆ©æ’åº</p>
                    </div>
                    <div>
                        <h4>ğŸ” å››ç»´ç»“æ„åˆ†æè¯´æ˜ï¼š</h4>
                        <p>â€¢ â° æ—¶é—´ç»´åº¦ï¼šå¤šå‘¨æœŸè¶‹åŠ¿ä¸€è‡´æ€§</p>
                        <p>â€¢ ğŸ’° ä»·æ ¼ç»´åº¦ï¼šå…³é”®ä»·ä½å’Œå½¢æ€</p>
                        <p>â€¢ ğŸ“Š æˆäº¤é‡ç»´åº¦ï¼šé‡ä»·é…åˆåº¦</p>
                        <p>â€¢ ğŸŒ ç©ºé—´ç»´åº¦ï¼šæ³¢åŠ¨ç©ºé—´åˆ†æ</p>
                    </div>
                    <div>
                        <h4>ğŸ”ºğŸ”» é¡¶åº•ç»“æ„åˆ†æè¯´æ˜ï¼š</h4>
                        <p>â€¢ åŒé¡¶/åŒåº•ï¼šç»å…¸åè½¬ç»“æ„</p>
                        <p>â€¢ ä¸‰é‡é¡¶/åº•ï¼šå¼ºåŠ›åè½¬ä¿¡å·</p>
                        <p>â€¢ å¤´è‚©é¡¶/åº•ï¼šå¯é åè½¬å½¢æ€</p>
                        <p>â€¢ æ¥”å½¢ï¼šæ”¶æ•›çªç ´å½¢æ€</p>
                    </div>
                    <div>
                        <h4>ğŸ†• æ–°åŠŸèƒ½ä½¿ç”¨è¯´æ˜ï¼š</h4>
                        <p>â€¢ ğŸ”— ç‚¹å‡»è‚¡ç¥¨åç§°/ä»£ç è·³è½¬é›ªçƒ</p>
                        <p>â€¢ ğŸ“Š è¯¦æƒ…é¡µé¢åŒ…å«Kçº¿å›¾è¡¨</p>
                        <p>â€¢ ğŸ›ï¸ 8ç§æ’åºæ–¹å¼å¿«é€Ÿç­›é€‰ï¼ˆæ–°å¢æ€»å¸‚å€¼æ’åºï¼‰</p>
                        <p>â€¢ ğŸ“± å®Œç¾æ”¯æŒç§»åŠ¨ç«¯è®¿é—®</p>
                    </div>
                    <div>
                        <h4>ğŸ­ æƒ…ç»ªåˆ†æåŠŸèƒ½ï¼š</h4>
                        <p>â€¢ ğŸ¯ ç»¼åˆ8å¤§æƒ…ç»ªæŒ‡æ ‡ï¼šRSIã€CCIã€KDJã€MACDã€PSYã€VRã€OBVã€MFI</p>
                        <p>â€¢ ğŸ“Š åŸºäºå‰å¤æƒæ•°æ®è®¡ç®—ï¼Œç¡®ä¿åˆ†æå‡†ç¡®æ€§</p>
                        <p>â€¢ ğŸ­ æƒ…ç»ªç­‰çº§ï¼šæåº¦æ‚²è§‚â†’æ‚²è§‚â†’åæ‚²è§‚â†’ä¸­æ€§â†’åä¹è§‚â†’ä¹è§‚â†’æåº¦ä¹è§‚</p>
                        <p>â€¢ ğŸ’¡ æä¾›ç§¯æä¿¡å·ã€é£é™©è­¦ç¤ºã€æœºä¼šæç¤º</p>
                    </div>
                </div>
                <div style="margin: 30px 0; padding: 20px; background: #e3f2fd; border-radius: 10px; border-left: 5px solid #2196f3;">
                    <h4>ğŸ’° 60æ—¥æœ€å¤§ç›ˆåˆ©åŠŸèƒ½è¯¦ç»†è¯´æ˜ï¼š</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <h5>ğŸ¯ è®¡ç®—æ–¹æ³•ï¼š</h5>
                            <p>ä»¥ç›®æ ‡æ—¥æœŸçš„å‰å¤æƒæ”¶ç›˜ä»·ä¸ºåŸºå‡†ï¼Œè®¡ç®—åç»­60ä¸ªäº¤æ˜“æ—¥å†…å‰å¤æƒæœ€é«˜ä»·çš„æœ€å¤§æ¶¨å¹…</p>
                        </div>
                        <div>
                            <h5>ğŸ“… æ—¶é—´èŒƒå›´ï¼š</h5>
                            <p>ç›®æ ‡æ—¥æœŸåçš„60ä¸ªäº¤æ˜“æ—¥ï¼ˆçº¦3ä¸ªæœˆï¼‰</p>
                        </div>
                        <div>
                            <h5>ğŸ”„ æ•°æ®ç±»å‹ï¼š</h5>
                            <p>å…¨ç¨‹ä½¿ç”¨å‰å¤æƒæ•°æ®ï¼Œæ¶ˆé™¤é™¤æƒé™¤æ¯å½±å“</p>
                        </div>
                        <div>
                            <h5>âš ï¸ é£é™©æç¤ºï¼š</h5>
                            <p>å†å²æ•°æ®ä¸ä»£è¡¨æœªæ¥è¡¨ç°ï¼Œä»…ä¾›å‚è€ƒåˆ†æ</p>
                        </div>
                    </div>
                    <p style="margin-top: 15px; text-align: center; font-weight: bold; color: #2196f3;">ğŸ’° ç¤ºä¾‹ï¼šè‹¥ç›®æ ‡æ—¥æœŸè‚¡ä»·10å…ƒï¼Œ60æ—¥å†…æœ€é«˜ä»·12å…ƒï¼Œåˆ™æœ€å¤§ç›ˆåˆ©ä¸º+20%</p>
                </div>
                <div style="margin: 30px 0; padding: 20px; background: #e8f5e8; border-radius: 10px; border-left: 5px solid #28a745;">
                    <h4>ğŸ”— é›ªçƒè·³è½¬åŠŸèƒ½è¯¦ç»†è¯´æ˜ï¼š</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <h5>ğŸ¯ ä½¿ç”¨æ–¹æ³•ï¼š</h5>
                            <p>ç‚¹å‡»ä»»ä½•ä½ç½®çš„è‚¡ç¥¨ä»£ç æˆ–è‚¡ç¥¨åç§°å³å¯è·³è½¬åˆ°é›ªçƒæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</p>
                        </div>
                        <div>
                            <h5>ğŸ”„ ä»£ç è½¬æ¢ï¼š</h5>
                            <p>è‡ªåŠ¨å°†"002413.SZ"è½¬æ¢ä¸ºé›ªçƒæ ¼å¼"SZ002413"</p>
                        </div>
                        <div>
                            <h5>ğŸŒ è·³è½¬èŒƒå›´ï¼š</h5>
                            <p>æ”¯æŒæ·±äº¤æ‰€(.SZ)ã€ä¸Šäº¤æ‰€(.SH)æ‰€æœ‰Aè‚¡è‚¡ç¥¨</p>
                        </div>
                        <div>
                            <h5>âœ¨ ç”¨æˆ·ä½“éªŒï¼š</h5>
                            <p>æ–°çª—å£æ‰“å¼€ã€æ‚¬åœæç¤ºã€æˆåŠŸé€šçŸ¥ã€é”™è¯¯å¤„ç†</p>
                        </div>
                    </div>
                    <p style="margin-top: 15px; text-align: center; font-weight: bold; color: #28a745;">ğŸ”— ç¤ºä¾‹ï¼šç‚¹å‡»"å¥‡ç§‘é˜²åŠ¡"æˆ–"002413.SZ"ä¼šè·³è½¬åˆ° https://xueqiu.com/S/SZ002413</p>
                </div>
                <p><strong>ğŸ¯ é£é™©ç­‰çº§ï¼š</strong>-5åˆ°-3é«˜çœ‹ç©ºï¼Œ-2åˆ°-1ä¸­ç­‰çœ‹ç©ºï¼Œ0ä¸­æ€§ï¼Œ+1åˆ°+2ä¸­ç­‰çœ‹å¤šï¼Œ+3åˆ°+5é«˜çœ‹å¤š</p>
                <br>
                <p style="color: #ff4757; font-weight: bold;">âš ï¸ é£é™©æç¤ºï¼šä»¥ä¸Šåˆ†æä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ã€‚</p>
                <p style="color: #2196f3; font-weight: bold;">ğŸ›ï¸ ä½¿ç”¨è¯´æ˜ï¼šç‚¹å‡»æ’åºæŒ‰é’®å¿«é€Ÿç­›é€‰ç›®æ ‡è‚¡ç¥¨ï¼Œç‚¹å‡»"æŸ¥çœ‹è¯¦æƒ…"åœ¨è‚¡ç¥¨è¡Œä¸‹æ–¹å±•å¼€å®Œæ•´åˆ†æã€‚</p>
                <p style="color: #4facfe; font-weight: bold;">ğŸ†• æ–°åŠŸèƒ½ï¼šä¼˜åŒ–è¯¦æƒ…å±•ç¤º+å››ç»´ç»“æ„åˆ†æ+é¡¶åº•ç»“æ„åˆ†æ+8ç§æ™ºèƒ½æ’åº+ğŸ’¼æ€»å¸‚å€¼ç­›é€‰æ’åº+Kçº¿å›¾è¡¨å¯è§†åŒ–+ğŸ”—é›ªçƒè·³è½¬åŠŸèƒ½+ğŸ’°60æ—¥æœ€å¤§ç›ˆåˆ©åˆ†æã€‚</p>
                <p style="color: #28a745; font-weight: bold;">ğŸ”— é›ªçƒè·³è½¬ï¼šç‚¹å‡»ä»»ä½•è‚¡ç¥¨ä»£ç æˆ–åç§°å¯ç›´æ¥è·³è½¬åˆ°é›ªçƒæŸ¥çœ‹æœ€æ–°èµ„è®¯ã€è´¢æŠ¥ã€è®¨è®ºç­‰è¯¦ç»†ä¿¡æ¯ã€‚</p>
                <p style="color: #ff6b6b; font-weight: bold;">ğŸ’° 60æ—¥æœ€å¤§ç›ˆåˆ©ï¼šåŸºäºå‰å¤æƒæ•°æ®è®¡ç®—ç›®æ ‡æ—¥æœŸå60ä¸ªäº¤æ˜“æ—¥å†…çš„æœ€å¤§æ¶¨å¹…ï¼Œå¸®åŠ©è¯„ä¼°çŸ­æœŸç›ˆåˆ©æ½œåŠ›ã€‚</p>
                <p style="color: #7c3aed; font-weight: bold;">ğŸ’¼ æ€»å¸‚å€¼åŠŸèƒ½ï¼šè‡ªåŠ¨è®¡ç®—å„è‚¡ç¥¨æ€»å¸‚å€¼ï¼Œæ”¯æŒæŒ‰å¸‚å€¼æ’åºå’Œç­›é€‰ï¼Œé¢œè‰²æ ‡è¯†ä¸åŒå¸‚å€¼è§„æ¨¡ï¼ˆç´«è‰²è¶…å¤§ç›˜ã€è“è‰²å¤§ç›˜ã€ç»¿è‰²ä¸­ç›˜ã€çº¢è‰²å°ç›˜ã€ç°è‰²å¾®ç›˜ï¼‰ã€‚</p>
            </div>
        </div>
    </div>
</body>
</html>
"""

    return html_content


def get_specified_stocks_data(stock_codes, target_date=None):
    """
    è·å–æŒ‡å®šè‚¡ç¥¨ä»£ç çš„æ•°æ®è¿›è¡Œåˆ†æ - æ›¿ä»£åŸé€‰è‚¡å‡½æ•°
    å‚æ•°:
    - stock_codes: è‚¡ç¥¨ä»£ç åˆ—è¡¨ï¼Œå¦‚ ['000001.SZ', '600000.SH']
    - target_date: ç›®æ ‡æ—¥æœŸï¼Œæ ¼å¼YYYYMMDD
    """
    if target_date is None:
        target_date = get_latest_trade_date()

    print(f"ç›®æ ‡æ—¥æœŸ: {target_date}")
    print(f"åˆ†æè‚¡ç¥¨ä»£ç : {stock_codes}")

    # éªŒè¯è‚¡ç¥¨ä»£ç æ ¼å¼
    valid_codes = []
    for code in stock_codes:
        if validate_stock_code(code):
            valid_codes.append(code)
        else:
            print(f"âš ï¸ è‚¡ç¥¨ä»£ç æ ¼å¼é”™è¯¯ï¼Œå·²è·³è¿‡: {code}")

    if not valid_codes:
        print("âŒ æ²¡æœ‰æœ‰æ•ˆçš„è‚¡ç¥¨ä»£ç ")
        return pd.DataFrame()

    print(f"âœ… æœ‰æ•ˆè‚¡ç¥¨ä»£ç : {valid_codes}")

    # è·å–è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
    print("\nç¬¬ä¸€æ­¥ï¼šè·å–è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯...")
    all_stock_info = []

    for code in valid_codes:
        try:
            with api_lock:
                stock_info = pro.stock_basic(ts_code=code, fields='ts_code,symbol,name,area,industry,list_date')
            if len(stock_info) > 0:
                all_stock_info.append(stock_info)
                print(f"âœ… {code}: {stock_info.iloc[0]['name']}")
            else:
                print(f"âš ï¸ æœªæ‰¾åˆ°è‚¡ç¥¨ä¿¡æ¯: {code}")
        except Exception as e:
            print(f"âŒ è·å– {code} åŸºæœ¬ä¿¡æ¯å¤±è´¥: {e}")

    if not all_stock_info:
        print("âŒ æœªè·å–åˆ°ä»»ä½•è‚¡ç¥¨çš„åŸºæœ¬ä¿¡æ¯")
        return pd.DataFrame()

    stock_list = pd.concat(all_stock_info, ignore_index=True)

    # ç¬¬äºŒæ­¥ï¼šè·å–ç›®æ ‡æ—¥çš„è¡Œæƒ…æ•°æ®
    print(f"\nç¬¬äºŒæ­¥ï¼šè·å–ç›®æ ‡æ—¥ {target_date} çš„è¡Œæƒ…æ•°æ®...")
    all_daily_data = []

    for code in valid_codes:
        try:
            # ä½¿ç”¨æ–°æ¥å£è·å–å‰å¤æƒæ•°æ®
            with api_lock:
                daily_data = pro.stk_factor_pro(**{
                    "ts_code": code,
                    "start_date": target_date,
                    "end_date": target_date,
                    "trade_date": "",
                    "limit": "",
                    "offset": ""
                }, fields=[
                    "ts_code", "trade_date", "close", "close_qfq", "pct_chg",
                    "vol", "amount", "turnover_rate", "total_mv"
                ])

            if len(daily_data) > 0:
                all_daily_data.append(daily_data)
                print(f"âœ… {code}: è·å–æ•°æ®æˆåŠŸ")
            else:
                print(f"âš ï¸ {code}: ç›®æ ‡æ—¥æœŸæ— äº¤æ˜“æ•°æ®")

        except Exception as e:
            print(f"âš ï¸ æ–°æ¥å£è·å– {code} æ•°æ®å¤±è´¥: {e}")
            # å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨åŸæ¥å£
            try:
                with api_lock:
                    daily_data = pro.daily(ts_code=code, trade_date=target_date)
                if len(daily_data) > 0:
                    # æ·»åŠ å‰å¤æƒå­—æ®µï¼ˆç®€åŒ–å¤„ç†ï¼‰
                    daily_data['close_qfq'] = daily_data['close']
                    all_daily_data.append(daily_data)
                    print(f"âœ… {code}: å¤‡ç”¨æ¥å£è·å–æˆåŠŸ")
                else:
                    print(f"âš ï¸ {code}: å¤‡ç”¨æ¥å£ä¹Ÿæ— æ•°æ®")
            except Exception as e2:
                print(f"âŒ {code}: æ‰€æœ‰æ¥å£éƒ½å¤±è´¥ - {e2}")

    if not all_daily_data:
        print("âŒ æ²¡æœ‰è·å–åˆ°ä»»ä½•è‚¡ç¥¨çš„è¡Œæƒ…æ•°æ®")
        return pd.DataFrame()

    # åˆå¹¶æ‰€æœ‰æ•°æ®
    daily_data = pd.concat(all_daily_data, ignore_index=True)
    print(f"âœ… æˆåŠŸè·å– {len(daily_data)} åªè‚¡ç¥¨çš„è¡Œæƒ…æ•°æ®")

    # åˆå¹¶è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯å’Œæ—¥çº¿æ•°æ®
    stock_data = pd.merge(stock_list, daily_data, on='ts_code', how='inner')

    # è¡¥å……è·å–å¸‚å€¼å’Œæ¢æ‰‹ç‡æ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if 'turnover_rate' not in stock_data.columns or 'total_mv' not in stock_data.columns:
        print("\nç¬¬ä¸‰æ­¥ï¼šè¡¥å……è·å–å¸‚å€¼å’Œæ¢æ‰‹ç‡æ•°æ®...")

        for code in valid_codes:
            try:
                with api_lock:
                    market_data = pro.daily_basic(ts_code=code,
                                                  trade_date=target_date,
                                                  fields='ts_code,turnover_rate,total_mv')
                if len(market_data) > 0:
                    # æ›´æ–°å¯¹åº”çš„è¡Œ
                    mask = stock_data['ts_code'] == code
                    if 'turnover_rate' not in stock_data.columns:
                        stock_data.loc[mask, 'turnover_rate'] = market_data.iloc[0]['turnover_rate']
                    if 'total_mv' not in stock_data.columns:
                        stock_data.loc[mask, 'total_mv'] = market_data.iloc[0]['total_mv']
            except Exception as e:
                print(f"âš ï¸ è·å– {code} å¸‚å€¼æ•°æ®å¤±è´¥: {e}")

    # ç¡®ä¿åŒ…å«å‰å¤æƒä»·æ ¼åˆ—
    if 'close_qfq' not in stock_data.columns:
        stock_data['close_qfq'] = stock_data['close']

    print(f"âœ… æ•°æ®æ•´ç†å®Œæˆï¼Œå…± {len(stock_data)} åªè‚¡ç¥¨")

    # æ˜¾ç¤ºè‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
    display_columns = ['ts_code', 'name', 'close', 'close_qfq', 'pct_chg', 'turnover_rate', 'total_mv', 'vol', 'amount']
    available_columns = [col for col in display_columns if col in stock_data.columns]

    return stock_data[available_columns]


def validate_stock_code(code):
    """
    éªŒè¯è‚¡ç¥¨ä»£ç æ ¼å¼
    æ”¯æŒæ ¼å¼ï¼š
    - 000001.SZï¼ˆæ·±äº¤æ‰€ï¼‰
    - 600000.SHï¼ˆä¸Šäº¤æ‰€ï¼‰
    - 000001ã€600000ï¼ˆè‡ªåŠ¨æ·»åŠ åç¼€ï¼‰
    """
    import re

    # å¦‚æœå·²ç»æœ‰åç¼€ï¼Œç›´æ¥éªŒè¯
    if '.' in code:
        pattern = r'^[0-9]{6}\.(SZ|SH)$'
        return bool(re.match(pattern, code.upper()))

    # å¦‚æœæ²¡æœ‰åç¼€ï¼Œæ£€æŸ¥æ˜¯å¦ä¸º6ä½æ•°å­—
    if re.match(r'^[0-9]{6}$', code):
        return True

    return False


def normalize_stock_codes(codes):
    """
    æ ‡å‡†åŒ–è‚¡ç¥¨ä»£ç ï¼Œè‡ªåŠ¨æ·»åŠ äº¤æ˜“æ‰€åç¼€
    """
    normalized = []
    for code in codes:
        code = code.strip().upper()

        if '.' in code:
            # å·²ç»æœ‰åç¼€
            normalized.append(code)
        else:
            # æ ¹æ®ä»£ç è§„åˆ™è‡ªåŠ¨æ·»åŠ åç¼€
            if code.startswith(('000', '002', '003', '300')):
                # æ·±äº¤æ‰€
                normalized.append(f"{code}.SZ")
            elif code.startswith(('600', '601', '603', '605', '688')):
                # ä¸Šäº¤æ‰€
                normalized.append(f"{code}.SH")
            else:
                # å…¶ä»–æƒ…å†µï¼Œé»˜è®¤æ·±äº¤æ‰€ï¼ˆç”¨æˆ·å¯ä»¥æ‰‹åŠ¨ä¿®æ­£ï¼‰
                print(f"âš ï¸ æ— æ³•è‡ªåŠ¨è¯†åˆ« {code} çš„äº¤æ˜“æ‰€ï¼Œé»˜è®¤ä¸ºæ·±äº¤æ‰€(.SZ)")
                normalized.append(f"{code}.SZ")

    return normalized


def format_output(df):
    """æ ¼å¼åŒ–è¾“å‡ºç»“æœï¼ˆå‰å¤æƒç‰ˆæœ¬ï¼‰"""
    if len(df) == 0:
        print("\næ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨")
        return

    print("\nç­›é€‰ç»“æœï¼ˆå‰å¤æƒæ•°æ®ï¼ŒæŒ‰å¸‚å€¼ä»ä½åˆ°é«˜æ’åºï¼‰ï¼š")
    print("=" * 140)

    # ç¡®å®šæ˜¾ç¤ºçš„ä»·æ ¼åˆ—
    price_col = 'close_qfq' if 'close_qfq' in df.columns else 'close'
    price_label = 'æ”¶ç›˜ä»·(å‰å¤æƒ)' if 'close_qfq' in df.columns else 'æ”¶ç›˜ä»·'

    print(f"{'åºå·':<5} {'è‚¡ç¥¨ä»£ç ':<12} {'è‚¡ç¥¨åç§°':<10} {price_label:<12} {'æ¶¨è·Œå¹…%':<8} "
          f"{'æ¢æ‰‹ç‡%':<8} {'æ€»å¸‚å€¼(äº¿)':<12} {'æˆäº¤é‡(ä¸‡æ‰‹)':<12} {'æˆäº¤é¢(ä¸‡å…ƒ)':<12}")
    print("-" * 140)

    for idx, (_, row) in enumerate(df.iterrows(), 1):
        total_mv_yi = row.get('total_mv', 0) / 10000
        vol_wan = row.get('vol', 0) / 10000 if pd.notna(row.get('vol', 0)) else 0
        amount_wan = row.get('amount', 0) / 10000 if pd.notna(row.get('amount', 0)) else 0
        turnover_rate = row.get('turnover_rate', 0) if pd.notna(row.get('turnover_rate', 0)) else 0
        pct_chg = row.get('pct_chg', 0) if pd.notna(row.get('pct_chg', 0)) else 0

        print(f"{idx:<5} {row['ts_code']:<12} {row['name']:<10} {row[price_col]:<12.2f} "
              f"{pct_chg:<8.2f} {turnover_rate:<8.2f} {total_mv_yi:<12.2f} "
              f"{vol_wan:<12.2f} {amount_wan:<12.2f}")

    print(f"\nå…±æ‰¾åˆ° {len(df)} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨")

    # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
    print("\nç»Ÿè®¡ä¿¡æ¯ï¼ˆåŸºäºå‰å¤æƒæ•°æ®ï¼‰ï¼š")
    print(f"å¹³å‡è‚¡ä»·: {df[price_col].mean():.2f}å…ƒ")
    if 'turnover_rate' in df.columns:
        print(f"å¹³å‡æ¢æ‰‹ç‡: {df['turnover_rate'].mean():.2f}%")
    if 'pct_chg' in df.columns:
        print(f"å¹³å‡æ¶¨è·Œå¹…: {df['pct_chg'].mean():.2f}%")
    if 'total_mv' in df.columns:
        print(f"æœ€å°å¸‚å€¼: {df['total_mv'].min() / 10000:.2f}äº¿å…ƒ")
        print(f"æœ€å¤§å¸‚å€¼: {df['total_mv'].max() / 10000:.2f}äº¿å…ƒ")
        print(f"å¹³å‡å¸‚å€¼: {df['total_mv'].mean() / 10000:.2f}äº¿å…ƒ")

    # æ¶¨è·Œåˆ†å¸ƒ
    if 'pct_chg' in df.columns:
        up_count = len(df[df['pct_chg'] > 0])
        down_count = len(df[df['pct_chg'] < 0])
        flat_count = len(df[df['pct_chg'] == 0])
        print(f"æ¶¨è·Œåˆ†å¸ƒ: ä¸Šæ¶¨{up_count}åª, ä¸‹è·Œ{down_count}åª, å¹³ç›˜{flat_count}åª")


def format_output_specified(df):
    """æ ¼å¼åŒ–è¾“å‡ºæŒ‡å®šè‚¡ç¥¨çš„ç»“æœ"""
    if len(df) == 0:
        print("\nâŒ æ²¡æœ‰è·å–åˆ°è‚¡ç¥¨æ•°æ®")
        return

    print("\nğŸ“Š æŒ‡å®šè‚¡ç¥¨æ•°æ®ï¼ˆå‰å¤æƒï¼‰ï¼š")
    print("=" * 140)

    # ç¡®å®šæ˜¾ç¤ºçš„ä»·æ ¼åˆ—
    price_col = 'close_qfq' if 'close_qfq' in df.columns else 'close'
    price_label = 'æ”¶ç›˜ä»·(å‰å¤æƒ)' if 'close_qfq' in df.columns else 'æ”¶ç›˜ä»·'

    print(f"{'åºå·':<5} {'è‚¡ç¥¨ä»£ç ':<12} {'è‚¡ç¥¨åç§°':<10} {price_label:<12} {'æ¶¨è·Œå¹…%':<8} "
          f"{'æ¢æ‰‹ç‡%':<8} {'æ€»å¸‚å€¼(äº¿)':<12} {'æˆäº¤é‡(ä¸‡æ‰‹)':<12} {'æˆäº¤é¢(ä¸‡å…ƒ)':<12}")
    print("-" * 140)

    for idx, (_, row) in enumerate(df.iterrows(), 1):
        total_mv_yi = row.get('total_mv', 0) / 10000 if pd.notna(row.get('total_mv', 0)) else 0
        vol_wan = row.get('vol', 0) / 10000 if pd.notna(row.get('vol', 0)) else 0
        amount_wan = row.get('amount', 0) / 10000 if pd.notna(row.get('amount', 0)) else 0
        turnover_rate = row.get('turnover_rate', 0) if pd.notna(row.get('turnover_rate', 0)) else 0
        pct_chg = row.get('pct_chg', 0) if pd.notna(row.get('pct_chg', 0)) else 0

        print(f"{idx:<5} {row['ts_code']:<12} {row['name']:<10} {row[price_col]:<12.2f} "
              f"{pct_chg:<8.2f} {turnover_rate:<8.2f} {total_mv_yi:<12.2f} "
              f"{vol_wan:<12.2f} {amount_wan:<12.2f}")

    print(f"\nâœ… å…±è·å– {len(df)} åªæŒ‡å®šè‚¡ç¥¨çš„æ•°æ®")

    # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
    print("\nğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯ï¼š")
    if len(df) > 1:
        print(f"å¹³å‡è‚¡ä»·: {df[price_col].mean():.2f}å…ƒ")
        if 'turnover_rate' in df.columns:
            print(f"å¹³å‡æ¢æ‰‹ç‡: {df['turnover_rate'].mean():.2f}%")
        if 'pct_chg' in df.columns:
            print(f"å¹³å‡æ¶¨è·Œå¹…: {df['pct_chg'].mean():.2f}%")
        if 'total_mv' in df.columns:
            print(f"æ€»å¸‚å€¼èŒƒå›´: {df['total_mv'].min() / 10000:.2f}äº¿ - {df['total_mv'].max() / 10000:.2f}äº¿")

    # æ¶¨è·Œåˆ†å¸ƒ
    if 'pct_chg' in df.columns:
        up_count = len(df[df['pct_chg'] > 0])
        down_count = len(df[df['pct_chg'] < 0])
        flat_count = len(df[df['pct_chg'] == 0])
        print(f"æ¶¨è·Œåˆ†å¸ƒ: ä¸Šæ¶¨{up_count}åª, ä¸‹è·Œ{down_count}åª, å¹³ç›˜{flat_count}åª")


def create_td_charts_for_specified_stocks(analyses, target_date):
    """ä¸ºæŒ‡å®šè‚¡ç¥¨åˆ›å»ºTDå›¾è¡¨"""
    # è®¾ç½®matplotlibåç«¯
    import matplotlib
    matplotlib.use('Agg')
    plt.ioff()

    # åˆ›å»ºå›¾è¡¨ä¿å­˜ç›®å½•
    chart_dir = f"æŒ‡å®šè‚¡ç¥¨td_charts_{target_date}_{datetime.now().strftime('%H%M%S')}"
    if not os.path.exists(chart_dir):
        os.makedirs(chart_dir)

    print(f"\nğŸ“Š å¼€å§‹ä¸ºæŒ‡å®šè‚¡ç¥¨ç”ŸæˆTDå›¾è¡¨...")

    chart_files = []

    for i, analysis in enumerate(analyses, 1):
        try:
            if 'analysis' in analysis and isinstance(analysis['analysis'], str):
                print(f"âš ï¸ {analysis.get('name', 'Unknown')}: {analysis['analysis']}")
                continue

            print(f"ğŸ“ˆ æ­£åœ¨ç»˜åˆ¶ {i}/{len(analyses)}: {analysis['name']}")

            # ä½¿ç”¨å·²æœ‰çš„å†å²æ•°æ®å’ŒTDæ•°æ®
            hist_data = analysis.get('hist_data')
            td_data = analysis.get('td_data')

            if hist_data is None or td_data is None:
                print(f"âš ï¸ {analysis['name']} ç¼ºå°‘å›¾è¡¨æ•°æ®ï¼Œè·³è¿‡...")
                continue

            # ç”Ÿæˆå®‰å…¨çš„å›¾è¡¨æ–‡ä»¶å
            safe_name = analysis['name'].replace('/', '_').replace('\\', '_').replace('*', '_').replace('?',
                                                                                                        '_').replace(
                ':', '_').replace('|', '_').replace('<', '_').replace('>', '_').replace('"', '_')
            chart_filename = f"{safe_name}_{analysis['code'].replace('.', '_')}_td_chart.png"
            chart_path = os.path.join(chart_dir, chart_filename)

            # ç»˜åˆ¶å›¾è¡¨
            try:
                saved_path = draw_td_chart(hist_data, td_data, analysis, chart_path)

                if saved_path:
                    chart_files.append({
                        'analysis': analysis,
                        'chart_path': saved_path,
                        'chart_filename': chart_filename,
                        'chart_dir': chart_dir
                    })

            except Exception as draw_error:
                print(f"âš ï¸ ç»˜åˆ¶ {analysis['name']} å›¾è¡¨å¤±è´¥: {draw_error}")
                continue

        except Exception as e:
            print(f"âŒ å¤„ç† {analysis.get('name', 'Unknown')} æ—¶å‡ºé”™: {e}")
            continue

    print(f"âœ… æˆåŠŸç”Ÿæˆ {len(chart_files)} ä¸ªTDå›¾è¡¨")
    return chart_files, chart_dir


def batch_analyze_specified_stocks(stock_codes, start_date, end_date):
    """æ‰¹é‡åˆ†ææŒ‡å®šè‚¡ç¥¨åœ¨æ—¥æœŸåŒºé—´å†…çš„è¡¨ç°"""
    print(f"\nğŸ” è·å– {start_date} åˆ° {end_date} æœŸé—´çš„äº¤æ˜“æ—¥...")

    # è®¾ç½®matplotlibåç«¯
    import matplotlib
    matplotlib.use('Agg')

    # è·å–äº¤æ˜“æ—¥åˆ—è¡¨
    trade_dates = get_trade_dates_in_range(start_date, end_date)

    if not trade_dates:
        print("âŒ æœªæ‰¾åˆ°äº¤æ˜“æ—¥æˆ–è·å–äº¤æ˜“æ—¥å†å¤±è´¥")
        input("æŒ‰å›è½¦é”®é€€å‡º...")
        return

    print(f"ğŸ“… æ‰¾åˆ° {len(trade_dates)} ä¸ªäº¤æ˜“æ—¥")
    print(f"ğŸ“Š å°†åˆ†æè‚¡ç¥¨: {', '.join(stock_codes)}")

    # ç¡®è®¤æ˜¯å¦ç»§ç»­
    estimated_time = len(trade_dates) * len(stock_codes) * 0.5  # ä¼°ç®—æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
    print(f"\nâš ï¸ æ‰¹é‡åˆ†æå°†å¤„ç† {len(trade_dates)} ä¸ªäº¤æ˜“æ—¥ Ã— {len(stock_codes)} åªè‚¡ç¥¨")
    print(f"é¢„è®¡è€—æ—¶ï¼š{estimated_time:.0f}-{estimated_time * 2:.0f} åˆ†é’Ÿ")
    confirm = input("æ˜¯å¦ç»§ç»­ï¼Ÿ(Y/N): ").strip().upper()

    if confirm != 'Y':
        print("å·²å–æ¶ˆæ‰¹é‡åˆ†æ")
        input("æŒ‰å›è½¦é”®é€€å‡º...")
        return

    print(f"\nğŸš€ å¼€å§‹æ‰¹é‡åˆ†æ...")
    print("=" * 80)

    successful_analyses = []
    failed_analyses = []
    html_files = []

    for i, target_date in enumerate(trade_dates, 1):
        print(f"\nğŸ“Š æ­£åœ¨åˆ†æç¬¬ {i}/{len(trade_dates)} ä¸ªäº¤æ˜“æ—¥ï¼š{target_date}")
        print(f"è¿›åº¦ï¼š{i / len(trade_dates) * 100:.1f}%")
        print("-" * 60)

        try:
            # è·å–æŒ‡å®šè‚¡ç¥¨æ•°æ®
            result = get_specified_stocks_data(stock_codes, target_date)

            if len(result) > 0:
                print(f"âœ… {target_date} è·å–æ•°æ®æˆåŠŸï¼Œ{len(result)} åªè‚¡ç¥¨æœ‰æ•°æ®")

                # ä¿å­˜CSV
                csv_filename = f"æŒ‡å®šè‚¡ç¥¨æ‰¹é‡åˆ†æ_{target_date}_{datetime.now().strftime('%H%M%S')}.csv"
                result.to_csv(csv_filename, index=False, encoding='utf-8-sig')

                # æ‰§è¡ŒTDåˆ†æ
                print(f"ğŸ”„ å¼€å§‹TDæŠ€æœ¯åˆ†æ...")
                max_workers = min(4, len(result))
                analyses = analyze_stocks_parallel(result, target_date, max_workers)

                # ç”Ÿæˆå›¾è¡¨
                chart_files = []
                chart_dir = None
                try:
                    chart_files, chart_dir = create_td_charts_for_specified_stocks(analyses, target_date)
                except Exception as chart_error:
                    print(f"âš ï¸ å›¾è¡¨ç”Ÿæˆå¤±è´¥: {chart_error}")

                # ç”ŸæˆHTMLæŠ¥å‘Š
                html_content = generate_html_report(analyses, target_date, chart_files)
                html_filename = f"æŒ‡å®šè‚¡ç¥¨æ‰¹é‡åˆ†ææŠ¥å‘Š_{target_date}_{datetime.now().strftime('%H%M%S')}.html"

                with open(html_filename, 'w', encoding='utf-8') as f:
                    f.write(html_content)

                print(f"ğŸ“Š HTMLæŠ¥å‘Šå·²ä¿å­˜: {html_filename}")

                successful_analyses.append({
                    'date': target_date,
                    'stock_count': len(result),
                    'csv_file': csv_filename,
                    'html_file': html_filename,
                    'chart_dir': chart_dir if chart_files else None,
                    'chart_count': len(chart_files) if chart_files else 0
                })

                html_files.append(html_filename)

            else:
                print(f"âš ï¸ {target_date} æŒ‡å®šè‚¡ç¥¨æ— äº¤æ˜“æ•°æ®")
                failed_analyses.append({
                    'date': target_date,
                    'reason': 'æŒ‡å®šè‚¡ç¥¨æ— äº¤æ˜“æ•°æ®'
                })

        except Exception as e:
            print(f"âŒ {target_date} åˆ†æå¤±è´¥: {e}")
            failed_analyses.append({
                'date': target_date,
                'reason': str(e)
            })

        # æ·»åŠ å»¶è¿Ÿ
        if i < len(trade_dates):
            time.sleep(2)

    # æ˜¾ç¤ºç»“æœæ±‡æ€»
    print("\n" + "=" * 80)
    print("ğŸ‰ æ‰¹é‡åˆ†æå®Œæˆï¼")
    print("=" * 80)

    print(f"\nğŸ“Š åˆ†ææ±‡æ€»ï¼š")
    print(f"æ€»äº¤æ˜“æ—¥æ•°ï¼š{len(trade_dates)}")
    print(f"æˆåŠŸåˆ†æï¼š{len(successful_analyses)} ä¸ª")
    print(f"å¤±è´¥åˆ†æï¼š{len(failed_analyses)} ä¸ª")
    print(f"æˆåŠŸç‡ï¼š{len(successful_analyses) / len(trade_dates) * 100:.1f}%")

    if successful_analyses:
        total_stocks = sum(analysis['stock_count'] for analysis in successful_analyses)
        total_charts = sum(analysis['chart_count'] for analysis in successful_analyses)

        print(f"\nğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯ï¼š")
        print(f"  æ€»æ•°æ®è®°å½•æ•°ï¼š{total_stocks} æ¡")
        print(f"  æ€»ç”Ÿæˆå›¾è¡¨æ•°ï¼š{total_charts} ä¸ª")

    # è¯¢é—®æ˜¯å¦æ‰“å¼€æŠ¥å‘Š
    if html_files:
        print(f"\nğŸŒ æ˜¯å¦ä¾æ¬¡æ‰“å¼€æ‰€æœ‰HTMLæŠ¥å‘Šï¼Ÿ({len(html_files)} ä¸ªæ–‡ä»¶)")
        open_reports = input("æ˜¯å¦æ‰“å¼€ï¼Ÿ(Y/N): ").strip().upper()

        if open_reports == 'Y':
            for i, html_file in enumerate(html_files, 1):
                try:
                    webbrowser.open(f'file://{os.path.abspath(html_file)}')
                    print(f"âœ… å·²æ‰“å¼€ç¬¬ {i}/{len(html_files)} ä¸ªæŠ¥å‘Š: {html_file}")
                    if i < len(html_files):
                        time.sleep(2)
                except Exception as e:
                    print(f"âŒ æ— æ³•æ‰“å¼€ {html_file}: {e}")

    print(f"\nâœ… æ‰¹é‡åˆ†æå…¨éƒ¨å®Œæˆï¼")
    input("æŒ‰å›è½¦é”®é€€å‡º...")

def get_trade_dates_in_range(start_date, end_date):
    """è·å–æ—¥æœŸåŒºé—´å†…çš„æ‰€æœ‰äº¤æ˜“æ—¥"""
    try:
        with api_lock:
            trade_cal = pro.trade_cal(exchange='SSE', start_date=start_date, end_date=end_date, is_open=1)
        trade_dates = trade_cal.sort_values('cal_date')['cal_date'].tolist()
        return trade_dates
    except Exception as e:
        print(f"è·å–äº¤æ˜“æ—¥å†å‡ºé”™: {e}")
        return []


def batch_analyze_dates(start_date, end_date):
    """æ‰¹é‡åˆ†ææ—¥æœŸåŒºé—´å†…çš„æ‰€æœ‰äº¤æ˜“æ—¥"""
    print(f"\nğŸ” è·å– {start_date} åˆ° {end_date} æœŸé—´çš„äº¤æ˜“æ—¥...")

    # è®¾ç½®matplotlibåç«¯
    import matplotlib
    matplotlib.use('Agg')

    # è·å–äº¤æ˜“æ—¥åˆ—è¡¨
    trade_dates = get_trade_dates_in_range(start_date, end_date)

    if not trade_dates:
        print("âŒ æœªæ‰¾åˆ°äº¤æ˜“æ—¥æˆ–è·å–äº¤æ˜“æ—¥å†å¤±è´¥")
        input("\næŒ‰å›è½¦é”®é€€å‡ºç¨‹åº...")
        return

    print(f"ğŸ“… æ‰¾åˆ° {len(trade_dates)} ä¸ªäº¤æ˜“æ—¥ï¼š")
    for i, date in enumerate(trade_dates, 1):
        print(f"  {i}. {date}")

    # ç¡®è®¤æ˜¯å¦ç»§ç»­
    print(
        f"\nâš ï¸ æ‰¹é‡åˆ†æå°†å¤„ç† {len(trade_dates)} ä¸ªäº¤æ˜“æ—¥ï¼Œé¢„è®¡è€—æ—¶ï¼š{len(trade_dates) * 3:.0f}-{len(trade_dates) * 8:.0f} åˆ†é’Ÿ")
    confirm = input("æ˜¯å¦ç»§ç»­ï¼Ÿ(Y/N): ").strip().upper()

    if confirm != 'Y':
        print("å·²å–æ¶ˆæ‰¹é‡åˆ†æ")
        input("\næŒ‰å›è½¦é”®é€€å‡ºç¨‹åº...")
        return

    print(f"\nğŸš€ å¼€å§‹æ‰¹é‡åˆ†æ...")
    print("=" * 80)

    successful_analyses = []
    failed_analyses = []
    html_files = []

    for i, target_date in enumerate(trade_dates, 1):
        print(f"\nğŸ“Š æ­£åœ¨åˆ†æç¬¬ {i}/{len(trade_dates)} ä¸ªäº¤æ˜“æ—¥ï¼š{target_date}")
        print(f"è¿›åº¦ï¼š{i / len(trade_dates) * 100:.1f}%")
        print("-" * 60)

        try:
            # æ‰§è¡Œå•æ—¥åˆ†æ
            result = stock_selector(target_date)

            if len(result) > 0:
                print(f"âœ… {target_date} ç­›é€‰å®Œæˆï¼Œæ‰¾åˆ° {len(result)} åªè‚¡ç¥¨")

                # ä¿å­˜CSV
                csv_filename = f"æ‰¹é‡TDç­›é€‰_{target_date}_{datetime.now().strftime('%H%M%S')}.csv"
                result.to_csv(csv_filename, index=False, encoding='utf-8-sig')
                print(f"ğŸ“„ CSVå·²ä¿å­˜: {csv_filename}")

                # æ‰§è¡ŒTDåˆ†æ
                print(f"ğŸ”„ å¼€å§‹TDæŠ€æœ¯åˆ†æ...")
                max_workers = min(4, len(result))
                analyses = analyze_stocks_parallel(result, target_date, max_workers)

                # ç”Ÿæˆå›¾è¡¨ - æ·»åŠ å¼‚å¸¸å¤„ç†
                chart_files = []
                chart_dir = None
                try:
                    print(f"ğŸ“ˆ å¼€å§‹ç”Ÿæˆå›¾è¡¨...")
                    chart_files, chart_dir = create_td_charts_for_focus_stocks(analyses, target_date)
                    print(f"âœ… å›¾è¡¨ç”Ÿæˆå®Œæˆ: {len(chart_files)} ä¸ª")
                except Exception as chart_error:
                    print(f"âš ï¸ å›¾è¡¨ç”Ÿæˆå¤±è´¥: {chart_error}")
                    print("ç»§ç»­ç”ŸæˆHTMLæŠ¥å‘Š...")

                # ç”ŸæˆHTMLæŠ¥å‘Š
                html_content = generate_html_report(analyses, target_date, chart_files)
                html_filename = f"æ‰¹é‡TDåˆ†ææŠ¥å‘Š_{target_date}_{datetime.now().strftime('%H%M%S')}.html"

                with open(html_filename, 'w', encoding='utf-8') as f:
                    f.write(html_content)

                print(f"ğŸ“Š HTMLæŠ¥å‘Šå·²ä¿å­˜: {html_filename}")

                successful_analyses.append({
                    'date': target_date,
                    'stock_count': len(result),
                    'csv_file': csv_filename,
                    'html_file': html_filename,
                    'chart_dir': chart_dir if chart_files else None,
                    'chart_count': len(chart_files) if chart_files else 0
                })

                html_files.append(html_filename)

            else:
                print(f"âš ï¸ {target_date} æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨")
                failed_analyses.append({
                    'date': target_date,
                    'reason': 'æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨'
                })

        except Exception as e:
            print(f"âŒ {target_date} åˆ†æå¤±è´¥: {e}")
            failed_analyses.append({
                'date': target_date,
                'reason': str(e)
            })

        # æ·»åŠ å»¶è¿Ÿé¿å…APIé™åˆ¶
        if i < len(trade_dates):
            print("â³ ç­‰å¾…3ç§’åç»§ç»­ä¸‹ä¸€ä¸ªäº¤æ˜“æ—¥...")
            time.sleep(3)

    # æ˜¾ç¤ºæ‰¹é‡åˆ†æç»“æœæ±‡æ€»
    print("\n" + "=" * 80)
    print("ğŸ‰ æ‰¹é‡åˆ†æå®Œæˆï¼")
    print("=" * 80)

    print(f"\nğŸ“Š åˆ†ææ±‡æ€»ï¼š")
    print(f"æ€»äº¤æ˜“æ—¥æ•°ï¼š{len(trade_dates)}")
    print(f"æˆåŠŸåˆ†æï¼š{len(successful_analyses)} ä¸ª")
    print(f"å¤±è´¥åˆ†æï¼š{len(failed_analyses)} ä¸ª")
    print(f"æˆåŠŸç‡ï¼š{len(successful_analyses) / len(trade_dates) * 100:.1f}%")

    if successful_analyses:
        print(f"\nâœ… æˆåŠŸåˆ†æçš„äº¤æ˜“æ—¥ï¼š")
        total_stocks = 0
        total_charts = 0

        for analysis in successful_analyses:
            print(f"  ğŸ“… {analysis['date']}: {analysis['stock_count']} åªè‚¡ç¥¨, {analysis['chart_count']} ä¸ªå›¾è¡¨")
            total_stocks += analysis['stock_count']
            total_charts += analysis['chart_count']

        print(f"\nğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯ï¼š")
        print(f"  æ€»ç­›é€‰è‚¡ç¥¨æ•°ï¼š{total_stocks} åª")
        print(f"  æ€»ç”Ÿæˆå›¾è¡¨æ•°ï¼š{total_charts} ä¸ª")
        print(f"  å¹³å‡æ¯æ—¥è‚¡ç¥¨æ•°ï¼š{total_stocks / len(successful_analyses):.1f} åª")

        print(f"\nğŸ“ ç”Ÿæˆçš„æ–‡ä»¶ï¼š")
        for analysis in successful_analyses:
            print(f"  ğŸ“Š {analysis['html_file']}")
            print(f"  ğŸ“„ {analysis['csv_file']}")
            if analysis['chart_dir']:
                print(f"  ğŸ“ˆ å›¾è¡¨ç›®å½•: {analysis['chart_dir']}")
            print()

    if failed_analyses:
        print(f"\nâŒ å¤±è´¥åˆ†æçš„äº¤æ˜“æ—¥ï¼š")
        for analysis in failed_analyses:
            print(f"  ğŸ“… {analysis['date']}: {analysis['reason']}")

    # è¯¢é—®æ˜¯å¦ä¾æ¬¡æ‰“å¼€HTMLæŠ¥å‘Š
    if html_files:
        print(f"\nğŸŒ æ˜¯å¦ä¾æ¬¡æ‰“å¼€æ‰€æœ‰HTMLæŠ¥å‘Šï¼Ÿ({len(html_files)} ä¸ªæ–‡ä»¶)")
        print("æ³¨æ„ï¼šè¿™å°†æ‰“å¼€å¤šä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µ")
        open_reports = input("æ˜¯å¦æ‰“å¼€ï¼Ÿ(Y/N): ").strip().upper()

        if open_reports == 'Y':
            print(f"\nğŸŒ æ­£åœ¨ä¾æ¬¡æ‰“å¼€HTMLæŠ¥å‘Š...")

            for i, html_file in enumerate(html_files, 1):
                try:
                    webbrowser.open(f'file://{os.path.abspath(html_file)}')
                    print(f"âœ… å·²æ‰“å¼€ç¬¬ {i}/{len(html_files)} ä¸ªæŠ¥å‘Š: {html_file}")

                    # æ·»åŠ å»¶è¿Ÿé¿å…æµè§ˆå™¨å¡é¡¿
                    if i < len(html_files):
                        time.sleep(2)

                except Exception as e:
                    print(f"âŒ æ— æ³•æ‰“å¼€ {html_file}: {e}")

            print(f"\nğŸ‰ å·²å°è¯•æ‰“å¼€æ‰€æœ‰ {len(html_files)} ä¸ªHTMLæŠ¥å‘Šï¼")
        else:
            print(f"\nğŸ“ HTMLæŠ¥å‘Šæ–‡ä»¶åˆ—è¡¨ï¼š")
            for html_file in html_files:
                print(f"  ğŸ“Š {os.path.abspath(html_file)}")

    # ç”Ÿæˆæ‰¹é‡åˆ†ææ±‡æ€»æŠ¥å‘Š
    if successful_analyses:
        print(f"\nğŸ“‹ æ­£åœ¨ç”Ÿæˆæ‰¹é‡åˆ†ææ±‡æ€»æŠ¥å‘Š...")
        summary_html = generate_batch_summary_report(successful_analyses, failed_analyses, start_date, end_date)
        summary_filename = f"æ‰¹é‡åˆ†ææ±‡æ€»æŠ¥å‘Š_{start_date}åˆ°{end_date}_{datetime.now().strftime('%H%M%S')}.html"

        with open(summary_filename, 'w', encoding='utf-8') as f:
            f.write(summary_html)

        print(f"ğŸ“‹ æ±‡æ€»æŠ¥å‘Šå·²ä¿å­˜: {summary_filename}")

        # æ‰“å¼€æ±‡æ€»æŠ¥å‘Š
        try:
            webbrowser.open(f'file://{os.path.abspath(summary_filename)}')
            print(f"ğŸŒ å·²è‡ªåŠ¨æ‰“å¼€æ±‡æ€»æŠ¥å‘Š")
        except:
            print(f"âŒ æ— æ³•è‡ªåŠ¨æ‰“å¼€æ±‡æ€»æŠ¥å‘Šï¼Œè¯·æ‰‹åŠ¨æ‰“å¼€ï¼š{summary_filename}")

    print(f"\nâœ… æ‰¹é‡åˆ†æå…¨éƒ¨å®Œæˆï¼")
    input("\næŒ‰å›è½¦é”®é€€å‡ºç¨‹åº...")


def generate_batch_summary_report(successful_analyses, failed_analyses, start_date, end_date):
    """ç”Ÿæˆæ‰¹é‡åˆ†ææ±‡æ€»æŠ¥å‘Š"""
    total_dates = len(successful_analyses) + len(failed_analyses)
    success_rate = len(successful_analyses) / total_dates * 100 if total_dates > 0 else 0
    total_stocks = sum(analysis['stock_count'] for analysis in successful_analyses)
    total_charts = sum(analysis['chart_count'] for analysis in successful_analyses)

    html_content = f"""
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡TDåˆ†ææ±‡æ€»æŠ¥å‘Š - {start_date}åˆ°{end_date}</title>
    <style>
        body {{
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }}
        .container {{
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }}
        .header {{
            text-align: center;
            margin-bottom: 40px;
        }}
        .header h1 {{
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }}
        .stats-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }}
        .stat-card {{
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }}
        .stat-number {{
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }}
        .stat-label {{
            font-size: 1rem;
            opacity: 0.9;
        }}
        .analysis-table {{
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }}
        .table-header {{
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }}
        table {{
            width: 100%;
            border-collapse: collapse;
        }}
        th, td {{
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }}
        th {{
            background: #f8f9fa;
            font-weight: 600;
        }}
        .success-row {{
            background: #f8fff8;
        }}
        .failed-row {{
            background: #fff8f8;
        }}
        .file-link {{
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
        }}
        .file-link:hover {{
            text-decoration: underline;
        }}
        .summary-section {{
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ æ‰¹é‡TDåˆ†ææ±‡æ€»æŠ¥å‘Š</h1>
            <p>åˆ†ææœŸé—´ï¼š{start_date} - {end_date} | ç”Ÿæˆæ—¶é—´ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{total_dates}</div>
                <div class="stat-label">æ€»äº¤æ˜“æ—¥æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{len(successful_analyses)}</div>
                <div class="stat-label">æˆåŠŸåˆ†æ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{success_rate:.1f}%</div>
                <div class="stat-label">æˆåŠŸç‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{total_stocks}</div>
                <div class="stat-label">æ€»ç­›é€‰è‚¡ç¥¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{total_charts}</div>
                <div class="stat-label">æ€»ç”Ÿæˆå›¾è¡¨</div>
            </div>
        </div>

        <div class="analysis-table">
            <div class="table-header">ğŸ“Š è¯¦ç»†åˆ†æç»“æœ</div>
            <table>
                <thead>
                    <tr>
                        <th>äº¤æ˜“æ—¥æœŸ</th>
                        <th>çŠ¶æ€</th>
                        <th>ç­›é€‰è‚¡ç¥¨æ•°</th>
                        <th>ç”Ÿæˆå›¾è¡¨æ•°</th>
                        <th>HTMLæŠ¥å‘Š</th>
                        <th>CSVæ•°æ®</th>
                        <th>å›¾è¡¨ç›®å½•</th>
                    </tr>
                </thead>
                <tbody>
"""

    # æ·»åŠ æˆåŠŸåˆ†æçš„è¡Œ
    for analysis in successful_analyses:
        html_content += f"""
                    <tr class="success-row">
                        <td><strong>{analysis['date']}</strong></td>
                        <td><span style="color: green;">âœ… æˆåŠŸ</span></td>
                        <td>{analysis['stock_count']} åª</td>
                        <td>{analysis['chart_count']} ä¸ª</td>
                        <td><a href="{analysis['html_file']}" class="file-link" target="_blank">ğŸ“Š æŸ¥çœ‹æŠ¥å‘Š</a></td>
                        <td><a href="{analysis['csv_file']}" class="file-link">ğŸ“„ ä¸‹è½½CSV</a></td>
                        <td>{'ğŸ“ˆ ' + analysis['chart_dir'] if analysis['chart_dir'] else 'æ— å›¾è¡¨'}</td>
                    </tr>
"""

    # æ·»åŠ å¤±è´¥åˆ†æçš„è¡Œ
    for analysis in failed_analyses:
        html_content += f"""
                    <tr class="failed-row">
                        <td><strong>{analysis['date']}</strong></td>
                        <td><span style="color: red;">âŒ å¤±è´¥</span></td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>{analysis['reason']}</td>
                    </tr>
"""

    html_content += f"""
                </tbody>
            </table>
        </div>

        <div class="summary-section">
            <h3>ğŸ“ˆ ç»Ÿè®¡æ‘˜è¦</h3>
            <p><strong>åˆ†æå‘¨æœŸï¼š</strong>{start_date} - {end_date}</p>
            <p><strong>å¹³å‡æ¯æ—¥ç­›é€‰è‚¡ç¥¨æ•°ï¼š</strong>{total_stocks / len(successful_analyses):.1f} åª</p>
            <p><strong>å¹³å‡æ¯æ—¥ç”Ÿæˆå›¾è¡¨æ•°ï¼š</strong>{total_charts / len(successful_analyses):.1f} ä¸ª</p>
            <p><strong>æ•°æ®è´¨é‡ï¼š</strong>ä½¿ç”¨å‰å¤æƒæ•°æ®ï¼ŒåŒ…å«60æ—¥æœ€å¤§ç›ˆåˆ©åˆ†æ</p>
            <p><strong>æŠ€æœ¯æŒ‡æ ‡ï¼š</strong>TDåºåˆ—ã€å››ç»´ç»“æ„åˆ†æã€é¡¶åº•ç»“æ„åˆ†æ</p>
        </div>

        <div class="summary-section">
            <h3>âš ï¸ ä½¿ç”¨è¯´æ˜</h3>
            <p>â€¢ ç‚¹å‡»"ğŸ“Š æŸ¥çœ‹æŠ¥å‘Š"å¯æ‰“å¼€å¯¹åº”æ—¥æœŸçš„è¯¦ç»†åˆ†ææŠ¥å‘Š</p>
            <p>â€¢ ç‚¹å‡»"ğŸ“„ ä¸‹è½½CSV"å¯ä¸‹è½½åŸå§‹ç­›é€‰æ•°æ®</p>
            <p>â€¢ å›¾è¡¨ç›®å½•åŒ…å«è¯¥æ—¥æœŸé‡ç‚¹å…³æ³¨è‚¡ç¥¨çš„Kçº¿æŠ€æœ¯å›¾è¡¨</p>
            <p>â€¢ å»ºè®®é‡ç‚¹å…³æ³¨è¿ç»­å¤šæ—¥å‡ºç°çš„å¼ºåŠ¿è‚¡ç¥¨</p>
            <p>â€¢ æ‰€æœ‰åˆ†æåŸºäºå†å²æ•°æ®ï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®</p>
        </div>
    </div>
</body>
</html>
"""

    return html_content


# ä¸»ç¨‹åº
if __name__ == "__main__":
    # è¿‡æ»¤matplotlibå’Œtkinterç›¸å…³è­¦å‘Š
    import warnings

    warnings.filterwarnings('ignore', category=UserWarning, module='matplotlib')
    warnings.filterwarnings('ignore', category=RuntimeWarning, module='matplotlib')
    warnings.filterwarnings('ignore', message='.*main thread is not in main loop.*')

    try:
        print("=" * 80)
        print("å¢å¼ºç‰ˆTDè‚¡ç¥¨åˆ†æç³»ç»Ÿ - æŒ‡å®šè‚¡ç¥¨ä»£ç åˆ†æç‰ˆæœ¬")
        print("=" * 80)
        print("\nğŸ†• åŠŸèƒ½è¯´æ˜ï¼š")
        print("âœ… è¾“å…¥æŒ‡å®šè‚¡ç¥¨ä»£ç è¿›è¡Œä¸“ä¸šTDæŠ€æœ¯åˆ†æ")
        print("âœ… æ”¯æŒå¤šä¸ªè‚¡ç¥¨ä»£ç åŒæ—¶åˆ†æ")
        print("âœ… å…¨é¢å‰å¤æƒæ•°æ®å¤„ç†")
        print("âœ… å››ç»´ç»“æ„åˆ†æ + é¡¶åº•ç»“æ„åˆ†æ")
        print("âœ… ä¸“ä¸šæƒ…ç»ªåˆ†æï¼ˆ8å¤§æŒ‡æ ‡ï¼‰")
        print("âœ… 60æ—¥æœ€å¤§ç›ˆåˆ©è®¡ç®—")
        print("âœ… æ™ºèƒ½æ’åº + Kçº¿å›¾è¡¨ + é›ªçƒè·³è½¬")
        print("=" * 80)

        print("\nğŸ“Š æ”¯æŒçš„åˆ†æåŠŸèƒ½ï¼š")
        print("1. ğŸ”¢ TDåºåˆ—åˆ†æï¼ˆSetup + Countdown + Comboï¼‰")
        print("2. ğŸ¯ å››ç»´ç»“æ„åˆ†æï¼ˆæ—¶é—´ã€ä»·æ ¼ã€æˆäº¤é‡ã€ç©ºé—´ï¼‰")
        print("3. ğŸ”º é¡¶åº•ç»“æ„è¯†åˆ«ï¼ˆåŒé¡¶åŒåº•ã€å¤´è‚©å½¢æ€ç­‰ï¼‰")
        print("4. ğŸ­ ä¸“ä¸šæƒ…ç»ªåˆ†æï¼ˆRSIã€MACDã€KDJç­‰8å¤§æŒ‡æ ‡ï¼‰")
        print("5. ğŸ’° 60æ—¥æœ€å¤§ç›ˆåˆ©è®¡ç®—ï¼ˆåŸºäºå‰å¤æƒæ•°æ®ï¼‰")
        print("6. ğŸ“ˆ ä¸“ä¸šKçº¿å›¾è¡¨ç”Ÿæˆ")
        print("7. ğŸ”— ä¸€é”®è·³è½¬é›ªçƒæŸ¥çœ‹è¯¦æƒ…")
        print("=" * 80)

        print("\nè¯·é€‰æ‹©åˆ†ææ¨¡å¼ï¼š")
        print("1. å•æ—¥åˆ†æ - åˆ†ææŒ‡å®šè‚¡ç¥¨åœ¨æŒ‡å®šæ—¥æœŸçš„è¡¨ç°")
        print("2. æ‰¹é‡æ—¥æœŸåˆ†æ - åˆ†ææŒ‡å®šè‚¡ç¥¨åœ¨æ—¥æœŸåŒºé—´å†…çš„è¡¨ç°")

        mode_input = input("\nè¯·é€‰æ‹©æ¨¡å¼(1/2ï¼Œç›´æ¥æŒ‰å›è½¦é»˜è®¤é€‰æ‹©1): ").strip()

        if mode_input == "2":
            # æ‰¹é‡æ—¥æœŸåˆ†ææ¨¡å¼
            print("\n=== æ‰¹é‡æ—¥æœŸåˆ†ææ¨¡å¼ ===")
            print("å°†åˆ†ææŒ‡å®šè‚¡ç¥¨åœ¨æ—¥æœŸåŒºé—´å†…æ‰€æœ‰äº¤æ˜“æ—¥çš„è¡¨ç°")

            # è¾“å…¥è‚¡ç¥¨ä»£ç 
            print("\nè¯·è¾“å…¥è‚¡ç¥¨ä»£ç ï¼š")
            print("æ”¯æŒæ ¼å¼ï¼š")
            print("- å¸¦åç¼€ï¼š000001.SZ, 600000.SH")
            print("- ä¸å¸¦åç¼€ï¼š000001, 600000 (ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«äº¤æ˜“æ‰€)")
            print("- å¤šä¸ªä»£ç ç”¨é€—å·åˆ†éš”ï¼š000001,600000,000002")

            stock_input = input("\nè¯·è¾“å…¥è‚¡ç¥¨ä»£ç : ").strip()

            if not stock_input:
                print("\nâŒ è‚¡ç¥¨ä»£ç ä¸èƒ½ä¸ºç©ºï¼")
                input("æŒ‰å›è½¦é”®é€€å‡º...")
                exit(1)

            # è§£æè‚¡ç¥¨ä»£ç 
            input_codes = [code.strip() for code in stock_input.split(',') if code.strip()]
            stock_codes = normalize_stock_codes(input_codes)

            if not stock_codes:
                print("\nâŒ æ²¡æœ‰æœ‰æ•ˆçš„è‚¡ç¥¨ä»£ç ï¼")
                input("æŒ‰å›è½¦é”®é€€å‡º...")
                exit(1)

            print(f"\nâœ… å°†åˆ†æä»¥ä¸‹è‚¡ç¥¨: {', '.join(stock_codes)}")

            # è¾“å…¥æ—¥æœŸåŒºé—´
            start_date_input = input("\nè¯·è¾“å…¥å¼€å§‹æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYYMMDDï¼Œä¾‹å¦‚ï¼š20250101ï¼‰: ").strip()
            end_date_input = input("è¯·è¾“å…¥ç»“æŸæ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYYMMDDï¼Œä¾‹å¦‚ï¼š20250710ï¼‰: ").strip()

            # éªŒè¯æ—¥æœŸæ ¼å¼
            if not start_date_input or not end_date_input:
                print("\nâŒ æ—¥æœŸä¸èƒ½ä¸ºç©ºï¼")
                input("æŒ‰å›è½¦é”®é€€å‡º...")
                exit(1)

            if len(start_date_input) != 8 or not start_date_input.isdigit() or len(
                    end_date_input) != 8 or not end_date_input.isdigit():
                print("\nâŒ æ—¥æœŸæ ¼å¼é”™è¯¯ï¼è¯·ä½¿ç”¨YYYYMMDDæ ¼å¼")
                input("æŒ‰å›è½¦é”®é€€å‡º...")
                exit(1)

            # æ£€æŸ¥æ—¥æœŸæ˜¯å¦åˆç†
            try:
                start_date_obj = pd.to_datetime(start_date_input)
                end_date_obj = pd.to_datetime(end_date_input)

                if start_date_obj > end_date_obj:
                    print("\nâŒ å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸï¼")
                    input("æŒ‰å›è½¦é”®é€€å‡º...")
                    exit(1)

                if end_date_obj > pd.Timestamp.now():
                    print("\nâŒ ä¸èƒ½é€‰æ‹©æœªæ¥çš„æ—¥æœŸï¼")
                    input("æŒ‰å›è½¦é”®é€€å‡º...")
                    exit(1)
            except:
                print("\nâŒ æ—¥æœŸæ ¼å¼é”™è¯¯ï¼")
                input("æŒ‰å›è½¦é”®é€€å‡º...")
                exit(1)

            # æ‰§è¡Œæ‰¹é‡æ—¥æœŸåˆ†æ
            batch_analyze_specified_stocks(stock_codes, start_date_input, end_date_input)

        else:
            # å•æ—¥åˆ†ææ¨¡å¼
            print("\n=== å•æ—¥åˆ†ææ¨¡å¼ ===")

            # è¾“å…¥è‚¡ç¥¨ä»£ç 
            print("\nè¯·è¾“å…¥è¦åˆ†æçš„è‚¡ç¥¨ä»£ç ï¼š")
            print("æ”¯æŒæ ¼å¼ï¼š")
            print("- å¸¦åç¼€ï¼š000001.SZ, 600000.SH")
            print("- ä¸å¸¦åç¼€ï¼š000001, 600000 (ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«äº¤æ˜“æ‰€)")
            print("- å¤šä¸ªä»£ç ç”¨é€—å·åˆ†éš”ï¼š000001,600000,000002")
            print("- ç¤ºä¾‹ï¼šå¥‡ç§‘é˜²åŠ¡(002413), æµ¦å‘é“¶è¡Œ(600000), ä¸‡ç§‘A(000002)")

            stock_input = input("\nè¯·è¾“å…¥è‚¡ç¥¨ä»£ç : ").strip()

            if not stock_input:
                print("\nâŒ è‚¡ç¥¨ä»£ç ä¸èƒ½ä¸ºç©ºï¼")
                input("æŒ‰å›è½¦é”®é€€å‡º...")
                exit(1)

            # è§£æè‚¡ç¥¨ä»£ç 
            input_codes = [code.strip() for code in stock_input.split(',') if code.strip()]
            stock_codes = normalize_stock_codes(input_codes)

            if not stock_codes:
                print("\nâŒ æ²¡æœ‰æœ‰æ•ˆçš„è‚¡ç¥¨ä»£ç ï¼")
                input("æŒ‰å›è½¦é”®é€€å‡º...")
                exit(1)

            print(f"\nâœ… å°†åˆ†æä»¥ä¸‹è‚¡ç¥¨: {', '.join(stock_codes)}")

            # è¾“å…¥ç›®æ ‡æ—¥æœŸ
            print("\nè¯·è¾“å…¥ç›®æ ‡åˆ†ææ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYYMMDDï¼‰")
            print("ä¾‹å¦‚ï¼š20240115")
            print("ç›´æ¥æŒ‰å›è½¦ä½¿ç”¨æœ€è¿‘äº¤æ˜“æ—¥")

            target_date_input = input("\nè¯·è¾“å…¥æ—¥æœŸ: ").strip()

            # éªŒè¯æ—¥æœŸæ ¼å¼ï¼ˆå¦‚æœè¾“å…¥äº†æ—¥æœŸï¼‰
            if target_date_input:
                # æ£€æŸ¥æ—¥æœŸæ ¼å¼æ˜¯å¦æ­£ç¡®
                if len(target_date_input) != 8 or not target_date_input.isdigit():
                    print("\nâŒ æ—¥æœŸæ ¼å¼é”™è¯¯ï¼è¯·ä½¿ç”¨YYYYMMDDæ ¼å¼")
                    input("æŒ‰å›è½¦é”®é€€å‡º...")
                    exit(1)

                # æ£€æŸ¥æ—¥æœŸæ˜¯å¦åˆç†
                try:
                    date_obj = pd.to_datetime(target_date_input)
                    if date_obj > pd.Timestamp.now():
                        print("\nâŒ ä¸èƒ½é€‰æ‹©æœªæ¥çš„æ—¥æœŸï¼")
                        input("æŒ‰å›è½¦é”®é€€å‡º...")
                        exit(1)
                    if date_obj < pd.Timestamp('2010-01-01'):
                        print("\nâŒ æ—¥æœŸå¤ªæ—©ï¼Œè¯·é€‰æ‹©2010å¹´ä»¥åçš„æ—¥æœŸï¼")
                        input("æŒ‰å›è½¦é”®é€€å‡º...")
                        exit(1)
                except:
                    print("\nâŒ æ—¥æœŸæ ¼å¼é”™è¯¯ï¼")
                    input("æŒ‰å›è½¦é”®é€€å‡º...")
                    exit(1)

                # æ£€æŸ¥æ˜¯å¦ä¸ºäº¤æ˜“æ—¥
                print(f"\nğŸ” æ£€æŸ¥æ—¥æœŸ {target_date_input} æ˜¯å¦ä¸ºäº¤æ˜“æ—¥...")
                if not check_trade_date(target_date_input):
                    print(f"\nâš ï¸ {target_date_input} ä¸æ˜¯äº¤æ˜“æ—¥ï¼")
                    latest_date = get_latest_trade_date()
                    print(f"æœ€è¿‘çš„äº¤æ˜“æ—¥æ˜¯: {latest_date}")
                    use_latest = input("\næ˜¯å¦ä½¿ç”¨æœ€è¿‘çš„äº¤æ˜“æ—¥ï¼Ÿ(Y/N): ").strip().upper()
                    if use_latest == 'Y':
                        target_date_input = latest_date
                    else:
                        input("æŒ‰å›è½¦é”®é€€å‡º...")
                        exit(0)

                print(f"\nâœ… ç›®æ ‡åˆ†ææ—¥æœŸ: {target_date_input}")
                result = get_specified_stocks_data(stock_codes, target_date_input)
                selected_date = target_date_input
            else:
                print("\nğŸ” ä½¿ç”¨æœ€è¿‘äº¤æ˜“æ—¥è¿›è¡Œåˆ†æ...")
                result = get_specified_stocks_data(stock_codes)
                selected_date = get_latest_trade_date()

            # æ ¼å¼åŒ–è¾“å‡ºç»“æœ
            format_output_specified(result)

            # ä¿å­˜åŸºç¡€ç»“æœåˆ°CSVæ–‡ä»¶
            if len(result) > 0:
                filename = f"æŒ‡å®šè‚¡ç¥¨TDåˆ†æ_{selected_date}_{datetime.now().strftime('%H%M%S')}.csv"
                result.to_csv(filename, index=False, encoding='utf-8-sig')
                print(f"\nğŸ“„ åŸºç¡€æ•°æ®å·²ä¿å­˜åˆ°: {filename}")

                # æ‰§è¡Œå¢å¼ºç‰ˆTDæŠ€æœ¯åˆ†æ
                print(f"\nğŸ”„ å¼€å§‹è¿›è¡Œå¢å¼ºç‰ˆTDæŠ€æœ¯åˆ†æ...")
                print("ğŸ†• åŒ…å«å››ç»´ç»“æ„åˆ†æã€é¡¶åº•ç»“æ„åˆ†æã€æƒ…ç»ªåˆ†æå’Œ60æ—¥æœ€å¤§ç›ˆåˆ©è®¡ç®—...")
                print("ğŸš€ ä½¿ç”¨å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†...")

                # ä½¿ç”¨å¹¶è¡Œåˆ†æ
                max_workers = min(4, len(result))
                print(f"ğŸ“Š ä½¿ç”¨ {max_workers} ä¸ªçº¿ç¨‹å¹¶è¡Œåˆ†æ {len(result)} åªè‚¡ç¥¨...")

                analyses = analyze_stocks_parallel(result, selected_date, max_workers)

                print(f"\nâœ… TDåˆ†æå®Œæˆï¼å…±åˆ†æ {len(analyses)} åªè‚¡ç¥¨")

                # ç”ŸæˆTDå›¾è¡¨
                print("\nğŸ“Š å¼€å§‹ç”ŸæˆTDæŠ€æœ¯å›¾è¡¨...")
                chart_files, chart_dir = create_td_charts_for_specified_stocks(analyses, selected_date)

                # ç”ŸæˆHTMLå¯è§†åŒ–æŠ¥å‘Š
                print("\nğŸ¨ ç”Ÿæˆå¢å¼ºç‰ˆHTMLæŠ¥å‘Š...")
                html_content = generate_html_report(analyses, selected_date, chart_files)

                # ä¿å­˜HTMLæŠ¥å‘Š
                html_filename = f"æŒ‡å®šè‚¡ç¥¨TDåˆ†ææŠ¥å‘Š_{selected_date}_{datetime.now().strftime('%H%M%S')}.html"
                with open(html_filename, 'w', encoding='utf-8') as f:
                    f.write(html_content)

                print(f"ğŸ“Š å¢å¼ºç‰ˆHTMLæŠ¥å‘Šå·²ä¿å­˜: {html_filename}")

                if chart_files:
                    print(f"ğŸ“ˆ TDå›¾è¡¨æ–‡ä»¶å¤¹: {chart_dir}")
                    print(f"ğŸ¯ æˆåŠŸç”Ÿæˆ {len(chart_files)} ä¸ªTDæŠ€æœ¯å›¾è¡¨")

                # è‡ªåŠ¨æ‰“å¼€HTMLæŠ¥å‘Š
                try:
                    webbrowser.open(f'file://{os.path.abspath(html_filename)}')
                    print(f"\nğŸŒ å·²è‡ªåŠ¨æ‰“å¼€HTMLæŠ¥å‘Šï¼š{html_filename}")
                    print("ğŸ” åŸºäºå‰å¤æƒæ•°æ®çš„ä¸“ä¸šæŠ€æœ¯åˆ†æ")
                    print("ğŸ“Š åŒ…å«TDåºåˆ—ã€å››ç»´ç»“æ„ã€æƒ…ç»ªåˆ†æã€60æ—¥æœ€å¤§ç›ˆåˆ©ç­‰")
                    print("ğŸ”— æ”¯æŒä¸€é”®è·³è½¬é›ªçƒæŸ¥çœ‹è¯¦æƒ…")
                except:
                    print(f"\nâŒ æ— æ³•è‡ªåŠ¨æ‰“å¼€HTMLæŠ¥å‘Šï¼Œè¯·æ‰‹åŠ¨æ‰“å¼€ï¼š{html_filename}")

                # æ˜¾ç¤ºåˆ†ææ±‡æ€»
                print(f"\nğŸ¯ åˆ†ææ±‡æ€»ï¼š")
                print("=" * 80)
                for stock in analyses:
                    if 'analysis' in stock and isinstance(stock['analysis'], str):
                        print(f"âŒ {stock['name']} ({stock['code']}): {stock['analysis']}")
                    else:
                        max_profit_pct = stock.get('max_profit_pct', 0)
                        max_profit_days = stock.get('max_profit_days', 0)
                        profit_info = f"60æ—¥æœ€å¤§ç›ˆåˆ©: +{max_profit_pct}%({max_profit_days}å¤©)" if max_profit_pct > 0 else "60æ—¥æœ€å¤§ç›ˆåˆ©: æ— ç›ˆåˆ©"

                        print(f"ğŸ“ˆ {stock['name']} ({stock['code']}) - è¯„åˆ†: {stock.get('td_score', 0)}åˆ†")
                        print(
                            f"   å‰å¤æƒä»·æ ¼: Â¥{stock['current_price']:.2f} | Setup: {stock['td_setup']} | Countdown: {stock['td_countdown']}")
                        print(f"   ä¿¡å·: {stock['td_signal_grade']} | æ“ä½œ: {stock['td_strategy']['direction']}")
                        print(f"   ğŸ’° {profit_info}")
                        print("-" * 80)

                print(f"\nğŸ”¥ é‡è¦æé†’ï¼š")
                print("âœ… å…¨ç¨‹ä½¿ç”¨å‰å¤æƒæ•°æ®ï¼ŒæŠ€æœ¯æŒ‡æ ‡æ›´ç²¾ç¡®")
                print("âœ… åŒ…å«ä¸“ä¸šçš„å››ç»´ç»“æ„åˆ†æå’Œæƒ…ç»ªåˆ†æ")
                print("ğŸ’° 60æ—¥æœ€å¤§ç›ˆåˆ©ä¸ºå†å²æ•°æ®ï¼Œä»…ä¾›å‚è€ƒ")
                print("ğŸ”— å¯é€šè¿‡HTMLæŠ¥å‘Šä¸€é”®è·³è½¬é›ªçƒæŸ¥çœ‹è¯¦æƒ…")

            else:
                print("\nâŒ æœªè·å–åˆ°æœ‰æ•ˆçš„è‚¡ç¥¨æ•°æ®ï¼Œè¯·æ£€æŸ¥ï¼š")
                print("1. è‚¡ç¥¨ä»£ç æ˜¯å¦æ­£ç¡®")
                print("2. ç›®æ ‡æ—¥æœŸæ˜¯å¦ä¸ºäº¤æ˜“æ—¥")
                print("3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸")

        # ç­‰å¾…ç”¨æˆ·æŒ‰é”®é€€å‡º
        input("\nâœ… åˆ†æå®Œæˆï¼æŒ‰å›è½¦é”®é€€å‡ºç¨‹åº...")

    except Exception as e:
        print(f"\nâŒ æ‰§è¡Œå‡ºé”™: {e}")
        print("\nè¯·æ£€æŸ¥ï¼š")
        print("1. è‚¡ç¥¨ä»£ç æ ¼å¼æ˜¯å¦æ­£ç¡®")
        print("2. è¾“å…¥çš„æ—¥æœŸæ˜¯å¦ä¸ºå†å²äº¤æ˜“æ—¥")
        print("3. tushareç­‰ä¾èµ–åŒ…æ˜¯å¦å·²å®‰è£…")
        print("4. TOKENæ˜¯å¦æœ‰æ•ˆ")
        print("5. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸")
        input("\næŒ‰å›è½¦é”®é€€å‡ºç¨‹åº...")
